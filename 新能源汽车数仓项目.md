# æ–°èƒ½æºæ±½è½¦æ•°ä»“é¡¹ç›®

å®éªŒç›®çš„ï¼šæ”¶é›†æ±½è½¦ä¼ æ„Ÿå™¨çš„æ•°æ®ï¼Œç”±æ­¤åˆ†æå‡ºæ±½è½¦æ˜¯å¦å‡ºç°äº†é—®é¢˜ã€‚



## ä¸€.é¡¹ç›®éœ€æ±‚

- ä¸šåŠ¡æ•°æ®é‡‡é›†å¹³å°çš„æ­å»º
- æ•°æ®ä»“åº“ç»´åº¦å»ºæ¨¡
- åˆ†ææŠ€æœ¯æ ¸å¿ƒæ•°æ®ï¼Œç»Ÿè®¡æŠ¥è¡¨
- åŠæ—¶æŸ¥è¯¢ï¼Œéšæ—¶æŒ‡æ ‡åˆ†æ
- å¯¹é›†ç¾¤æ€§èƒ½è¿›è¡Œç›‘æ§ï¼Œå‘ç”Ÿå¼‚å¸¸éœ€è¦æŠ¥è­¦
- å…ƒæ•°æ®ç®¡ç†
- è´¨é‡ç›‘æ§
- æƒé™ç®¡ç†





## äºŒ.æ¨¡æ¿è™šæ‹Ÿæœºçš„æ­å»º

 **å®‰è£…æ¨¡æ¿è™šæ‹Ÿæœºï¼ŒIPåœ°å€ 192.168.10.100ã€ä¸»æœºåç§°hadoop100ã€å†…å­˜ 4Gã€ç¡¬ç›˜ 50G**

å‚è€ƒåšå®¢ï¼š

https://blog.csdn.net/qq_43774324/article/details/125014162



- å®‰è£… epel-release

```
[root@hadoop100 ~]# yum install -y epel-release
```



**å¦‚æœLinux å®‰è£…çš„æ˜¯æœ€å°ç³»ç»Ÿç‰ˆï¼Œè¿˜éœ€è¦å®‰è£…å¦‚ä¸‹å·¥å…·ï¼›å¦‚æœå®‰è£…çš„æ˜¯ Linuxæ¡Œé¢æ ‡å‡†ç‰ˆï¼Œä¸éœ€è¦æ‰§è¡Œå¦‚ä¸‹æ“ä½œ**

```
[root@hadoop100 ~]# yum install -y net-tools 
[root@hadoop100 ~]# yum install -y vim
```



- **å…³é—­é˜²ç«å¢™ï¼Œå…³é—­é˜²ç«å¢™å¼€æœºè‡ªå¯**

```
[root@hadoop100 ~]# systemctl stop firewalld
[root@hadoop100 ~]# systemctl disable firewalld.service
```



- **åˆ›å»º  ç”¨æˆ·ï¼Œå¹¶ä¿®æ”¹ atguigu ç”¨æˆ·çš„å¯†ç **ï¼ˆå¯é€‰ï¼‰

```
[root@hadoop100 ~]# useradd XXX
[root@hadoop100 ~]# passwd XXX
```

å½“ç„¶åå­—è‡ªå–ï¼Œæˆ‘è¿™é‡Œå–çš„æ˜¯lchen



- **é…ç½®**ç”¨æˆ·å…·æœ‰rootæƒé™ï¼Œæ–¹ä¾¿åæœŸåŠ  **sudo** **æ‰§è¡Œ** **root** **æƒé™çš„å‘½ä»¤**

  é¦–å…ˆè¿›å…¥ç®¡ç†å‘˜æƒé™ï¼š su root   å¯†ç ï¼š123456

  åœ¨%wheel è¿™è¡Œä¸‹é¢æ·»åŠ ä¸€è¡Œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
[root@hadoop100 ~]# vim /etc/sudoers
```

```
## Allow root to run any commands anywhere
root ALL=(ALL) ALL
## Allows people in group wheel to run all commands
%wheel ALL=(ALL) ALL
atguigu ALL=(ALL) NOPASSWD:ALL
```

ç°åœ¨ç”¨æˆ·å°±æœ‰ç®¡ç†å‘˜æƒé™äº†ã€‚

é€€å‡ºä¿å­˜ï¼šwq!



- **åœ¨/opt ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹**

```
[root@hadoop100 ~]# mkdir /opt/module
[root@hadoop100 ~]# mkdir /opt/software
```



- **å¸è½½è™šæ‹Ÿæœºè‡ªå¸¦çš„ JDK**

```
[root@hadoop100 ~]# rpm -qa | grep -i java | xargs -n1 rpm -e --nodeps
```

rpm -qaï¼šæŸ¥è¯¢æ‰€å®‰è£…çš„æ‰€æœ‰rpm è½¯ä»¶åŒ…

grep -iï¼šå¿½ç•¥å¤§å°å†™

xargs -n1ï¼šè¡¨ç¤ºæ¯æ¬¡åªä¼ é€’ä¸€ä¸ªå‚æ•°

rpm -e â€“nodepsï¼šå¼ºåˆ¶å¸è½½è½¯ä»¶

æŸ¥çœ‹æ˜¯å¦è¿˜æœ‰JDKï¼š

```
 rpm -qa | grep java
```



- é‡å¯è™šæ‹Ÿæœº

```
reboot   
```







## ä¸‰.ç¯å¢ƒå‡†å¤‡

### ï¼ˆ1ï¼‰æœºå™¨å‡†å¤‡

#### 1.å…‹éš†ä¸‰å°æ¨¡æ‹Ÿæœº

å³å‡»æ¨¡æ¿æœºï¼ˆä¿è¯è™šæ‹Ÿæœºå…³é—­ï¼‰â€”â€”ç®¡ç†â€”â€”å…‹éš†ï¼Œåœ¨è¿™ä¸€æ­¥é€‰æ‹©â€œå®Œæ•´å…‹éš†â€ã€‚å…¶ä»–å…¨éƒ¨ç‚¹å‡»â€œä¸‹ä¸€æ­¥â€ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230714201010766.png" alt="image-20230714201010766" style="zoom: 33%;" />

ä»¥æ­¤ç±»æ¨ï¼Œå¤åˆ¶ä¸‰å°ã€‚





#### 2.ä¿®æ”¹ä¸»æœºåã€3å°éƒ½æ˜¯ä¸€æ ·çš„æ“ä½œã€‘

ä¾æ¬¡å¯åŠ¨102ï¼Œ103ï¼Œ104æœºå™¨ï¼Œæ³¨æ„æ˜¯â€”â€”ä¸€ä¸ªä¸€ä¸ªè®¾ç½®ã€‚ï¼ˆä¸èƒ½åŒæ—¶å¼€å¯ï¼‰

é¦–å…ˆåˆ‡æ¢rootç”¨æˆ·ï¼šsu root

ä¿®æ”¹ä¸»æœºåï¼šï¼ˆä¿®æ”¹å®Œ:wqé€€å‡ºå³å¯ï¼‰

```
vim /etc/hostname
```

é…ç½®Linux å…‹éš†æœºä¸»æœºåç§°æ˜ å°„ hosts æ–‡ä»¶ï¼š

```
[root@hadoop100 ~]# vim /etc/hosts
```

æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```
192.168.10.100 hadoop100
192.168.10.101 hadoop101
192.168.10.102 hadoop102
192.168.10.103 hadoop103
192.168.10.104 hadoop104
192.168.10.105 hadoop105
192.168.10.106 hadoop106
192.168.10.107 hadoop107
192.168.10.108 hadoop108
```

å…¶ä¸­ï¼š192.168.10.100ï¼ˆç¬¬ä¸€åˆ—æ˜¯ç½‘å¡é…ç½®ï¼‰**[æˆ‘ä»¬ä¹Ÿç”¨è¿™ä¸ªè¿æ¥finalshell]**ï¼Œå¦‚å›¾ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230714202344043.png" alt="image-20230714202344043" style="zoom:33%;" />

æœ€åä¿®æ”¹é™æ€IPï¼š

```
[root@hadoop100 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33
```

åŠ ä¸ŠIPå’Œç½‘å…³ï¼š

```
IPADDR=192.168.10.102           #æ”¹ä¸ºæœ¬æœºç½‘æ®µhadoop2æ˜¯102  3æ˜¯103
GATEWAY=192.168.10.2
DNS1=192.168.10.2
```

é‡å¯å³å¯:

```
[root@hadoop100 ~]# reboot
```





#### 3.é›†ç¾¤å‘å¸ƒè„šæœ¬xsyncå’Œå…å¯†ç™»é™†é…ç½®

scpå®‰å…¨æ‹·è´çš„è¯­æ³•ï¼š

```
scp -r $pdir/$fname $user@$host:$pdir/$fname

å‘½ä»¤ é€’å½’ è¦æ‹·è´çš„æ–‡ä»¶è·¯å¾„/åç§° ç›®çš„åœ°ç”¨æˆ·@ä¸»æœº:ç›®çš„åœ°è·¯å¾„/åç§°
```



æŠŠè„šæœ¬å®‰æ’åœ¨ï¼š/home/lchen/binä¸‹çš„xsyncæ–‡ä»¶ä¸­            ã€binç›®å½•å’Œæ–‡ä»¶è‡ªå·±å»ºã€‘

è„šæœ¬ï¼š

```
#!/bin/bash
#1. åˆ¤æ–­å‚æ•°ä¸ªæ•°
if [ $# -lt 1 ]
then
 echo Not Enough Arguement!
 exit;
fi
#2. éå†é›†ç¾¤æ‰€æœ‰æœºå™¨
for host in hadoop102 hadoop103 hadoop104
do
 echo ==================== $host ====================
 #3. éå†æ‰€æœ‰ç›®å½•ï¼ŒæŒ¨ä¸ªå‘é€
 for file in $@
 do
 #4. åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
 if [ -e $file ]
 then
 #5. è·å–çˆ¶ç›®å½•
 pdir=$(cd -P $(dirname $file); pwd)
 #6. è·å–å½“å‰æ–‡ä»¶çš„åç§°
 fname=$(basename $file)
 ssh $host "mkdir -p $pdir"
 rsync -av $pdir/$fname $host:$pdir
 else
 echo $file does not exists!
 fi
 done
done
```

æ·»åŠ å‘½ä»¤ï¼Œèµ‹äºˆè„šæœ¬æƒé™ï¼š

```
[atguigu@hadoop102 bin]$ chmod +x xsync          
```

```
[atguigu@hadoop102 bin]$ sudo cp xsync /bin/   å¤åˆ¶è„šæœ¬åˆ°binä¸­æ–¹ä¾¿å…¨å±€è°ƒç”¨
```

è®©ç¯å¢ƒå˜é‡ç”Ÿæ•ˆï¼šï¼ˆè¿™ä¸€æ­¥ä¸‰å°æœºå™¨éƒ½è¦è¿›è¡Œï¼Œå½“ç„¶è¦åœ¨xyncä¼ è¾“åˆ°å…¶ä»–2å°æœºå™¨ä¹‹åï¼‰

```
[atguigu@hadoop103 bin]$ source /etc/profile
[atguigu@hadoop104 opt]$ source /etc/profile
```



åˆ©ç”¨ä¼ è¾“è¯­æ³•ç»™å¦å¤–ä¸¤å°æœºå™¨å‘é€è„šæœ¬ï¼š

```
xsync xsync
```

å½“ç„¶è¦è¾“å…¥å¯†ç ã€‚ä¹‹åé‚£ä¸¤å°æœºå™¨è®°å¾—sourceå“Ÿ



æ¥ä¸‹æ¥æˆ‘ä»¬è®¾ç½®å…å¯†ç™»é™†ï¼Œè¿™æ ·å°±å¯ä»¥ä¸è¾“å…¥å¯†ç äº†ï¼š

- 3å°é›†ç¾¤åŒæ—¶è°ƒç”¨è¿œç¨‹è¿æ¥å‘½ä»¤

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230714212426639.png" alt="image-20230714212426639" style="zoom:25%;" />

ä»¥æ­¤ç±»æ¨ï¼Œè¿æ¥å…¶ä»–ä¸¤ä¸ªæœºå™¨



- 3å°æœºå™¨å…¨éƒ½cd åˆ°~/.ssh/ï¼ˆrootç”¨æˆ·ä¹Ÿæ˜¯è¿™æ ·æ“ä½œï¼‰

è°ƒç”¨å‘½ä»¤ç”Ÿæˆå¯†é’¥

```
ssh-keygen -t rsa
```



- æŠŠå¯†é’¥å‘ç»™å…¶ä»–æœºå™¨ï¼ˆä¸€èµ·å‘ï¼‰ã€ä½ å¯ä»¥ç†è§£ä¸ºå‘é—´è°åˆ°å…¶ä»–æœºå™¨é‡Œå»ã€‘

```
[atguigu@hadoop102 .ssh]$ ssh-copy-id hadoop102
[atguigu@hadoop102 .ssh]$ ssh-copy-id hadoop103
[atguigu@hadoop102 .ssh]$ ssh-copy-id hadoop104
```





### ï¼ˆ2ï¼‰JDKéƒ¨ç½²

æŸ¥çœ‹æœ¬æœºæ˜¯å¦å®‰è£…java

```
rpm -qa | grep -i java 
```

ä¸€è¡Œéƒ½æ²¡è¾“å‡ºâ€”â€”æ²¡æœ‰java



åœ¨softwareç›®å½•ä¸‹å®‰è£…è½¯ä»¶ï¼š

```
 cd /opt/software/
```

æŠŠJDKæ‹–æ‹½åˆ°è¯¥ç›®å½•ä¸‹ï¼Œ

ç„¶åè§£å‹åˆ°/opt/module  

```
tar -zxvf æ–‡ä»¶å  -C /opt/module                
```

**è¿™ä¸€æ­¥æˆ‘å‡ºäº†é—®é¢˜ï¼Œè§£å†³æ–¹æ³•â€”â€”æŠŠfinallshellçš„è¿æ¥ç”¨æˆ·åˆ‡æ¢åˆ°rootç”¨æˆ·**

æŠŠJDKå‘ç»™å…¶ä»–ä¸¤å°æœºå™¨

```
 xsync jdk1.8.0_212/
```

**æ³¨æ„ï¼šè¦æ³¨æ„ä½ è¿™ä¸ªæ–‡ä»¶æ˜¯è°çš„ï¼Ÿå¦‚æœæ˜¯rootç”¨æˆ·çš„ï¼Œé‚£ä¹ˆåªèƒ½ä»¥rootç”¨æˆ·çš„èº«ä»½è¿›è¡Œä¼ è¾“ï¼Œå¦åˆ™ä¸å¾—è¡Œã€‚**

å½“ç„¶:ä½ å¦‚æœæ˜¯å…¶ä»–ç”¨æˆ·ç”¨sudoä¹Ÿæ˜¯å¯ä»¥çš„ï¼šä¾‹å¦‚ï¼š

```
sudo    /home/lchen/xsync       /etc/profile.d/my_env.sh
æƒé™å‡çº§ +  è„šæœ¬ä½ç½®  +å‘é€ä½ç½®
```



**è®¾ç½®javaHome**

è¿™é‡Œæˆ‘ç”¨ï¼š

```
[atguigu@hadoop102 ~]$ sudo vim /etc/profile.d/my_env.sh
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```
#JAVA_HOME
export JAVA_HOME=/opt/module/jdk1.8.0_212
export PATH=$PATH:$JAVA_HOME/bin
```

**å‘ç»™å…¶ä»–æœºå™¨ï¼š**

```
sudo    /home/lchen/xsync       /etc/profile.d/my_env.sh
```



source ä¸€ä¸‹/etc/profile æ–‡ä»¶ï¼Œè®©æ–°çš„ç¯å¢ƒå˜é‡ PATH ç”Ÿæ•ˆ**ï¼ˆ3å°éƒ½è¦ï¼‰**

```
[atguigu@hadoop102 ~]$ source /etc/profile
```

#####  æµ‹è¯• JDK æ˜¯å¦å®‰è£…æˆåŠŸ

```
[atguigu@hadoop102 ~]$ java -version
```

![image-20230716212055170](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230716212055170.png)

æˆåŠŸï¼





#### ç¯å¢ƒå˜é‡è¯´æ˜ï¼š

Linuxçš„ç¯å¢ƒå˜é‡å¯ä»¥å†å¤šä¸ªæ–‡ä»¶ä¸­é…ç½®ï¼Œå¦‚ï¼š

/etc/profile.d/*.sh          ~/bashrc                   ~/.bash_profileç­‰

ä¸‹é¢è¯´æ˜è¿™å‡ ä¸ªæ–‡ä»¶çš„å…³ç³»ä¸åŒºåˆ«ï¼š

linxuå‘½ä»¤è¡Œï¼ˆbashï¼‰çš„å‘½ä»¤æ¨¡å¼åˆ†ä¸ºï¼š

- ç™»é™†çš„â€”â€”login shell                              ï¼ˆå¸¸è§„å‘½ä»¤éƒ½æ˜¯loginæ¨¡å¼ï¼‰   
- éç™»é™†çš„â€”â€”non-login shell                      ï¼ˆsshè¿œç¨‹è¿æ¥å°±æ˜¯non-loginï¼‰

**æ³¨æ„ä¸¤ç§æ¨¡å¼çš„å‘½ä»¤æ‰€è°ƒåˆ°çš„ç¯å¢ƒå˜é‡æ˜¯ä¸ä¸€æ ·çš„ï¼**

è¿™å°±å¯¼è‡´æœ‰äº›å‘½ä»¤æ— æ³•ç”¨äºè¿œç¨‹è¿æ¥å¦‚â€”â€”ll

**ä¸¤ç§æ¨¡å¼å¯¹åº”çš„ç¯å¢ƒå˜é‡è®¾ç½®å¦‚ä¸‹ï¼š**

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230717214331657.png" alt="image-20230717214331657" style="zoom:33%;" />

å¦‚å›¾ï¼šå¦‚æœæˆ‘æƒ³è®©ç¯å¢ƒå˜é‡åŒæ—¶ä½œç”¨äºä¸¤ç§æ¨¡å¼ï¼Œå°±åœ¨~/.bashrc/etc/bashrc/etc/profile.dä¸‹åˆ›å»º*.shæ–‡ä»¶ã€‚





#### é…ç½®è„šæœ¬æŸ¥çœ‹èŠ‚ç‚¹è¿›ç¨‹

```
 cd /bin              è¿›å…¥å…¨å±€binæ–‡ä»¶å¤¹
 vim xcall.sh          åˆ›å»ºè„šæœ¬æ–‡ä»¶
```

è„šæœ¬æ–‡ä»¶å†…å®¹ï¼š

```
#! /bin/bash
 
for i in hadoop102 hadoop103 hadoop104
do
    echo --------- $i ----------
    ssh $i "$*"
done
```

èµ‹äºˆè„šæœ¬æƒé™ï¼š

```
chmod +x xcall.sh
```



ç„¶åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡xcallå‘½ä»¤è®¿é—®ä¸‰å°æœºå™¨çš„è¿›ç¨‹ï¼šï¼ˆ**å¿…é¡»åœ¨binç›®å½•é‡Œæ‰èƒ½ä½¿ç”¨è¯¥è„šæœ¬å‘½ä»¤**ï¼‰

```
 xcall.sh jps
```

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230718202131834.png" alt="image-20230718202131834" style="zoom:33%;" />









### ï¼ˆ3ï¼‰å¤§æ•°æ®è½¯ä»¶å®‰è£…

#### 1.å®‰è£…ZooKeeper

- cdåˆ° /opt/softwareï¼Œå°†å‹ç¼©åŒ…æ”¾è¿›å»

ç„¶åè§£å‹åˆ°modileæ–‡ä»¶å¤¹ä¸­ï¼š

```
 tar -zxvf apache-zookeeper-3.7.1-bin.tar.gz -C /opt/module/
```

cdåˆ°modileæ–‡ä»¶å¤¹ï¼Œç»™è½¯ä»¶æ–‡ä»¶å¤¹æ”¹ä¸ªåå­—ï¼Œä»¥åå¥½åŒºåˆ†ï¼š

```
mv apache-zookeeper-3.7.1-bin/ zookeeper
```



- è¿›å…¥zookeeperæ–‡ä»¶å¤¹

åˆ›å»ºä¸€ä¸ªå­˜æ•°æ®çš„æ–‡ä»¶å¤¹ï¼ˆåå­—è‡ªå®šä¹‰ï¼‰ï¼š

```
 mkdir zkData
```

åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºmyidæ–‡ä»¶ï¼ˆ**æ³¨æ„è¿™ä¸ªæ–‡ä»¶åå­—å›ºå®šï¼Œå°±æ˜¯myidã€‚ä¸èƒ½æ”¹**ï¼‰

```
vim myid
```

é‡Œé¢ç»™zookeeeperæ–‡ä»¶ç¼–å·ï¼š



è¿›å…¥é…ç½®æ–‡ä»¶ï¼ˆconfæ–‡ä»¶å¤¹ä¸‹çš„ï¼‰ï¼š

æŠŠzookeeper/confä¸‹çš„ zoo_sample.cfgæ–‡ä»¶æ›´åä¸ºzoo.cfgï¼š

```
 mv zoo_sample.cfg  zoo.cfg
```

ç„¶åè¿›å…¥è¿™ä¸ªæ–‡ä»¶ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š

ï¼ˆ1ï¼‰ä¿®æ”¹æ–‡ä»¶å­˜å‚¨è·¯å¾„ä¸ºè‡ªå®šä¹‰æ–‡ä»¶å¤¹

![image-20230718203631049](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230718203631049.png)

ï¼ˆ2ï¼‰åœ¨æœ«å°¾æ·»åŠ ä¸‰ä¸ªæœºå™¨

![image-20230718204140320](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230718204140320.png)



- æŠŠzookeeperåˆ†å‘ç»™å…¶ä»–æœºå™¨ï¼Œ**å¹¶ä¸”æŠŠå¯¹åº”çš„myidæ–‡ä»¶é‡Œçš„ç¼–å·åˆ†åˆ«æ”¹æˆ3å’Œ4**

```
xsync zookeeper/
```

ç„¶åä¿®æ”¹ç¼–å·ï¼ˆä»¥hadoop3ä¸ºä¾‹ï¼‰ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230718204549648.png" alt="image-20230718204549648" style="zoom:50%;" />





- å¯åŠ¨zookeeper

å¯åŠ¨å‘½ä»¤ï¼šï¼ˆè¿™ä¸ªéœ€è¦æ¯å°æœºå™¨éƒ½è¾“å…¥ä¸€éï¼‰

```
bin/zkServer.sh start
```

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230718205058700.png" alt="image-20230718205058700" style="zoom:33%;" />

å¯è§ä¸‰å°æœºå™¨éƒ½å·²ç»å¯åŠ¨Zookeeper



- å½“ç„¶ä¸ºäº†å¯åŠ¨æ›´æ–¹ä¾¿ï¼Œæˆ‘ä»¬è‡ªç„¶è¦å®‰æ’ä¸Šç¾¤èµ·ç¾¤åœçš„è„šæœ¬ï¼š

ç›´æ¥åœ¨ bin/ç›®å½•ä¸‹ï¼ˆæ˜¯ç³»ç»Ÿçš„binç›®å½•ï¼‰åˆ›å»ºè„šæœ¬æ–‡ä»¶ï¼šzk.sh

```
#!/bin/bash
case $1 in
"start"){
for i in hadoop102 hadoop103 hadoop104
do
echo ---------- zookeeper $i å¯åŠ¨ ------------
ssh  $i  "/opt/module/zookeeper/bin/zkServer.sh start"
done
};;
"stop"){
for i in hadoop102 hadoop103 hadoop104
do
echo ---------- zookeeper $i åœæ­¢ ------------
ssh  $i  "/opt/module/zookeeper/bin/zkServer.sh stop"
done
};;
"status"){
for i in hadoop102 hadoop103 hadoop104
do
echo ---------- zookeeper $i çŠ¶æ€ ------------
ssh  $i  "/opt/module/zookeeper/bin/zkServer.sh status"
done
};;
esac
```

æ·»åŠ è„šæœ¬æƒé™ï¼š

```
chmod +x zk.sh
```

é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è„šæœ¬æ–‡ä»¶å¯åŠ¨/åœæ­¢zookeeperäº†ï¼š

```
zk.sh stop
zk.sh start
```

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230718210846088.png" alt="image-20230718210846088" style="zoom:33%;" />



#### 2.å®‰è£…Hadoop

```
é¦–å…ˆæˆ‘ä»¬ä¾ç„¶è¿˜æ˜¯å…ˆæŠŠå®‰è£…åŒ…ä¸Šä¼ ï¼š
cd /opt/software
```

è§£å‹åˆ°modeç›®å½•ä¸‹ï¼š

```
 tar -zxvf hadoop-3.3.4.tar.gz  -C /opt/module/
```

æœ€åå†chmodä¸€ä¸‹å…å¾—åé¢éº»çƒ¦ï¼š

```
chmod -R 777 ./hadoop
```







- æ·»åŠ Hadoopåˆ°ç¯å¢ƒå˜é‡

```
vim /etc/profile.d/my_env.sh 
```

æ·»åŠ ï¼š

```
#Hadoop_HOME
export HADOOP_HOME=/opt/module/hadoop
export PATH=$PATH:$HADOOP_HOME/bin
export PATH=$PATH:$HADOOP_HOME/sbin
```

åˆ†æ³•ç¯å¢ƒå˜é‡ç»™å…¶ä»–æœºå™¨ï¼š

```
xsync /etc/profile.d/my_env.sh
æˆ–è€…ï¼š
/home/lchen/bin/xsync    /etc/profile.d/my_env.sh
```

åŠ è½½ç¯å¢ƒå˜é‡ï¼ˆsourceä¸€ä¸‹ï¼‰ï¼š

æœ€å¥½æœºå™¨å…¨éƒ½sourceä¸€é

```
source /etc/profile.d/my_env.sh 
```





- ä¿®æ”¹æ–‡ä»¶åä¸ºhadoopå¹¶ä¿®æ”¹é…ç½®


```
 mv hadoop-3.3.4/  hadoop
 cd  $HADOOP_HOME/etc/hadoop
```

ç¼–è¾‘hadoopæ–‡ä»¶å¤¹é‡Œçš„core-site.xml

æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š(æŠŠatguiguæ”¹æˆlchen)

```
<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="configuration.xsl"?>
<configuration>
<!-- æŠŠå¤šä¸ªNameNodeçš„åœ°å€ç»„è£…æˆä¸€ä¸ªé›†ç¾¤mycluster -->
  <property>
    <name>fs.defaultFS</name>
    <value>hdfs://mycluster</value>
  </property>

  <!-- æŒ‡å®šhadoopè¿è¡Œæ—¶äº§ç”Ÿæ–‡ä»¶çš„å­˜å‚¨ç›®å½• -->
  <property>
    <name>hadoop.tmp.dir</name>
    <value>/opt/module/hadoop/data</value>
  </property>
<!-- é…ç½®NNæ•…éšœè½¬ç§»çš„ ZKé›†ç¾¤-->
<property>
	<name>ha.zookeeper.quorum</name>
	<value>hadoop102:2181,hadoop103:2181,hadoop104:2181</value>
</property>

<!-- é…ç½®HDFSç½‘é¡µç™»å½•ä½¿ç”¨çš„é™æ€ç”¨æˆ·ä¸ºatguigu -->
    <property>
        <name>hadoop.http.staticuser.user</name>
        <value>lchen</value>
</property>

<!-- é…ç½®è¯¥atguigu(superUser)å…è®¸é€šè¿‡ä»£ç†è®¿é—®çš„ä¸»æœºèŠ‚ç‚¹ -->
    <property>
        <name>hadoop.proxyuser.lchen.hosts</name>
        <value>*</value>
</property>
<!-- é…ç½®è¯¥atguigu(superUser)å…è®¸é€šè¿‡ä»£ç†ç”¨æˆ·æ‰€å±ç»„ -->
    <property>
        <name>hadoop.proxyuser.lchen.groups</name>
        <value>*</value>
</property>
<!-- é…ç½®è¯¥atguigu(superUser)å…è®¸é€šè¿‡ä»£ç†çš„ç”¨æˆ·-->
    <property>
        <name>hadoop.proxyuser.lchen.users</name>
        <value>*</value>
</property>

    
</configuration>
```

ç¼–è¯‘ï¼šhdfs-site.xml

```
<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="configuration.xsl"?>
<configuration>

<!-- NameNodeæ•°æ®å­˜å‚¨ç›®å½• -->
  <property>
    <name>dfs.namenode.name.dir</name>
    <value>file://${hadoop.tmp.dir}/name</value>
  </property>

  <!-- DataNodeæ•°æ®å­˜å‚¨ç›®å½• -->
  <property>
    <name>dfs.datanode.data.dir</name>
    <value>file://${hadoop.tmp.dir}/data</value>
  </property>

  <!-- JournalNodeæ•°æ®å­˜å‚¨ç›®å½• -->
  <property>
    <name>dfs.journalnode.edits.dir</name>
    <value>${hadoop.tmp.dir}/jn</value>
  </property>

  <!-- å®Œå…¨åˆ†å¸ƒå¼é›†ç¾¤åç§° -->
  <property>
    <name>dfs.nameservices</name>
    <value>mycluster</value>
  </property>

  <!-- é›†ç¾¤ä¸­NameNodeèŠ‚ç‚¹éƒ½æœ‰å“ªäº› -->
  <property>
    <name>dfs.ha.namenodes.mycluster</name>
    <value>nn1,nn2</value>
  </property>

  <!-- NameNodeçš„RPCé€šä¿¡åœ°å€ -->
  <property>
    <name>dfs.namenode.rpc-address.mycluster.nn1</name>
    <value>hadoop102:8020</value>
  </property>
  <property>
    <name>dfs.namenode.rpc-address.mycluster.nn2</name>
    <value>hadoop103:8020</value>
  </property>

  <!-- NameNodeçš„httpé€šä¿¡åœ°å€ -->
  <property>
    <name>dfs.namenode.http-address.mycluster.nn1</name>
    <value>hadoop102:9870</value>
  </property>
  <property>
    <name>dfs.namenode.http-address.mycluster.nn2</name>
    <value>hadoop103:9870</value>
  </property>

  <!-- æŒ‡å®šNameNodeå…ƒæ•°æ®åœ¨JournalNodeä¸Šçš„å­˜æ”¾ä½ç½® -->
  <property>
    <name>dfs.namenode.shared.edits.dir</name>
<value>qjournal://hadoop102:8485;hadoop103:8485;hadoop104:8485/mycluster</value>
  </property>

  <!-- è®¿é—®ä»£ç†ç±»ï¼šclientç”¨äºç¡®å®šå“ªä¸ªNameNodeä¸ºActive -->
  <property>
    <name>dfs.client.failover.proxy.provider.mycluster</name>
    <value>org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider</value>
  </property>

  <!-- é…ç½®éš”ç¦»æœºåˆ¶ï¼Œå³åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€å°æœåŠ¡å™¨å¯¹å¤–å“åº” -->
  <property>
    <name>dfs.ha.fencing.methods</name>
    <value>sshfence</value>
  </property>

  <!-- ä½¿ç”¨éš”ç¦»æœºåˆ¶æ—¶éœ€è¦sshç§˜é’¥ç™»å½•-->
  <property>
    <name>dfs.ha.fencing.ssh.private-key-files</name>
    <value>/home/lchen/.ssh/id_rsa</value>
  </property>
<!-- å¯ç”¨nnæ•…éšœè‡ªåŠ¨è½¬ç§» -->
<property>
	 <name>dfs.ha.automatic-failover.enabled</name>
	 <value>true</value>
</property>    
    <!-- æµ‹è¯•ç¯å¢ƒæŒ‡å®šHDFSå‰¯æœ¬çš„æ•°é‡1 -->
    <property>
        <name>dfs.replication</name>
        <value>3</value>
    </property>


</configuration>
```

é…ç½®yarn-site.xml:

```
<property>
        <name>yarn.nodemanager.aux-services</name>
        <value>mapreduce_shuffle</value>
    </property>

    <!-- å¯ç”¨resourcemanager ha -->
    <property>
        <name>yarn.resourcemanager.ha.enabled</name>
        <value>true</value>
    </property>
 
    <!-- å£°æ˜ä¸¤å°resourcemanagerçš„åœ°å€ -->
    <property>
        <name>yarn.resourcemanager.cluster-id</name>
        <value>cluster-yarn1</value>
    </property>

    <!--æŒ‡å®šresourcemanagerçš„é€»è¾‘åˆ—è¡¨-->
    <property>
        <name>yarn.resourcemanager.ha.rm-ids</name>
        <value>rm1,rm2</value>
    </property>
<!-- ========== rm1çš„é…ç½® ========== -->
    <!-- æŒ‡å®šrm1çš„ä¸»æœºå -->
    <property>
        <name>yarn.resourcemanager.hostname.rm1</name>
        <value>hadoop102</value>
    </property>

    <!-- æŒ‡å®šrm1çš„webç«¯åœ°å€ -->
    <property>
        <name>yarn.resourcemanager.webapp.address.rm1</name>
        <value>hadoop102:8088</value>
    </property>

    <!-- æŒ‡å®šrm1çš„å†…éƒ¨é€šä¿¡åœ°å€ -->
    <property>
        <name>yarn.resourcemanager.address.rm1</name>
        <value>hadoop102:8032</value>
    </property>

    <!-- æŒ‡å®šAMå‘rm1ç”³è¯·èµ„æºçš„åœ°å€ -->
    <property>
        <name>yarn.resourcemanager.scheduler.address.rm1</name>  
        <value>hadoop102:8030</value>
    </property>

    <!-- æŒ‡å®šä¾›NMè¿æ¥çš„åœ°å€ -->  
    <property>
    <name>yarn.resourcemanager.resource-tracker.address.rm1</name>
        <value>hadoop102:8031</value>
    </property>

<!-- ========== rm2çš„é…ç½® ========== -->
    <!-- æŒ‡å®šrm2çš„ä¸»æœºå -->
    <property>
        <name>yarn.resourcemanager.hostname.rm2</name>
        <value>hadoop103</value>
    </property>
    <property>
        <name>yarn.resourcemanager.webapp.address.rm2</name>
        <value>hadoop103:8088</value>
    </property>
    <property>
        <name>yarn.resourcemanager.address.rm2</name>
        <value>hadoop103:8032</value>
    </property>
    <property>
        <name>yarn.resourcemanager.scheduler.address.rm2</name>
        <value>hadoop103:8030</value>
    </property>

    <property>
<name>yarn.resourcemanager.resource-tracker.address.rm2</name>
        <value>hadoop103:8031</value>
    </property>


    <!-- æŒ‡å®šzookeeperé›†ç¾¤çš„åœ°å€ --> 
    <property>
        <name>yarn.resourcemanager.zk-address</name>
        <value>hadoop102:2181,hadoop103:2181,hadoop104:2181</value>
    </property>

    <!-- å¯ç”¨RMè‡ªåŠ¨æ•…éšœè½¬ç§» --> 
    <property>
        <name>yarn.resourcemanager.recovery.enabled</name>
        <value>true</value>
    </property>
 
    <!-- æŒ‡å®šresourcemanagerçš„çŠ¶æ€ä¿¡æ¯å­˜å‚¨åœ¨zookeeperé›†ç¾¤ --> 
    <property>
        <name>yarn.resourcemanager.store.class</name>     <value>org.apache.hadoop.yarn.server.resourcemanager.recovery.ZKRMStateStore</value>
</property>

    <!-- ç¯å¢ƒå˜é‡çš„ç»§æ‰¿ -->
    <property>
        <name>yarn.nodemanager.env-whitelist</name>
        <value>JAVA_HOME,HADOOP_COMMON_HOME,HADOOP_HDFS_HOME,HADOOP_CONF_DIR,CLASSPATH_PREPEND_DISTCACHE,HADOOP_YARN_HOME,HADOOP_MAPRED_HOME</value>
    </property>
    
    <!--yarnå•ä¸ªå®¹å™¨å…è®¸åˆ†é…çš„æœ€å¤§æœ€å°å†…å­˜ -->
    <property>
        <name>yarn.scheduler.minimum-allocation-mb</name>
        <value>512</value>
    </property>
    <property>
        <name>yarn.scheduler.maximum-allocation-mb</name>
        <value>4096</value>
    </property>
    
    <!-- yarnå®¹å™¨å…è®¸ç®¡ç†çš„ç‰©ç†å†…å­˜å¤§å° -->
    <property>
        <name>yarn.nodemanager.resource.memory-mb</name>
        <value>4096</value>
    </property>
    
    <!-- å…³é—­yarnå¯¹ç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜çš„é™åˆ¶æ£€æŸ¥ -->
    <property>
        <name>yarn.nodemanager.pmem-check-enabled</name>
        <value>true</value>
    </property>
    <property>
        <name>yarn.nodemanager.vmem-check-enabled</name>
        <value>false</value>
    </property>

<!-- å¼€å¯æ—¥å¿—èšé›†åŠŸèƒ½ -->
<property>
    <name>yarn.log-aggregation-enable</name>
    <value>true</value>
</property>

<!-- è®¾ç½®æ—¥å¿—èšé›†æœåŠ¡å™¨åœ°å€ -->
<property>  
    <name>yarn.log.server.url</name>  
    <value>http://hadoop102:19888/jobhistory/logs</value>
</property>

<!-- è®¾ç½®æ—¥å¿—ä¿ç•™æ—¶é—´ä¸º7å¤© -->
<property>
    <name>yarn.log-aggregation.retain-seconds</name>
    <value>604800</value>
</property>

```

é…ç½®mapred-site.xmlï¼š

```
<!-- æŒ‡å®šMapReduceç¨‹åºè¿è¡Œåœ¨Yarnä¸Š -->
    <property>
        <name>mapreduce.framework.name</name>
        <value>yarn</value>
    </property>
<!-- å†å²æœåŠ¡å™¨ç«¯åœ°å€ -->
<property>
    <name>mapreduce.jobhistory.address</name>
    <value>hadoop102:10020</value>
</property>

<!-- å†å²æœåŠ¡å™¨webç«¯åœ°å€ -->
<property>
    <name>mapreduce.jobhistory.webapp.address</name>
    <value>hadoop102:19888</value>
</property>


```

é…ç½®worker:

```
hadoop102
hadoop103
hadoop104
```

**é…ç½®mapred-site.xml**

```
<!-- å†å²æœåŠ¡å™¨ç«¯åœ°å€ -->
<property>
    <name>mapreduce.jobhistory.address</name>
    <value>hadoop102:10020</value>
</property>

<!-- å†å²æœåŠ¡å™¨webç«¯åœ°å€ -->
<property>
    <name>mapreduce.jobhistory.webapp.address</name>
    <value>hadoop102:19888</value>
</property>

```

æœ€å¥½åˆ†å‘Hadoopç»™å…¶ä»–æœºå™¨ï¼š

```
 xsync hadoop/
```





#### 3.å¯åŠ¨Hadoop-HA

- å¯åŠ¨journalnodeæœåŠ¡ï¼Œ3å°æœºå™¨éƒ½è¦å¯åŠ¨(root)

```
hdfs --daemon start journalnode
```

ç¬¬ä¸€æ¬¡å¯åŠ¨ä¼šæ˜¾ç¤ºä¸€ä¸ªæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ²¡å…³ç³»

è‹¥å‡ºç°æƒé™ä¸å¤Ÿï¼š

```
sudo chmod -R  777  /opt/module/hadoop
```



- hadoop102æ‰§è¡Œæ ¼å¼åŒ–å¹¶å¯åŠ¨

```
hdfs namenode -format
hdfs --daemon start namenode
```



- åœ¨hadoop103åŒæ­¥nn1çš„å…ƒæ•°æ®ä¿¡æ¯

```
hdfs namenode -bootstrapStandby
```



- hadoop102åˆå§‹åŒ–åè®®

```
hdfs zkfc -formatZK
```

æ³¨æ„ä½ çš„zookeepè¦å…ˆå¯åŠ¨

- å¯åŠ¨zkfc      æ‰€æœ‰èŠ‚ç‚¹å³å¯

```
hdfs --daemon start zkfc
```



- åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šï¼Œå¯åŠ¨datanode

```
hdfs --daemon start datanode
```



- æŸ¥çœ‹è¿›ç¨‹

```
xcall.sh jps
```

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230722173159342.png" alt="image-20230722173159342" style="zoom:25%;" />

è‹¥å‡ºç°jpsåæ— æ³•æŸ¥çœ‹Hadoopè¿›ç¨‹ï¼Œä½†æ˜¯Hadoopå´èƒ½æ­£å¸¸è¿è¡Œï¼ˆhttp://hadoop102:9870/èƒ½æ­£å¸¸è®¿é—®ï¼‰ï¼š

è¿™æ˜¯å› ä¸º`hsperfdata_hadoop` å’Œ `hsperfdata_root` çš„æƒé™ä¸ä¸€è‡´ï¼Œ

ä¿®æ”¹ `hsperfdata_hadoop` çš„æƒé™ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230724210347725.png" alt="image-20230724210347725" style="zoom:33%;" />

```
hmod 755 /temp/hsperfdata_*
```





- å¯åŠ¨å‘½ä»¤

ä»¥åæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥é€šè¿‡è„šæœ¬å¯åŠ¨äº†ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230722173259597.png" alt="image-20230722173259597" style="zoom:33%;" />



- åœæ­¢ç›¸å…³æœåŠ¡

```
stop-dfs.sh
```

ç”¨lchenç”¨æˆ·ï¼Œrootç”¨æˆ·ä¸å¾—è¡Œã€‚å› ä¸ºæˆ‘ä»¬é…ç½®æ–‡ä»¶é‡Œé…çš„æ˜¯lchen





#### 4.Hadoopç¾¤èµ·è„šæœ¬

```
cd /home/lchen/bin

vim hdp.sh
```

ç¼–å†™å†…å®¹ï¼š

```
#!/bin/bash
if [ $# -lt 1 ]
then
    echo "No Args Input..."
    exit ;
fi
case $1 in
"start")
        echo " =================== å¯åŠ¨ hadoopé›†ç¾¤ ==================="

        echo " --------------- å¯åŠ¨ hdfs å’Œ yarn ---------------"
        ssh hadoop102 "/opt/module/hadoop/sbin/start-all.sh"
        echo " --------------- å¯åŠ¨ historyserver ---------------"
        ssh hadoop102 "/opt/module/hadoop/bin/mapred --daemon start historyserver"
;;
"stop")
        echo " =================== å…³é—­ hadoopé›†ç¾¤ ==================="

        echo " --------------- å…³é—­ historyserver ---------------"
        ssh hadoop102 "/opt/module/hadoop/bin/mapred --daemon stop historyserver"
        echo " --------------- å…³é—­ hdfs å’Œ yarn ---------------"
        ssh hadoop102 "/opt/module/hadoop/sbin/stop-all.sh"
;;
*)
    echo "Input Args Error..."
;;
esac

```

æ·»åŠ è„šæœ¬æƒé™ï¼š

```
chmod 777 hdp.sh
```

å¤åˆ¶åˆ°rootçš„è„šæœ¬ç›®å½•ä¸‹ï¼Œæ–¹ä¾¿rootç”¨æˆ·ä½¿ç”¨ï¼š

```
sudo cp xsync /bin/   å¤åˆ¶è„šæœ¬åˆ°binä¸­æ–¹ä¾¿å…¨å±€è°ƒç”¨
```

å¯åŠ¨é›†ç¾¤ï¼šï¼ˆä»¥lchençš„èº«ä»½ï¼‰

```
./hdp.sh start
```







#### é—®é¢˜å½’çº³ï¼ˆâ­ï¼‰

- æƒé™é—®é¢˜  chmod -Rå‘½ä»¤è§£å†³
- æŠ¥é”™â€”â€”å¯èƒ½æ˜¯zookeeperæ²¡æœ‰å¯åŠ¨/ç”¨æˆ·éœ€è¦ä½¿ç”¨lchen
- JPSæ²¡ä¸œè¥¿ï¼Œä½†æ˜¯hadoop102:9870å¯ä»¥æ­£å¸¸è®¿é—®ï¼ˆä¿®æ”¹ `hsperfdata_hadoop` çš„æƒé™ï¼šï¼‰

**è‹¥æŠ¥é”™ï¼š**

```
ERROR: Unable to write in /opt/module/hadoop-3.1.3/logs. Aborting.
```

è§£å†³æ–¹æ³•ï¼š(ä¸‰å°æœºå™¨éƒ½éœ€è¦)

```
sudo chmod -R 777 /opt/module/hadoop/logs
```

**è‹¥æŠ¥é”™ï¼š**

```
ERROR: Cannot write namenode pid /tmp/hadoop-longda-namenode.pid
```

è§£å†³æ–¹æ³•ï¼ˆä¸‰å°æœºå™¨ï¼‰ï¼š

```
sudo chmod 777 -R /tmp 
```

**è‹¥å‡ºç°ï¼š**

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230723161648343.png" alt="image-20230723161648343" style="zoom:25%;" />

è§£å†³æ–¹æ³•ï¼š

```
[lchen@hadoop102 tmp]$ cd /tmp
[lchen@hadoop102 tmp]$ rm -rf hsperfdata_*
```

**æƒé™é—®é¢˜è§£å†³è¯­æ³•ï¼š**

```
â€œsudo chown -R ç”¨æˆ·å:ç”¨æˆ·å èµ‹äºˆçš„æ–‡ä»¶è·¯å¾„
```

å‚è€ƒåšå®¢ï¼šhttps://blog.csdn.net/qq_44920169/article/details/116330119

**æ°”æ­»>~<ï¼Œä¸€ç›´æœ‰æƒé™é—®é¢˜ï¼Œæˆ‘ç›´æ¥å°±æŠŠlchenæƒé™æ”¹ä¸ºrootï¼š**ï¼ˆâ­ï¼‰

ä¿®æ”¹ /etc/sudoers æ–‡ä»¶:

```
%wheel  ALL=(ALL)       ALLä¸‹é¢ä¸€è¡Œï¼š
æ³¨é‡Šæ‰ï¼š
lchen ALL=(ALL) NOPASSWD:ALL

æ‰¾åˆ°å¹¶æ·»åŠ ï¼š
## Allow root to run any commands anywhere 
root    ALL=(ALL)       ALL
lchen ALL=(ALL)         ALL
```





#### ç»ˆäºæˆåŠŸäº†ï¼ï¼ˆé‡è£…äº†ä¸‰éå‘ğŸ˜­ï¼‰

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230724211458100.png" alt="image-20230724211458100" style="zoom:33%;" />

æŸ¥çœ‹è¿›ç¨‹ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230724211431643.png" alt="image-20230724211431643" style="zoom:33%;" />

#### 2.1å°é—®é¢˜

- æäº†ä»¥åå‡ºäº†ä¸€ä¸ªå°é—®é¢˜ï¼Œæˆ‘çš„Hadoopåœ¨102å’Œ103ä¸Šéƒ½æœ‰namenodeæ•…æˆ‘åªèƒ½åœ¨103ä¸ŠæŸ¥çœ‹HDFSï¼Œä¸è¿‡å¥½åƒæ²¡ä»€ä¹ˆé—®é¢˜ã€‚

  å‚è€ƒåšå®¢ï¼šhttps://blog.csdn.net/weixin_51967583/article/details/121435007

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230729174433560.png" alt="image-20230729174433560" style="zoom:25%;" />

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230729174610012.png" alt="image-20230729174610012" style="zoom:25%;" />

æˆ‘ä»¬æŸ¥çœ‹hadoop102çš„namenodeçŠ¶æ€ï¼š

![image-20230729174359156](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230729174359156.png)

å¦‚æœæˆ‘ä»¬æƒ³å€Ÿç”±hadoop102æŸ¥çœ‹ï¼š

```
hdfs haadmin -transitionToActive --forcemanual nn1
```

é‡å¯Hadoopå³å¯å®Œæˆï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230803155900514.png" alt="image-20230803155900514" style="zoom:25%;" />

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230822204611610.png" alt="image-20230822204611610" style="zoom:25%;" />





#### 2.2HDFSå¤šç›®å½•é…ç½®ä»¥åŠæœºå™¨çš„é›†åˆï¼ˆäº†è§£ï¼‰

æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š

```
df -h
```

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230724212230138.png" alt="image-20230724212230138" style="zoom:33%;" />

å¦‚æœä½ æ˜¯å¤šç£ç›˜å¯ä»¥è€ƒè™‘å¤šç›®å½•é…ç½®ï¼š

hdfs-site.xmlæ–‡ä»¶ä¸­é…ç½®å¤šç›®å½•ï¼š

```
<property>
<name>dfs.datanode.data.dir</name>
<value>file:///dfs/data1,file:///hd2/dfs/data2,file:///hd3/dfs/data3,file:///hd4/dfs/data4</value>
</property>
```

**æ³¨æ„ï¼šæ¯å°æœåŠ¡å™¨æŒ‚è½½çš„ç£ç›˜ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æ¯ä¸ªèŠ‚ç‚¹çš„å¤šç›®å½•é…ç½®å¯ä»¥ä¸ä¸€è‡´ã€‚å•ç‹¬é…ç½®å³å¯ã€‚**

æˆ‘å°±ä¸é…äº†=_=æ²¡å•¥ç”¨ã€‚



- èŠ‚ç‚¹æ•°æ®å‡è¡¡ï¼ˆå¯ä»¥ä¸ç”¨ç®¡ï¼Œé»˜è®¤å·²ç»å¼€å¯äº†æ•°æ®å‡è¡¡ï¼‰

```
start-balancer.sh -threshold 10
è¡¨ç¤ºå„ä¸ªèŠ‚ç‚¹çš„ç£ç›˜ç©ºé—´åˆ©ç”¨ç‡ä¸è¶…è¿‡10%ï¼Œé»˜è®¤æƒ…å†µä¸‹å°±æ˜¯è¿™ä¹ˆå¤š
```

å…³é—­å¹³è¡¡ï¼š

```
stop-balancer.sh
```



- ç£ç›˜é—´çš„æ•°æ®å¹³è¡¡

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230725095813808.png" alt="image-20230725095813808" style="zoom: 33%;" />











#### 3.å®‰è£…Kafka

å‹ç¼©åŒ…æ”¾åˆ°/opt/softwareé‡Œï¼Œç„¶åè§£å‹ï¼š

```
tar -zxvf kafka_2.12-3.3.1.tgz -C /opt/module/
```

ç„¶åæˆ‘ä»¬è¿›å…¥moduleæ–‡ä»¶å¤¹æ”¹åä¸ºkafkaå°±è¡Œ



- ä¿®æ”¹é…ç½®æ–‡ä»¶

```
cd config/
 vim server.properties
```

æ”¹è¿™äº›åœ°æ–¹ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230725105908477.png" alt="image-20230725105908477" style="zoom:50%;" />

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230725110032470.png" alt="image-20230725110032470" style="zoom:33%;" />

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230725110216201.png" alt="image-20230725110216201" style="zoom:33%;" />



```
åˆ†å‘è½¯ä»¶åŒ…ï¼š
xsync kafka/
```





- æ”¹ä¸€ä¸‹å¦å¤–ä¸¤æœºå™¨çš„é…ç½®æ–‡ä»¶çš„idå·

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230725111818214.png" alt="image-20230725111818214" style="zoom:33%;" />

104idæ”¹æˆ3ï¼Œä¸‹é¢æ”¹æˆhadoop104å³å¯





- é…ç½®ç¯å¢ƒå˜é‡

```
 sudo vim /etc/profile.d/my_env.sh 
```

æ·»åŠ ç¯å¢ƒï¼š

```
#KAFKA_HOME

export KAFKA_HOME=/opt/module/kafka

export PATH=$PATH:$KAFKA_HOME/bin
```

ç„¶ååˆ†å‘æ–‡ä»¶ï¼Œæœ€ååŠ è½½ç¯å¢ƒå˜é‡ï¼ˆä¸‰å°éƒ½è¦ï¼‰

```
 sudo /home/lchen/bin/xsync  /etc/profile.d/my_env.sh 
source /etc/profile
```



- å¯åŠ¨é›†ç¾¤ï¼ˆå®ƒä¿©åˆ©äºzookeeperï¼Œè¦å…ˆå¯åŠ¨zookeeperï¼‰

ä¾æ¬¡åœ¨hadoop102ã€hadoop103ã€hadoop104èŠ‚ç‚¹ä¸Šå¯åŠ¨Kafkaã€‚

```
sudo bin/kafka-server-start.sh -daemon config/server.properties
```



**è‹¥jpså‘ç°æ²¡æœ‰Kafkaï¼ŒæŸ¥çœ‹æ—¥å¿—æ–‡ä»¶æŠ¥é”™ï¼š**

nohup: æ— æ³•è¿è¡Œå‘½ä»¤"java": æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•

è§£å†³æ–¹æ³•ï¼šèµ‹äºˆæƒé™

```
sudo chmod 777 -R kafka/
```

å†å¯åŠ¨å°±è¡Œäº†ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230725121519881.png" alt="image-20230725121519881" style="zoom:33%;" />

é…ç½®ç¾¤èµ·ç¾¤åœçš„è„šæœ¬ï¼š

åœ¨lchençš„binç›®å½•ï¼škf.sh

å†…å®¹ï¼š

```
#! /bin/bash

case $1 in
"start"){
    for i in hadoop102 hadoop103 hadoop104
    do
        echo " --------å¯åŠ¨ $i Kafka-------"
        ssh $i "/opt/module/kafka/bin/kafka-server-start.sh -daemon /opt/module/kafka/config/server.properties"
    done
};;
"stop"){
    for i in hadoop102 hadoop103 hadoop104
    do
        echo " --------åœæ­¢ $i Kafka-------"
        ssh $i "/opt/module/kafka/bin/kafka-server-stop.sh "
    done
};;
esac

```

**æ·»åŠ æ‰§è¡Œæƒé™**

```
chmod 777 kf.sh
```

**å¯åŠ¨/åœæ­¢å‘½ä»¤ï¼š**

```
kf.sh start
kf.sh stop
```



**æˆåŠŸï¼**

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230725122126246.png" alt="image-20230725122126246" style="zoom:25%;" />

æ³¨æ„ï¼šä½ å¿…é¡»å…ˆå…³kafkaå†å…³zookeeperï¼Œå¦åˆ™Kafkaå…³ä¸æ‰ï¼Œåªèƒ½æ‰‹åŠ¨æ€æ­»è¿›ç¨‹



##### Kafkaçš„ç®€ä»‹

â€‹	ä¸€ä¸ªå…¸å‹çš„ Kafka åŒ…å«è‹¥å¹²Producerã€è‹¥å¹² Brokerã€è‹¥å¹² Consumer ä»¥åŠä¸€ä¸ª Zookeeper é›†ç¾¤ã€‚Zookeeper æ˜¯ Kafka ç”¨æ¥è´Ÿè´£é›†ç¾¤å…ƒæ•°æ®ç®¡ç†ã€æ§åˆ¶å™¨é€‰ä¸¾ç­‰æ“ä½œçš„ã€‚Producer æ˜¯è´Ÿè´£å°†æ¶ˆæ¯å‘é€åˆ° Broker çš„ï¼ŒBroker è´Ÿè´£å°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œè€Œ Consumer æ˜¯è´Ÿè´£ä»Broker è®¢é˜…å¹¶æ¶ˆè´¹æ¶ˆæ¯ã€‚

ç›¸å…³æ¦‚å¿µï¼š

1. Brokerâ€”â€” Kafka æœåŠ¡å™¨ï¼Œå®ƒ**æ¥å—ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯å¹¶å­˜å…¥ç£ç›˜**
2. Clusterâ€”â€”è‹¥**å¹²ä¸ª Broker ç»„æˆä¸€ä¸ª é›†ç¾¤ï¼ˆClusterï¼‰**ï¼Œå…¶ä¸­é›†ç¾¤å†…æŸä¸ª Broker ä¼šæˆä¸ºé›†ç¾¤æ§åˆ¶å™¨ï¼Œå®ƒè´Ÿè´£ç®¡ç†é›†ç¾¤ï¼ŒåŒ…æ‹¬åˆ†é…åˆ†åŒºåˆ° Brokerã€ç›‘æ§ Broker æ•…éšœç­‰ã€‚
3. ä¸»é¢˜â€”â€”**æ¶ˆæ¯ä»¥ ä¸»é¢˜ï¼ˆTopicï¼‰æ¥åˆ†ç±»ï¼Œæ¯ä¸€ä¸ªä¸»é¢˜éƒ½å¯¹åº”ä¸€ä¸ªã€Œæ¶ˆæ¯é˜Ÿåˆ—ã€**ï¼Œè¿™æœ‰ç‚¹å„¿ç±»ä¼¼äºæ•°æ®åº“ä¸­çš„è¡¨ã€‚
4. åˆ†åŒºâ€”â€”å°±æ˜¯ç›¸å½“äºé€šé“



**ç›¸å…³å‘½ä»¤ï¼š**

- æŸ¥çœ‹å½“å‰kafkaæœ‰å¤šå°‘ä¸»é¢˜

```
bin/kafka-topics.sh --bootstrap-server hadoop102:9092 --list
```

- åˆ›å»ºä¸»é¢˜

```bash
bin/kafka-topics.sh --bootstrap-server hadoop102:9092 --create --partitions 1  --replication-factor 3 --topic åå­—
```

å…¶ä¸­ï¼š

1. --partitions 1 è¡¨ç¤ºåˆ†åŒºä¸ªæ•°ä¸º1
2. replication-factor 3 è¡¨ç¤ºå‰¯æœ¬ä¸ªæ•°ä¸º3
3. --topic åå­—  ç»™ä¸»é¢˜èµ·åå­—

æ³¨æ„ï¼šä½ å¯ä»¥ä¸åˆ›å»ºä¸»é¢˜ç›´æ¥ä½¿ç”¨ï¼Œå¿…ç„¶ç›´æ¥è°ƒç”¨ç”Ÿäº§è€…å®ƒå¯ä»¥è‡ªå·±åˆ›å»ºä¸€ä¸ªä¸»é¢˜

- æŸ¥çœ‹ä¸»é¢˜è¯¦æƒ…

```
 bin/kafka-topics.sh --bootstrap-server hadoop102:9092 --describe --topic ä¸»é¢˜åå­—
```

- ä¿®æ”¹åˆ†åŒºæ•°ï¼ˆåªèƒ½åŠ ä¸èƒ½å‡ï¼‰

```
bin/kafka-topics.sh --bootstrap-server hadoop102:9092 --alter --topic first --partitions 3
```

- åˆ é™¤ä¸»é¢˜

```
 bin/kafka-topics.sh --bootstrap-server hadoop102:9092 --delete --topic first
```

å¦‚å›¾ï¼šï¼ˆä¸»é¢˜carçš„åˆ›å»ºå’Œåˆ é™¤ï¼‰

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230725212312372.png" alt="image-20230725212312372" style="zoom:33%;" />



- ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å‘½ä»¤ï¼ˆâ­ï¼‰

å¯åŠ¨ç”Ÿäº§è€…ï¼šï¼ˆhadoo102ï¼‰ï¼š

```
bin/kafka-console-producer.sh --bootstrap-server hadoop102:9092 --topic ä¸»é¢˜åå­—
```

å¦‚æœè¯¥ä¸»é¢˜æ²¡æœ‰æå‰åˆ›å»ºï¼Œä¼šè‡ªåŠ¨åˆ›å»ºå¹¶è­¦å‘Š

å¯åŠ¨æ¶ˆè´¹è€…æ¥æ”¶æ•°æ®ï¼ˆ103ï¼‰ï¼š

```
kafka-console-consumer.sh --bootstrap-server hadoop102:9092 --topic ä¸»é¢˜åå­—
```

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230725214049575.png" alt="image-20230725214049575" style="zoom:33%;" />

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230725214102199.png" alt="image-20230725214102199" style="zoom:33%;" />



#### 4.å®‰è£…Fluem

ä¸€æ ·çš„è§£å‹æ“ä½œï¼ŒæŠŠæ–‡ä»¶åæ”¹ä¸€ä¸‹å³å¯ã€‚

ä¿®æ”¹ä¸€ä¸‹å®ƒçš„é…ç½®æ–‡ä»¶è®¾ç½®â€”â€”ä¿®æ”¹confç›®å½•ä¸‹çš„log4j2.xmlï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230725215513353.png" alt="image-20230725215513353" style="zoom:33%;" />

è®¾ç½®å¯åŠ¨ä½¿ç”¨Flumeæ—¶æ‰“å°æ—¥å¿—æ–‡ä»¶å†…å®¹ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ‰¾é”™ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230725215722851.png" alt="image-20230725215722851" style="zoom:33%;" />

åˆ†å‘åˆ°å„ä¸ªæœºå™¨ï¼š

```
xsync flume/
```



*æ³¨ï¼šï¼ˆäº†è§£ï¼‰ä¿®æ”¹/opt/module/flume/conf/flume-env.shæ–‡ä»¶å¯ä»¥é…ç½®Flumeå†…å­˜ï¼Œå¦‚æœæ˜¯æ•°æ®é‡å¾ˆå¤§ï¼Œå†…å­˜éœ€æ±‚å¾ˆå¤§ï¼Œå¯èƒ½è¦é…ç½®





#### 5.mysqlå®‰è£…

ç”±äºmysqlå·¥å…·åŒ…å¤šï¼Œæˆ‘ä»¬éœ€è¦å•ç‹¬åˆ›å»ºä¸€ä¸ªmysqlæ–‡ä»¶å¤¹ï¼Œç„¶åè§£å‹ï¼Œé‡å‘½åæ“ä½œä¸€æ ·ã€‚

```
 sudo mkdir mysql
```



- å¸è½½mysqlä¾èµ–

è™½ç„¶æœºå™¨ä¸Šæ²¡æœ‰è£…MySQLï¼Œä½†æ˜¯è¿™ä¸€æ­¥ä¸å¯å°‘

```
sudo yum remove mysql-libs
```



- é‡æ–°å®‰è£…ä¾èµ–

```
sudo yum install libaio
 sudo yum -y install autoconf
```



- åˆ‡æ¢åˆ°rootç”¨æˆ·ï¼ŒæŸ¥çœ‹å®‰è£…è„šæœ¬ï¼ˆ**æ³¨æ„æ˜¯æŸ¥çœ‹ï¼Œå®ƒå·²ç»æœ‰äº†**ï¼‰

**/opt/software/mysql/****ç›®å½•ä¸‹install_mysql.sh**:

```
#!/bin/bash
set -x
[ "$(whoami)" = "root" ] || exit 1
[ "$(ls *.rpm | wc -l)" = "7" ] || exit 1
test -f mysql-community-client-8.0.31-1.el7.x86_64.rpm && \
test -f mysql-community-client-plugins-8.0.31-1.el7.x86_64.rpm && \
test -f mysql-community-common-8.0.31-1.el7.x86_64.rpm && \
test -f mysql-community-icu-data-files-8.0.31-1.el7.x86_64.rpm && \
test -f mysql-community-libs-8.0.31-1.el7.x86_64.rpm && \
test -f mysql-community-libs-compat-8.0.31-1.el7.x86_64.rpm && \
test -f mysql-community-server-8.0.31-1.el7.x86_64.rpm || exit 1

# å¸è½½MySQL
systemctl stop mysql mysqld 2>/dev/null
rpm -qa | grep -i 'mysql\|mariadb' | xargs -n1 rpm -e --nodeps 2>/dev/null
rm -rf /var/lib/mysql /var/log/mysqld.log /usr/lib64/mysql /etc/my.cnf /usr/my.cnf

set -e
# å®‰è£…å¹¶å¯åŠ¨MySQL
yum install -y *.rpm >/dev/null 2>&1
systemctl start mysqld

#æ›´æ”¹å¯†ç çº§åˆ«å¹¶é‡å¯MySQL
sed -i '/\[mysqld\]/avalidate_password.length=4\nvalidate_password.policy=0' /etc/my.cnf
systemctl restart mysqld

# æ›´æ”¹MySQLé…ç½®
tpass=$(cat /var/log/mysqld.log | grep "temporary password" | awk '{print $NF}')
cat << EOF | mysql -uroot -p"${tpass}" --connect-expired-password >/dev/null 2>&1
set password='000000';
update mysql.user set host='%' where user='root';
alter user 'root'@'%' identified with mysql_native_password by '000000';
flush privileges;
EOF

```

- æ‰§è¡Œè„šæœ¬

```
 sh install_mysql.sh
```

æœ€ååˆ‡æ¢å›lchenç”¨æˆ·å³å¯



- è¿›å…¥mysqlå‘½ä»¤ï¼š

```
mysql -uroot -p000000
```

-p000000è¡¨ç¤ºå¯†ç æ˜¯6ä¸ª0

å¦‚å›¾ï¼šè¿›å…¥æˆåŠŸ

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230726154601370.png" alt="image-20230726154601370" style="zoom:33%;" />



é€€å‡ºå‘½ä»¤ï¼š

```
quit            é€€å‡ºmysql
exit            é€€å‡ºrootç”¨æˆ·
```







## å››.é¡¹ç›®å¼€å§‹ï¼ˆæ•°ä»“ç¯å¢ƒæ­å»ºï¼‰

### 1.æ•°æ®æ¨¡æ‹Ÿå’Œé‡‡é›†

æ•°æ®ï¼š

- ä¸šåŠ¡æ•°æ®
- ç”¨æˆ·æ—¥å¿—â€”â€”æ–°èƒ½æºæ±½è½¦çš„è¿è¡Œæ—¥å¿—

#### ï¼ˆ1ï¼‰æ•°æ®æ¨¡æ‹Ÿ

åœ¨/opt/moduleä¸­æ–°å»ºcar-dataç›®å½•ï¼Œå°†car-data-1.0.1-jar-with-dependencies.jar.jarä¸Šä¼ åˆ°æ”¹ç›®å½•ä¸­ï¼ˆè„šæœ¬åœ¨å­¦ä¹ èµ„æ–™mokeæ–‡ä»¶å¤¹ä¸­ï¼‰

**è„šæœ¬ä½¿ç”¨å‚æ•°å‘½ä»¤ï¼š**

```
java -jar car-data-1.0.1-jar-with-dependencies.jar
usage: å‚æ•°é”™è¯¯ï¼Œå¯ç”¨å‚æ•°åˆ—è¡¨å¦‚ä¸‹
-c,--count <arg>      æ¨¡æ‹Ÿå¤©æ•°ï¼Œ-1è¡¨ç¤ºæ— é™æ¨¡æ‹Ÿï¼Œé»˜è®¤ä¸ºæ— é™æ¨¡æ‹Ÿ
    -cars <arg>       æ¨¡æ‹Ÿè½¦è¾†æ•°ç›®ï¼Œ1-10000ï¼Œé»˜è®¤ä¸º100
    -d,--date <arg>       æ¨¡æ‹Ÿå¼€å§‹æ—¥æœŸ, æ ¼å¼ä¸ºâ€™yyyy-MM-ddâ€™, å¿…é¡»æŒ‡å®š
    -n,--username <arg>   ç»´åº¦æ•°æ®çš„JDBCç”¨æˆ·å, å¿…é¡»æŒ‡å®š
    -o,--output <arg>     æ¨¡æ‹Ÿæ•°æ®è¾“å‡ºç›®å½•ï¼Œé»˜è®¤ä¸º./data
    -p,--password <arg>   ç»´åº¦æ•°æ®çš„JDBCå¯†ç , å¿…é¡»æŒ‡å®š
    -u,--url <arg>        ç»´åº¦æ•°æ®çš„JDBC URL, å¿…é¡»æŒ‡å®š

```

å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤å»äº†è§£è¿™ä¸ªjaråŒ…çš„ä½¿ç”¨æ–¹æ³•ï¼š

```
java -jar car-data-1.0.1-jar-with-dependencies.jar
```



- å½“ç„¶æˆ‘ä»¬å…ˆè¦åˆ°mysqlæ•°æ®åº“ä¸­åˆ›å»ºæ•°æ®åº“

  è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨Navicatå¯è§†åŒ–è¿æ¥è™šæ‹Ÿæœºæ•°æ®åº“å·¥å…·ï¼ˆç½‘ä¸Šæ‰¾ç ´è§£ç‰ˆå°±è¡Œï¼‰

**è‹¥è¿æ¥æŠ¥é”™ï¼š**

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230726173035329.png" alt="image-20230726173035329" style="zoom:33%;" />

è§£å†³æ–¹æ¡ˆï¼š

åœ¨mysqlæ•°æ®è¡Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š

```
alter user 'root'@'%' identified with mysql_native_password by '000000';

flush privileges;
```

è¿æ¥æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230726173328395.png" alt="image-20230726173328395" style="zoom:33%;" />



- åˆ›å»ºä¸€ä¸ªåä¸º"car_data"çš„æ•°æ®åº“ï¼Œå¹¶æŒ‡å®šè¯¥æ•°æ®åº“ä½¿ç”¨UTF-8å­—ç¬¦é›†ï¼ˆutf8mb4ï¼‰å’Œä¸€èˆ¬çš„UTF-8æ’åºè§„åˆ™ï¼ˆutf8mb4_general_ciï¼‰ã€‚

```
mysql -uroot -p000000 -e"create database car_data charset utf8mb4 collate utf8mb4_general_ci"
```

å¦‚å›¾ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230726173556727.png" alt="image-20230726173556727" style="zoom:33%;" />

æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼Œç”Ÿæˆæ•°æ®ï¼šï¼ˆå³é”®å¤åˆ¶æ ‡ç­¾ï¼Œä¸è¦é€€å‡ºmysqlï¼‰

```
java -jar \
car-data-1.0.1-jar-with-dependencies.jar \
-c 1 \
-d 2023-07-01 \
-n root \
-p 000000 \
-u jdbc:mysql://hadoop102:3306/car_data

```

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230726174004050.png" alt="image-20230726174004050" style="zoom:33%;" />

**æŠ¥é”™ï¼š**

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230726174637021.png" alt="image-20230726174637021" style="zoom:33%;" />

æ³¨æ„è¦åœ¨cardataç›®å½•ä¸‹ï¼Œå¹¶èµ‹äºˆè¯¥æ–‡ä»¶å¤¹æƒé™ï¼Œå¦åˆ™å®ƒé€ ä¸å‡ºæ¥ç›®å½•ï¼š

```
sudo chmod 777 -R  æ–‡ä»¶å¤¹
```

**æˆåŠŸï¼š**

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230726174749299.png" alt="image-20230726174749299" style="zoom:33%;" />

åŒæ—¶æˆ‘ä»¬æŸ¥çœ‹å¯è§†åŒ–æ•°æ®åº“ï¼šï¼ˆç”Ÿæˆäº†ä¸¤å¼ è¡¨ï¼‰

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230726175050376.png" alt="image-20230726175050376" style="zoom:33%;" />



- åˆ›é€ è„šæœ¬ç”Ÿæˆæ•°æ®

ä»¥åæˆ‘ä»¬æƒ³åˆ›å»ºæ•°æ®éƒ½å¯ä»¥é€šè¿‡é‚£ä¸ªjaråŒ…åˆ›å»ºï¼Œä½†æ˜¯è¿™æ ·æ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘ä»¬æƒ³åˆ›å»ºä¸€ä¸ªè„šæœ¬ï¼Œä»¥æ•°æ®æ—¶é—´ä¸ºå‚æ•°ï¼Œæ–¹ä¾¿æˆ‘ä»¬ç”Ÿæˆæ•°æ®

å°±åœ¨lchen/binç›®å½•ä¸‹åˆ›å»ºlg.shï¼š

```
#!/bin/bash
if [ "$#" -ne 1 ]
then
echo "æ²¡æœ‰ä¼ å…¥æ—¥æœŸå‚æ•°ï¼"
exit 1
fi

java -jar \
/opt/module/car-data/car-data-1.0.1-jar-with-dependencies.jar \
-c 1 \
    -o /opt/module/car-data/data \
    -d "$1" \
    -n root \
    -p 000000 \
    -u jdbc:mysql://hadoop102:3306/car_data

```

ç„¶åèµ‹èƒ½ç»™è¿™ä¸ªè„šæœ¬æ–‡ä»¶ï¼š

```
sudo chmod 777 lg.sh
```

å°†è„šæœ¬å‘ç»™binç›®å½•æ–¹ä¾¿å…¨å±€å¯ç”¨

```
sudo cp lg.sh /bin/

sudo chmod 777 lg.sh
```

æˆ‘ä»¬å°†æ•°æ®åº“çš„è¡¨åˆ é™¤ï¼Œå†æŠŠdataè¿™ä¸ªæ–‡ä»¶å¤¹åˆ é™¤ï¼ˆè¿™æ ·æ•°æ®å°±å®Œå…¨å»é™¤äº†ï¼‰ã€‚ç„¶åç”¨è„šæœ¬é‡æ–°é€ ä¸€ä¸‹æ•°æ®ï¼š

```
cd /opt/module/car-data/

lg.sh 2023-07-26
```

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230726180919240.png" alt="image-20230726180919240" style="zoom:33%;" />

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230726180956197.png" alt="image-20230726180956197" style="zoom:33%;" />

#### ï¼ˆ2ï¼‰æ—¥å¿—æ•°æ®é‡‡é›†

æ•°æ®è·¯å¾„ï¼š

æ•°æ®â€”â€”>Flumeâ€”â€”>Kafkaâ€”â€”>Flumeâ€”â€”>HDFS

**Kafkaçš„ç›®çš„æ˜¯ä¸ºäº†å¢å¼ºæ‰©å±•æ€§ã€‚**

ä¸ºäº†ä»¥é˜²ä¸‡ä¸€ï¼Œæˆ‘é…ç»™flumeæ–‡ä»¶å¤¹æƒé™ï¼š

```
sudo chmod 777 flume/
```



- é…ç½®Flumeå·¥ä½œé…ç½®æ–‡ä»¶

1.åˆ›å»ºå·¥ä½œæ–‡ä»¶å¤¹

```
[lchen@hadoop102 flume]$ mkdir job
```

2.åˆ›å»ºè¿æ¥é…ç½®æ–‡ä»¶

```
[lchen@hadoop102 job]$ touch file_to_kafka.conf
```

åˆ©ç”¨finalshellå¯¹é…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼š

```
#å®šä¹‰ç»„ä»¶
a1.sources = r1
a1.channels = c1

#é…ç½®source(taildir source)
a1.sources.r1.type = TAILDIR           
a1.sources.r1.filegroups = f1
a1.sources.r1.filegroups.f1 = /opt/module/car-data/data/data.*
a1.sources.r1.positionFile = /opt/module/flume/car/taildir_position.json

#é…ç½®channel(kafka channel)
a1.channels.c1.type = org.apache.flume.channel.kafka.KafkaChannel
a1.channels.c1.kafka.bootstrap.servers = hadoop102:9092,hadoop103:9092,hadoop104:9092
a1.channels.c1.kafka.topic = car_data
a1.channels.c1.parseAsFlumeEvent = false
#ç»„è£… 
a1.sources.r1.channels = c1

```

1. a1.sources.r1.type = TAILDIR â€”â€”sources.ç»„ä»¶ç±»å‹
2. a1.sources.r1.filegroupsâ€”â€”è¡¨ç¤ºæ–‡ä»¶ç»„
3. a1.sources.r1.positionFileâ€”â€”æ–­ç‚¹ç»­é•¿æ–‡ä»¶ï¼ˆç”¨äºåŠ¨æ€è¯»å–ï¼‰
4. a1.channels.c1.typeâ€”â€”channelç»„ä»¶ç±»å‹
5. a1.channels.c1.kafka.bootstrap.serversâ€”â€”Kafkaç«¯å£
6. a1.channels.c1.kafka.topic â€”â€”å†™å…¥Kafkaå“ªä¸ªä¸»é¢˜
7. a1.channels.c1.parseAsFlumeEvent â€”â€”è®¾ç½®æ•°æ®ä¼ è¾“æ–¹å¼æ˜¯ä¸æ˜¯eventå¯¹è±¡ï¼ˆå¡«falseå› ä¸ºkafkaæ˜¯ä»¥å­—ç¬¦ä¸²æ¥è¯»å–æ•°æ®çš„è€Œä¸æ˜¯eventå¯¹è±¡ï¼‰



**æµ‹è¯•flumeæ˜¯å¦é‡‡é›†æ•°æ®å¹¶ä¸”è¿æ¥Kafkaï¼š**

å…ˆåˆ°lchen/binç›®å½•ä¸‹å¯åŠ¨kafka(åˆ©ç”¨è„šæœ¬):

```
[lchen@hadoop102 bin]$ ./kf.sh start
```

å»flumeç›®å½•ä¸‹å¯åŠ¨Fluemï¼Œæ ¹æ®é…ç½®æ–‡ä»¶é‡‡é›†æ•°æ®ï¼š

```
bin/flume-ng agent -n a1 -c conf/ -f job/file_to_kafka.conf
```

å¤åˆ¶hadoop102æ ‡ç­¾ï¼Œå¯åŠ¨ä¸€ä¸ªKafkaçš„æ¶ˆè´¹è€…ï¼ŒæŸ¥çœ‹æ˜¯å¦å·²ç»æ¥æ”¶æ•°æ®ï¼š

```
bin/kafka-console-consumer.sh --bootstrap-server hadoop102:9092 --topic car_data --from-beginning

```



flumeæ­£åœ¨è¯»å–æ•°æ®ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230727212045278.png" alt="image-20230727212045278" style="zoom:25%;" />

Kafkaæ¶ˆè´¹è€…æ¥æ”¶åˆ°æ•°æ®ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230727212513573.png" alt="image-20230727212513573" style="zoom:25%;" />

çœ‹åˆ°æ•°æ®æºæºä¸æ–­çš„æ‰“å°å³æˆåŠŸï¼



å¥½ï¼Œæˆ‘ä»¬åˆæ¥è®¾ç½®ä¸€ä¸ªflumeçš„å¯åŠ¨è„šæœ¬ï¼Œ**å› ä¸ºæˆ‘ä»¬ç”¨å‘½ä»¤å¼€å¯å®ƒå§‹ç»ˆä¼šåœ¨å‰å°æŒ‚èµ·ä¸èƒ½åŠ¨ï¼Œå¾ˆä¸æ–¹ä¾¿**

ä¸€æ ·çš„åœ¨lchen/binä¸‹

fl.sh:

```
#!/bin/bash
case $1 in
"start"){
echo " --------å¯åŠ¨hadoop102é‡‡é›†flume-------"
ssh hadoop102 "nohup /opt/module/flume/bin/flume-ng agent -n a1 -c /opt/module/flume/conf/ -f /opt/module/flume/job/file_to_kafka.conf >/dev/null 2>&1 &"
};; 
"stop"){
echo " --------åœæ­¢hadoop102é‡‡é›†flume-------"
ssh hadoop102 "ps -ef | grep file_to_kafka | grep -v grep |awk  '{print \$2}' | xargs -n1 kill -9 "
};;
esac

```

ç»™æƒé™ï¼š

```
sudo chmod 777 fl.sh
```



- ç¼–å†™æ¶ˆè´¹è€…flume

ä¹Ÿå°±æ˜¯ç¬¬äºŒä¸ªflumeï¼Œæˆ‘ä»¬é€šè¿‡å®ƒæŠŠæ•°æ®ä¸Šä¼ ç»™HDFSã€‚æˆ‘ä»¬åœ¨**hadoop104é‡Œé…ç½®æ¶ˆè´¹è€…flume**

cdåˆ°flumeç›®å½•ä¸‹ï¼šï¼ˆæœ€å¥½å…ˆç»™flumeæ–‡ä»¶å¤¹chmodä¸€ä¸‹ï¼‰

```
[lchen@hadoop104 module]$ cd flume/
[lchen@hadoop104 flume]$ mkdir job
[lchen@hadoop104 flume]$ cd job/
[lchen@hadoop104 job]$ touch kafka_to_hdfs.conf
```

åŒç†ï¼Œæˆ‘ä»¬ æ·»åŠ é…ç½®æ–‡ä»¶kafka_to_hdfs.confï¼šï¼ˆç”¨ä¸‰ä¸ªç»„ä»¶ï¼‰

```
#å®šä¹‰ç»„ä»¶
a1.sources=r1
a1.channels=c1
a1.sinks=k1

#é…ç½®source1
a1.sources.r1.type = org.apache.flume.source.kafka.KafkaSource
a1.sources.r1.kafka.bootstrap.servers = hadoop102:9092,hadoop103:9092,hadoop104:9092
a1.sources.r1.kafka.consumer.auto.offset.reset = earliest
a1.sources.r1.kafka.consumer.group.id = flume
a1.sources.r1.kafka.topics=car_data


#é…ç½®channel
a1.channels.c1.type = file
a1.channels.c1.checkpointDir = /opt/module/flume/checkpoint/behavior1
a1.channels.c1.dataDirs = /opt/module/flume/data/behavior1
a1.channels.c1.maxFileSize = 2146435071
a1.channels.c1.capacity = 1000000
a1.channels.c1.keep-alive = 6

#é…ç½®sink
a1.sinks.k1.type = hdfs
a1.sinks.k1.hdfs.path = /origin_data/car_data_full/%Y-%m-%d
a1.sinks.k1.hdfs.filePrefix = log
a1.sinks.k1.hdfs.round = false


a1.sinks.k1.hdfs.rollInterval = 30
a1.sinks.k1.hdfs.rollSize = 134217728
a1.sinks.k1.hdfs.rollCount = 0

#æ§åˆ¶è¾“å‡ºæ–‡ä»¶ç±»å‹
a1.sinks.k1.hdfs.fileType = CompressedStream
a1.sinks.k1.hdfs.codeC = gzip
#ç»„è£… 
a1.sources.r1.channels = c1
a1.sinks.k1.channel = c1

```

1. a1.channels.c1.typeâ€”â€”ç¼“å­˜ä½ç½®ï¼ˆé»˜è®¤æ˜¯å†…å­˜ï¼Œæˆ‘ä»¬æ”¹æˆç£ç›˜ä¹Ÿå°±æ˜¯fileï¼‰
2. a1.channels.c1.dataDirsâ€”â€”ç¼“å­˜å­˜å‚¨è·¯å¾„ï¼ˆæ³¨æ„ï¼šä¸€ä¸ªæœåŠ¡å™¨å¯èƒ½å¯åŠ¨å¤šä¸ªflumeæ•…è¯¥å±æ€§æœ€å¥½ç¼–å·ï¼Œå› ä¸ºå…¶ä»–é…ç½®æ–‡ä»¶ä¹Ÿè¦è®¾ç½®ï¼‰
3. a1.channels.c1.checkpointDirâ€”â€”ä¿è¯ä¸åŒç®¡é“ä¸åŒæ•°æ®
4. a1.channels.c1.keep-aliveâ€”â€”æ•°æ®ä¿å­˜æ—¶é—´
5. a1.channels.c1.capacityâ€”â€”æ•°æ®å®¹é‡ï¼ˆæ¡ï¼‰
6. a1.channels.c1.maxFileSize â€”â€”æ–‡ä»¶æœ€å¤§å¤§å°
7. a1.sinks.k1.hdfs.fileTypeâ€”â€”æ˜¯å¦å‹ç¼©
8. a1.sinks.k1.hdfs.codeCâ€”â€”å‹ç¼©æ ¼å¼



- æ·»åŠ Flumeæ‹¦æˆªå™¨

ä¸ºå•¥è¦æ·»åŠ æ‹¦æˆªå™¨ï¼Ÿ

ä¸ºäº†é¿å…æ•°æ®é£˜é€¸çš„é—®é¢˜â€”â€”ç”±äºæ²¡èƒ½åŠæ—¶å°†æ•°æ®è¾“é€åˆ°HDFSå¯¼è‡´æ—¶é—´å‡ºç°è½æˆï¼Œä»è€Œå¯¼è‡´æ—¶é—´ç´Šä¹±ï¼š

ä¾‹å¦‚ï¼š

æˆ‘1å·23ï¼š59ç”Ÿäº§æ•°æ®å¹¶ä¸”è¢«flume1é‡‡é›†ï¼Œä½†æ˜¯ç­‰æ•°æ®ä¼ è¾“åˆ°Flume2æ—¶å·²ç»åˆ°äº†2å¥½0ï¼š01åˆ†ã€‚è™½ç„¶æ–‡ä»¶ï¼ˆbodeyï¼‰è¿˜æ˜¯æ˜¾ç¤ºæ˜¯1å·æ•°æ®ï¼Œä½†æ˜¯Flumeå¤´ä¿¡æ¯(header)å´æ˜¾ç¤ºæ˜¯2å·



é¦–å…ˆæˆ‘ä»¬æ‰“å¼€IDEAï¼Œåˆ›å»ºmavené¡¹ç›®å¹¶ä¸”æ·»åŠ ä¾èµ–ï¼š

```
    <dependencies>
        <dependency>
            <groupId>org.apache.flume</groupId>
            <artifactId>flume-ng-core</artifactId>
            <version>1.10.1</version>
        </dependency>
    </dependencies>

```

ç„¶åæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹è®¾è®¡æ‹¦æˆªå™¨äº†ï¼š

```
public class Timestampinterceptor implements Interceptor {
    @Override
    public void initialize() {//åˆå§‹åŒ–

    }

    @Override
    public Event intercept(Event event) {
       try {//tryè¯­æ³•ç”¨äºæ•°æ®è¿‡æ»¤
           //å°†bodyçš„æ•°æ®æ—¶é—´æˆ³å†™å…¥å¤´ä¿¡æ¯ä¸­ï¼Œæä¾›ç»™HDFSä½¿ç”¨
           //å°†æ•°æ®å†™å…¥æ­£ç¡®çš„åˆ†åŒºä¸­   è§£å†³æ•°æ®é£˜é€¸é—®é¢˜
           Map<String, String> headers = event.getHeaders();//è·å–å¤´ä¿¡æ¯
           String log = new String(event.getBody(), StandardCharsets.UTF_8);//è·å–bodyä¿¡æ¯
           JsonParser jsonParser = new JsonParser();  //googleçš„å·¥å…·ï¼Œç”¨äºè§£æJSON
           JsonObject asJsonObject = jsonParser.parse(log).getAsJsonObject();//å°†æ•°æ®è§£ææˆjsonå¯¹è±¡
           String timestamp = asJsonObject.get("timestamp").getAsString();//è·å–æ—¶é—´æˆ³æ•°æ®å¹¶è½¬æ¢æˆstringç±»å‹
           //å†™å…¥headerä¸­
           headers.put("timestamp",timestamp);

           return event;
       }catch (Exception e){
           e.printStackTrace();//æ‰“å°å¼‚å¸¸
           return null;
       }
    }

    @Override
    public List<Event> intercept(List<Event> events) {
        Iterator<Event> iterator = events.iterator();
        while (iterator.hasNext()) {
            Event next = iterator.next();
            if (intercept(next)==null) {
                iterator.remove();
            }
        }
    return events;
    }

    @Override
    public void close() {//å…³é—­

    }

//ç¼–å†™é™æ€å†…éƒ¨ç±»ï¼Œè¿™æ ·æ‰èƒ½å’Œflumeå¯¹æ¥
    public static class Builder implements Interceptor.Builder{

    @Override
    public Interceptor build() {
        return new Timestampinterceptor();
    }

    @Override
    public void configure(Context context) {

    }
}


}
```

è¿™é‡Œæ¼”ç¤ºäº†ä¸€ä¸‹æ•°æ®è¿‡æ»¤çš„åšæ³•ï¼ˆå…¶å®æ²¡æœ‰è„æ•°æ®å°±å¯ä»¥ä¸ç”¨è¿‡æ»¤ï¼‰

å›åˆ°flumeé…ç½®æ–‡ä»¶ï¼Œæ·»åŠ é…ç½®ï¼š

```
a1.sources.r1.interceptors = i1
a1.sources.r1.interceptors.i1.type = flume.interceptor.Timestampinterceptor$Builder
```

1. a1.sources.r1.interceptorsâ€”â€”å£°æ˜æ‹¦æˆªå™¨
2. a1.sources.r1.interceptors.i1.typeâ€”â€”æ‹¦æˆªå™¨ç±»ï¼ˆå‚æ•°æ˜¯ç±»çš„è·¯å¾„ï¼Œå³é”®ç‚¹å‡»å¤åˆ¶å¼•ç”¨å³å¯ï¼‰



- æ‰“åŒ…æ‹¦æˆªå™¨åˆ°è™šæ‹Ÿæœº


<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230729164247845.png" alt="image-20230729164247845" style="zoom: 25%;" />

å®Œæˆåæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰“åŒ…å®Œæˆåçš„ä»£ç ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230729164404849.png" alt="image-20230729164404849" style="zoom:25%;" />

ä¸Šä¼ åˆ°hadoop104çš„flume/libä¸‹





- å¼€å§‹å°è¯•ä¸Šä¼ 

å¯åŠ¨Hadoop

```
./hdp.sh start
```

å¯åŠ¨flume

```
bin/flume-ng agent -c conf/ -f job/kafka_to_hdfs.conf  -n a1
```

è¿™é‡Œæˆ‘ä»¬é‡è§äº†ä¸€ä¸ªæŠ¥é”™ï¼ˆç‰ˆæœ¬é—®é¢˜ï¼‰

æ ¸å¿ƒå…³é”®æŠ¥é”™æ˜¯Unsupported major.minor version 52.0ã€‚ç»è¿‡æŸ¥è¯¢ï¼Œäº†è§£æ˜¯jdkç‰ˆæœ¬ä¸æ”¯æŒçš„åŸå› ï¼Œ[version](https://so.csdn.net/so/search?q=version&spm=1001.2101.3001.7020) 52.0å³jdk1.8çš„æ„æ€ã€‚å› ä¸ºflumeè§£æå™¨æ˜¯jdk1.8ç¼–è¯‘çš„ï¼Œè€ŒCDHé›†ç¾¤æ˜¯ä½¿ç”¨jdk1.7ï¼Œæ‰€ä»¥å¯¼è‡´æ— æ³•è°ƒç”¨ã€‚

**ä½†æ˜¯æˆ‘å‘ç°æˆ‘çš„è™šæ‹ŸæœºJavaç‰ˆæœ¬æœ¬æ¥å°±æ˜¯1.8çš„ï¼Œä»”ç»†ä¸€çœ‹åŸæ¥æ˜¯æˆ‘æœ¬åœ°çš„JDKæ˜¯1.9ç‰ˆæœ¬ï¼Œäºæ˜¯æˆ‘æŠŠ IDEAçš„mavenç‰ˆæœ¬æ”¹å˜ä¸º1.8å³å¯ï¼Œæ–¹æ³•å°±æ˜¯ä¿®æ”¹pomæ–‡ä»¶ï¼š**

```
<properties>
        <maven.compiler.source>1.8</maven.compiler.source>
        <maven.compiler.target>1.8</maven.compiler.target>
    </properties>
```



å¥½ï¼Œç”±äºæˆ‘é…ç½®Hadoopçš„æ—¶å€™ä¸€ä¸å°å¿ƒåœ¨102å’Œ103ä¸Šå…¨éƒ½é…äº†namenodeå¯¼è‡´102ä¸Šè®¿é—®ä¸äº†HDFSäº†ã€‚ä½†æ˜¯å¥½åƒå¹¶ä¸å½±å“æˆ‘çš„ä¼ è¾“ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230729173002135.png" alt="image-20230729173002135" style="zoom:33%;" />

æˆåŠŸï¼



- å°è£…flume2å·çš„å¯åŠ¨è„šæœ¬ï¼š

```
[lchen@hadoop102 bin]$ sudo vim f2.sh
```

æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```
#!/bin/bash
case $1 in
"start")
echo " --------å¯åŠ¨hadoop104æ—¥å¿—æ•°æ®flume-------"
ssh hadoop104 "nohup /opt/module/flume/bin/flume-ng agent -n a1 -c /opt/module/flume/conf -f /opt/module/flume/job/kafka_to_hdfs.conf >/dev/null 2>&1 &"
;;
"stop")
echo " --------åœæ­¢hadoop104æ—¥å¿—æ•°æ®flume-------"
ssh hadoop104 "ps -ef | grep kafka_to_hdfs | grep -v grep |awk '{print \$2}' | xargs -n1 kill"
;;
esac

```

æ·»åŠ æƒé™ï¼šï¼ˆä»¥åå°±å¯ä»¥è¿™æ ·å¯åŠ¨flume2äº†ï¼‰

```
[lchen@hadoop102 bin]$ sudo chmod 777 f2.sh 
```





### 2.ç»´åº¦æ•°æ®åŒæ­¥

- ç»´åº¦æ•°æ®çš„åŒæ­¥


1.å…¨é‡åŒæ­¥â€”â€”å°†æ¯å¤©çš„æ•°æ®å…¨éƒ¨æ”¾å…¥æ•°æ®ä»“åº“ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230729195815774.png" alt="image-20230729195815774" style="zoom:25%;" />

é€»è¾‘ç®€å•ä½†æ˜¯å…¶ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼Œæœ‰å¤§é‡é‡å¤çš„æ•°æ®ã€‚æ‰€ä»¥é€‚ç”¨äºå°å‹æ•°æ®



2.å¢é‡åŒæ­¥â€”â€”æ¯å¤©åªå°†æœ‰æ•°æ®å˜åŒ–/æ–°å¢çš„æ•°æ®åŒæ­¥åˆ°æ•°æ®ä»“åº“

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230729200120046.png" alt="image-20230729200120046" style="zoom:25%;" />

æ•ˆç‡å¾ˆé«˜ä½†æ˜¯é€»è¾‘å¤æ‚éœ€è¦å¯¹æ•°æ®å˜åŒ–è¿›è¡Œæ•´ç†



#### (1)DataXçš„ä½¿ç”¨

åŸç†ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230729203635499.png" alt="image-20230729203635499" style="zoom:25%;" />

å®‰è£…ä¸€æ ·ï¼Œæ‹–æ‹½ï¼Œè§£å‹ï¼Œæ”¹åå³å¯ã€‚

```
sudo chmod 777 ç›®å½•   //ç»™æƒé™
```

- è¿è¡Œæ¼”ç¤ºæ¡ˆä¾‹ï¼ŒæŸ¥çœ‹æ˜¯å¦å®‰è£…å®Œæˆ

å…ˆcdåˆ°datax

```
[lchen@hadoop102 datax]$ python bin/datax.py job/job.json 
```

è¿™æ ·è¾“å‡ºå³è¿è¡ŒæˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230730201749757.png" alt="image-20230730201749757" style="zoom:25%;" />



- ä½¿ç”¨datax

```
 python bin/datax.py   + jobç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶
```

è‡³äºé…ç½®æ–‡ä»¶æ€ä¹ˆä¹¦å†™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤æŸ¥çœ‹é…ç½®æ–‡ä»¶çš„æ¨¡æ¿ï¼š

```
python bin/datax.py -r mysqlreader -w hdfswriter
```

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230730202224535.png" alt="image-20230730202224535" style="zoom:25%;" />

å½“ç„¶è¿™ä¸ªäº†è§£ä¸€ä¸‹å°±è¡Œäº†ï¼Œä¸æ¨èç…§ç€ä»–çš„æ¨¡æ¿æ¥ã€‚æˆ‘ä»¬è¿˜æ˜¯çœ‹å®˜ç½‘å¥½äº›ï¼šhttps://github.com/alibaba/DataX/blob/master/README.md



ä¾‹å¦‚ï¼š

- é…ç½®ä¸€ä¸ªä»Mysqlæ•°æ®åº“åŒæ­¥æŠ½å–æ•°æ®åˆ°æœ¬åœ°çš„ä½œä¸š:

```
{
    "job": {
        "setting": {
            "speed": {
                 "channel": 3
            },
            "errorLimit": {
                "record": 0,
                "percentage": 0.02
            }
        },
        "content": [
            {
                "reader": {
                    "name": "mysqlreader",
                    "parameter": {
                        "username": "root",
                        "password": "root",
                        "column": [
                            "id",
                            "name"
                        ],
                        "splitPk": "db_id",
                        "connection": [
                            {
                                "table": [
                                    "table"
                                ],
                                "jdbcUrl": [
     "jdbc:mysql://127.0.0.1:3306/database"
                                ]
                            }
                        ]
                    }
                },
               "writer": {
                    "name": "streamwriter",
                    "parameter": {
                        "print":true
                    }
                }
            }
        ]
    }
}

```

- å†™å…¥HDFSï¼šï¼ˆåªå¤åˆ¶writeréƒ¨åˆ†å³å¯ï¼‰


```
"writer": {
                    "name": "hdfswriter",
                    "parameter": {
                        "defaultFS": "hdfs://xxx:port",
                        "fileType": "orc",
                        "path": "/user/hive/warehouse/writerorc.db/orcfull",
                        "fileName": "xxxx",
                        "column": [
                            {
                                "name": "col1",
                                "type": "TINYINT"
                            },
                            {
                                "name": "col2",
                                "type": "SMALLINT"
                            },
                            {
                                "name": "col3",
                                "type": "INT"
                            },
                            {
                                "name": "col4",
                                "type": "BIGINT"
                            },
                            {
                                "name": "col5",
                                "type": "FLOAT"
                            },
                            {
                                "name": "col6",
                                "type": "DOUBLE"
                            },
                            {
                                "name": "col7",
                                "type": "STRING"
                            },
                            {
                                "name": "col8",
                                "type": "VARCHAR"
                            },
                            {
                                "name": "col9",
                                "type": "CHAR"
                            },
                            {
                                "name": "col10",
                                "type": "BOOLEAN"
                            },
                            {
                                "name": "col11",
                                "type": "date"
                            },
                            {
                                "name": "col12",
                                "type": "TIMESTAMP"
                            }
                        ],
                        "writeMode": "append",
                        "fieldDelimiter": "\t",
                        "compress":"NONE"
                    }
                }
```

åˆå¹¶æ¨¡æ¿ï¼šï¼ˆæŠŠç¬¬ä¸€éƒ¨åˆ†writeréƒ¨åˆ†ç”¨ç¬¬äºŒéƒ¨åˆ†ä»£æ›¿ï¼‰

```
{
    "job": {
        "setting": {
            "speed": {
                 "channel": 3
            },
            "errorLimit": {
                "record": 0,
                "percentage": 0.02
            }
        },
        "content": [
            {
                "reader": {
                    "name": "mysqlreader",
                    "parameter": {
                        "username": "root",
                        "password": "000000",
                        "column": [
                            "id",
							"type_id",
                            "type",
                            "sale_type",
                            "trademark",
                            "company",
                            "seating_capacity",
                            "power_type",
                            "charge_type",
                            "category",
                            "weight_kg",
                            "warranty"
                        ],
                        "connection": [
                            {
                                "table": [
                                    "car_info"
                                ],
                                "jdbcUrl": [
     "jdbc:mysql://hadoop102/car_data"
                                ]
                            }
                        ]
                    }
                },
               "writer": {
                    "name": "hdfswriter",
                    "parameter": {
                    "hadoopConfig": {
                            "dfs.nameservices": "mycluster",
                            "dfs.namenode.rpc-address.mycluster.nn2": "hadoop103:8020",
                            "dfs.namenode.rpc-address.mycluster.nn1": "hadoop102:8020",
                            "dfs.client.failover.proxy.provider.mycluster": 			  "org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider", 
                            "dfs.ha.namenodes.mycluster": "nn1,nn2"
                        },

                        "defaultFS": "hdfs://mycluster",
                        "fileType": "text",
                        "path": "/test",
                        "fileName": "car_info",
                        "column": [
                           {
                                "name": "id",
                                "type": "string"
                            },
                            {
                                "name": "type_id",
                                "type": "string"
                            },
                            {
                                "name": "type",
                                "type": "string"
                            },
                            {
                                "name": "sale_type",
                                "type": "string"
                            },
                            {
                                "name": "trademark",
                                "type": "string"
                            },
                            {
                                "name": "company",
                                "type": "string"
                            },
                            {
                                "name": "seating_capacity",
                                "type": "bigint"
                            },
                            {
                                "name": "power_type",
                                "type": "string"
                            },
                            {
                                "name": "charge_type",
                                "type": "string"
                            },
                            {
                                "name": "category",
                                "type": "string"
                            },
                            {
                                "name": "weight_kg",
                                "type": "bigint"
                            },
                            {
                                "name": "warranty",
                                "type": "string"
                            }
                        ],
                        "writeMode": "append",
                        "fieldDelimiter": "\t",
                        "compress":"gzip"
                    }
                }
            }
        ]
    }
}

```

**ç›¸å…³å‚æ•°æ”¹å†™ï¼š**

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230731204539520.png" alt="image-20230731204539520" style="zoom: 33%;" />

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230731204734391.png" alt="image-20230731204734391" style="zoom:33%;" />



#### æ¡ˆä¾‹ï¼ˆé…ç½®æ–‡ä»¶å°±æ˜¯ä¸Šé¢é‚£ä¸ªï¼‰

ä¹‹å‰æˆ‘ä»¬ä¸æ˜¯åœ¨mysqlä¸­åˆ›å»ºäº†æ¨¡æ‹Ÿæ•°æ®çš„ä¸¤å¼ è¡¨å—ï¼Œç°åœ¨æˆ‘ä»¬é€šè¿‡DataxåŒæ­¥åˆ°HDFSä¸­.

***å°æŠ€å·§ï¼šæˆ‘ä»¬å¯ä»¥å³é”®è¡¨åâ€”â€”è½¬å‚¨SQLæ–‡ä»¶â€”â€”ä»…ç»“æ„â€”â€”æŠŠè¯¥æ–‡ä»¶ä¿å­˜åœ¨æŸä¸€ä½ç½®ï¼Œæ‰“å¼€å°±èƒ½å¤åˆ¶æ‰€æœ‰çš„å±æ€§åäº†ï¼Œä¸ç„¶ä¸€ä¸ªä¸€ä¸ªå†™å¾ˆéº»çƒ¦ã€‚**

1.åˆ›å»ºé…ç½®æ–‡ä»¶ï¼ŒæŠŠä¸Šé¢çš„å¤åˆ¶è¿›å»

```
[lchen@hadoop102 root]$ cd /opt/module/datax/
[lchen@hadoop102 datax]$ cd job/
[lchen@hadoop102 job]$ vim test.json
```

2.è¿è¡Œdataxï¼ˆzookeeperå’ŒHadoopè¦å…¨éƒ¨å¯åŠ¨ï¼‰

```
[lchen@hadoop102 datax]$ hadoop fs -mkdir /test
[lchen@hadoop102 datax]$ python bin/datax.py  job/test.json 
```

**æ³¨æ„dataxæ— æ³•åœ¨hdfsç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ•…ä¼ è¾“æ•°æ®å‰æˆ‘ä»¬è‡ªå·±è¦åˆ›å»º**

3.ä¼ è¾“æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230731211244681.png" alt="image-20230731211244681" style="zoom:25%;" />

æˆ‘ä»¬å»HDFSï¼ˆhttp://hadoop103:9870/explorer.html#/ï¼‰é‡Œç¡®è®¤ä¸€ä¸‹ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230731211358405.png" alt="image-20230731211358405" style="zoom:33%;" />

å¯è§†åŒ–é¡µé¢ç”±äºæ˜¯å‹ç¼©åŒ…gzæ ¼å¼æ— æ³•ç›´æ¥è¯»å–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡linuxå‘½ä»¤æŸ¥çœ‹å…¶ä¸­çš„æ•°æ®ï¼š

```
[lchen@hadoop102 datax]$ hadoop fs -text /test/*
```

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230731211645822.png" alt="image-20230731211645822" style="zoom:25%;" />





#### ï¼ˆ2ï¼‰Dataxçš„å‚æ•°ä½¿ç”¨

- QuerySQLModeï¼ˆQuerySQLæ¨¡å¼ï¼‰

å³**ä½¿ç”¨SQLè¯­è¨€é€‰æ‹©æ•°æ®ä¸Šä¼ **ï¼Œä¹‹å‰é…ç½®æ–‡ä»¶é‡Œçš„ç§°ä¹‹ä¸ºtableæ¨¡å¼æŒ‡å®šå±æ€§ä¸Šä¼ ã€‚å¦‚å›¾ä¾‹å­æ‰€ç¤ºï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230731212459007.png" alt="image-20230731212459007" style="zoom:25%;" />

- dataxä¼ å‚ï¼ˆâ­ï¼‰

è¿™ä¸ªä¼ å‚æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚

ä¾‹å­ï¼š

æˆ‘æ¯å¤©éƒ½æœ‰æ•°æ®ä»mysqlä¼ å…¥/åŒæ­¥åˆ°Hadoopï¼Œä¸å¯èƒ½ä¼ å…¥åŒä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚æ•…**æˆ‘çš„è·¯å¾„åº”è¯¥æä¾›ä¸€ä¸ªå˜é‡**ï¼Œæ¯å¤©çš„æ–‡ä»¶æ ¹æ®å˜é‡ä¼ å…¥å¯¹åº”æ–‡ä»¶å¤¹ã€‚

dataxé…ç½®æ–‡ä»¶ä¸­æˆ‘ä»¬çš„å†™å…¥è·¯å¾„è¿™ä¹ˆå†™ï¼š

```
"path": "/base_province/${dt}",
```

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å‘½ä»¤ä¼ å‚ï¼Œå°†æ•°æ®ä¼ å…¥å¯¹åº”æ–‡ä»¶å¤¹ï¼š

```
hadoop fs -mkdir /test/å‚æ•°                //å…ˆåˆ›å»ºä¼ å…¥çš„æ–‡ä»¶å¤¹
python bin/datax.py -p"-Ddt=å‚æ•°" job/test.json   //å°†æ•°æ®ä¼ å…¥å‚æ•°æ–‡ä»¶å¤¹ä¸­
```

å¦‚å›¾ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230802152530036.png" alt="image-20230802152530036" style="zoom:25%;" />

å®Œæˆï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230802152710595.png" alt="image-20230802152710595" style="zoom:25%;" />



- åŒæ­¥HDFSæ•°æ®åˆ°MySQLä¸­

åœ¨é¡¹ç›®å°¾éƒ¨å±•ç¤º



#### ï¼ˆ3ï¼‰Dataxç»´åº¦è¡¨åŒæ­¥ï¼ˆæ”¾åˆ°HDFSé‡Œï¼‰

æˆ‘ä»¬æŠŠé…ç½®æ–‡ä»¶åå­—æ”¹ä¸€ä¸‹â€”â€”car_info.jsonï¼ˆé‡Œé¢çš„å‚æ•°å˜å“ˆï¼‰

æ¯æ¬¡å†™å‘½ä»¤æŒºéº»çƒ¦çš„ï¼Œæˆ‘ä»¬ç¼–ä¸€ä¸ªè„šæœ¬ï¼šï¼ˆlchen/binç›®å½•ä¸‹ï¼‰

```
#!/bin/bash
if [ "$#" -ne 1 ]
then
echo "å‚æ•°é”™è¯¯ï¼"
exit 1
fi
targetdir="/origin_data/car_info_full/$1"
# ç¡®ä¿HDFSç›®å½•å­˜åœ¨ä¸”ä¸ºç©º
hadoop fs -rm -r "${targetdir}"
hadoop fs -mkdir -p "${targetdir}"

# æ‰§è¡ŒDataXä»»åŠ¡
/opt/module/datax/bin/datax.py /opt/module/datax/job/car_info.json -p"-Ddt=${targetdir}"
```

æ·»åŠ æƒé™ï¼š

```
chmod 777  è„šæœ¬
```

ä»¥åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è„šæœ¬æŠŠæ•°æ®ä»mysqlä¼ å…¥HDFSäº†

```
mysql_to_hdfs.sh + å‚æ•°
```

ç¬¬ä¸€æ¬¡è·‘ä¼šæŠ¥é”™ï¼Œæ²¡å…³ç³»ã€‚åªè¦HDFSé‡Œæœ‰å°±è¡Œï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230804213932207.png" alt="image-20230804213932207" style="zoom:33%;" />

**æ³¨æ„ç‚¹ï¼šä½ é‚£ä¸ªå‚æ•°ä¸¤ä¸ªæ–‡ä»¶å¿…é¡»ä¸€è‡´ã€‚ä¸ç„¶æä¸èµ·ï¼š**

![image-20230804215728377](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230804215728377.png)







### 3.æ•°æ®ä»“åº“

#### ï¼ˆ1ï¼‰ç›¸å…³æ¦‚å¿µ

- **æ•°æ®åº“è§„èŒƒåŒ–ï¼š**

æ˜¯ä½¿ç”¨ä¸€ç³»åˆ—èŒƒå¼è®¾è®¡æ•°æ®åº“ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†å‡å°‘æ•°æ®å†—ä½™ï¼Œéœ€è¦éµä»ä¸åŒèŒƒå¼ã€‚

å…³ç³»å‹æ•°æ®åº“ä¸€ä¸ª6ç§èŒƒå¼ï¼Œå¦‚1NF,2NF,3NFç­‰ã€‚èŒƒå¼çº§åˆ«è¶Šé«˜æ•°æ®å†—ä½™è¶Šä½ã€‚

***æ³¨æ„ï¼šèŒƒå¼ä¹‹é—´æ˜¯é€’è¿›çš„å…³ç³»ï¼Œè¦æ»¡è¶³åé¢çš„èŒƒå¼ä½ éœ€è¦å…ˆæ»¡è¶³å‰é¢çš„èŒƒå¼ã€‚**



- **ä¸‰èŒƒå¼ï¼š**

1. ç¬¬ä¸€èŒƒå¼â€”â€”**å±æ€§ä¸å¯åˆ‡å‰²**

ä¾‹å¦‚ï¼š

| å•†å“    | å•†å®¶id |
| ------- | ------ |
| 5å°ç”µè„‘ | xxxx   |

å…¶ä¸­å•†å“å¯ä»¥åˆ‡å‰²ä¸º5å°+ç”µè„‘ï¼ˆåŒ…å«ä¸¤ä¸ªä¿¡æ¯ï¼‰ã€‚æ•…è¯¥è¡¨æ ¼ä¸ç¬¦åˆç¬¬ä¸€èŒƒå¼

ä¸‹é¢è¿™å¼ å°±ç¬¦åˆäº†ï¼š

| å•†å“ | æ•°é‡ | å•†å®¶id |
| ---- | ---- | ------ |
| ç”µè„‘ | 5    | xxxxxx |



2.ç¬¬äºŒèŒƒå¼â€”â€”**ä¸å­˜åœ¨éƒ¨åˆ†å‡½æ•°ä¾èµ–**

ä»€ä¹ˆæ˜¯å‡½æ•°ä¾èµ–ï¼Ÿ

æŒ‡çš„æ˜¯**éä¸»é”®çš„ä»»æ„ä¸€åˆ—ä¸ä¸»é”®ä¹‹é—´çš„å…³ç³»**

**å®Œå…¨å‡½æ•°ä¾èµ–â€”â€”ä»»æ„ä¸»é”®å’Œåœ¨ä¸€èµ·èƒ½æ¨å‡ºéä¸»é”®ï¼ˆä¾‹å¦‚é€šè¿‡å­¦å·+è¯¾ç¨‹æ¨å‡ºåˆ†æ•°ï¼‰**

**éƒ¨åˆ†å‡½æ•°ä¾èµ–â€”â€”ä¸éœ€è¦æ‰€æœ‰ä¸»é”®å°±èƒ½æ¨å‡ºéä¸»é”®ï¼ˆä¾‹å¦‚é€šè¿‡å­¦å·æ¨å‡ºå§“åï¼‰**

ä¸¾ä¸ªæ —å­ï¼š

| å­¦å·ï¼ˆä¸»é”®ï¼‰ | å§“å | ç§‘ç›®ï¼ˆä¸»é”®ï¼‰ | åˆ†æ•° |
| ------------ | ---- | ------------ | ---- |
| 110          | é¾™   | æ•°å­¦         | 150  |
| 111          | è›‡   | æ•°å­¦         | 150  |
| 112          | è™   | ç‰©ç†         | 150  |

ä¸Šé¢çš„è¡¨å°±ä¸ç¬¦åˆç¬¬äºŒèŒƒå¼ï¼Œå› ä¸ºå­˜åœ¨éƒ¨åˆ†å‡½æ•°ä¾èµ–ï¼Œå¯é€šè¿‡å­¦å·â€”â€”æ¨å‡ºå§“åã€‚

**æƒ³è¦å®ç°ç¬¬äºŒèŒƒå¼åªéœ€è¦æŠŠè¿™ä¸ªè¡¨æ‹†ç¢å°±è¡Œäº†ï¼ˆå³æŠŠç¬¦åˆå®Œå…¨å‡½æ•°ä¾èµ–çš„åˆ—æ‹†å‡ºæ¥ï¼ŒæŠŠä¸»é”®å†™ä¸Šï¼‰**ï¼Œå¦‚ä¸‹å›¾å°±ç¬¦åˆç¬¬äºŒèŒƒå¼ï¼š

| å­¦å·ï¼ˆä¸»é”®ï¼‰ | ç§‘ç›®ï¼ˆä¸»é”®ï¼‰ | åˆ†æ•° |
| ------------ | ------------ | ---- |
| 110          | æ•°å­¦         | 150  |
| 111          | æ•°å­¦         | 150  |
| 112          | ç‰©ç†         | 150  |





3.ç¬¬ä¸‰èŒƒå¼â€”â€”**ä¸èƒ½å­˜åœ¨ä¼ é€’å‡½æ•°ä¾èµ–**

**ä»€ä¹ˆæ˜¯ä¼ é€’å‡½æ•°ä¾èµ–ï¼Ÿâ€”â€”ä¸»é”®å’Œåˆ—åæ˜¯å¤šå¯¹ä¸€çš„å…³ç³»ï¼Œç„¶åè¿™ä¸ªåˆ—åå’Œå¦ä¸€åˆ—æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»**

ä¾‹å¦‚ï¼š

å­¦å·ï¼ˆä¸»é”®ï¼‰â€”â€”å¯ä»¥æ¨å‡ºå­¦é™¢ã€‚ä½†æ˜¯å­¦é™¢ä¸èƒ½æ¨å‡ºå­¦å·ã€‚

å­¦é™¢â€”â€”å¯ä»¥æ¨å‡ºç³»ä¸»ä»»ï¼Œä½†æ˜¯ç³»ä¸»ä»»ä¹Ÿä¸èƒ½æ¨å‡ºå­¦å·ã€‚

å¦‚å›¾ï¼š

| å­¦å·ï¼ˆä¸»é”®ï¼‰ | åå­— | å­¦é™¢   | ç³»ä¸»ä»» |
| ------------ | ---- | ------ | ------ |
| 10201        | æ˜Ÿ   | è®¡ç®—æœº | ç‹     |
| 10202        | å¤œ   | ç»ç®¡   | é™ˆ     |

ä¸€ä¸ªå­¦é™¢å¯¹åº”å¤šä¸ªå­¦å·ï¼Œå¯¹åº”ä¸€ä¸ªç³»ä¸»ä»»ã€‚

**æ€ä¹ˆå˜åŒ–æˆæ»¡è¶³ç¬¬ä¸‰èŒƒå¼â€”â€”æŠŠä¼ é€’å‡½æ•°ä¾èµ–çš„åˆ—æ‹†å¼€ï¼š**

| å­¦å·  | å§“å | å­¦é™¢   |
| ----- | ---- | ------ |
| 10201 | æ˜Ÿ   | è®¡ç®—æœº |
| 10202 | å¤œ   | ç»ç®¡   |

å’Œ

| å­¦é™¢   | ç³»ä¸»ä»» |
| ------ | ------ |
| è®¡ç®—æœº | ç‹     |
| ç»ç®¡   | é™ˆ     |





#### ï¼ˆ2ï¼‰æ•°æ®ä»“åº“å»ºæ¨¡ç†è®ºï¼š

- ERæ¨¡å‹â€”â€”å®ä½“å…³ç³»æ¨¡å‹ï¼ˆå°±æ˜¯ä¸Šé¢çš„èŒƒå¼ï¼‰

å°†å¤æ‚çš„æ•°æ®æŠ½è±¡ä¸ºä¸¤ä¸ªæ¦‚å¿µâ€”â€”å®ä½“å’Œå…³ç³»ã€‚å®ä½“è¡¨ç¤ºä¸€ä¸ªå¯¹è±¡ï¼Œä¾‹å¦‚å­¦ç”Ÿï¼Œç­çº§ã€‚å…³ç³»æ˜¯æŒ‡ä¸¤ä¸ªå®ä½“ä¹‹é—´çš„å…³ç³»ï¼Œä¾‹å¦‚å­¦ç”Ÿä¸ç­çº§ä¹‹é—´çš„ä»å±å…³ç³»



- ç»´åº¦æ¨¡å‹


å°†å¤æ‚çš„ä¸šåŠ¡é€šè¿‡äº‹å®å’Œç»´åº¦ä¸¤ä¸ªæ¦‚å¿µå‘ˆç°ã€‚

è¯´äººè¯â€”â€”å‚ä¸è®¡ç®—çš„åˆ—æ”¾å…¥äº‹å®è¡¨ï¼Œä¸å‚ä¸è®¡ç®—çš„åˆ—æ”¾å…¥ç»´åº¦è¡¨

*æ³¨ï¼šä¸šåŠ¡è¿‡ç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºä¸€ä¸ªä¸ªä¸å¯æ‹†åˆ†çš„è¡Œä¸ºäº‹ä»¶ï¼Œä¾‹å¦‚ä¸‹å•ï¼Œä»˜æ¬¾ï¼ŒåŠ è´­ç­‰éƒ½æ˜¯ä¸šåŠ¡è¿‡ç¨‹ã€‚





#### ï¼ˆ3ï¼‰ç»´åº¦æ¨¡å‹äº‹å®è¡¨å’Œç»´åº¦è¡¨çš„ä»‹ç»

äº‹å®è¡¨ï¼š

å»ºæ¨¡çš„æ ¸å¿ƒï¼Œç‰¹ç‚¹æ˜¯ç»†é•¿ï¼Œåˆ—æ¯”è¾ƒå°‘ï¼ˆ**å› ä¸ºè¡¨è¿°ä¿¡æ¯éƒ½åœ¨ç»´åº¦è¡¨ï¼Œå®ƒåªéœ€è¦å­˜å‚¨id**ï¼‰ï¼Œä½†æ˜¯è¡Œæ¯”è¾ƒå¤šï¼Œè¡Œçš„å¢é€Ÿæ¯”è¾ƒå¿«ã€‚

äº‹å®è¡¨å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š

- äº‹åŠ¡äº‹å®è¡¨ï¼ˆæœ€å¸¸ç”¨ï¼‰

è®¾è®¡æµç¨‹ï¼š

1. é€‰æ‹©ä¸šåŠ¡è¿‡ç¨‹ï¼ˆä¾‹å¦‚ä¸‹å•ï¼Œä»˜æ¬¾ç­‰ï¼‰
2. å£°æ˜ç²’åº¦ï¼ˆå°±æ˜¯ç²¾ç¡®çš„è¡¨ç¤ºæ¯è¡Œæ•°æ®è¡¨ç¤ºçš„å•¥ï¼Œå°½å¯èƒ½é€‰æ‹©æœ€ç»†ç²’åº¦ï¼‰
3. ç¡®è®¤ç»´åº¦
4. ç¡®è®¤äº‹å®

- å‘¨æœŸå¿«ç…§äº‹å®è¡¨
- ç´¯è®¡å¿«ç…§äº‹å®è¡¨





ç»´åº¦è¡¨ï¼š

æ˜¯ä¸šåŠ¡è¿‡ç¨‹æ‰€å¤„çš„ç¯å¢ƒã€‚

è®¾è®¡æ­¥éª¤ï¼š

1. ç¡®å®šç»´åº¦è¡¨
2. ç¡®å®šä¸»ç»´è¡¨å’Œç›¸å…³ç»´è¡¨
3. ç¡®å®šç»´åº¦å±æ€§





#### ï¼ˆ4ï¼‰æ­å»ºæ•°æ®ä»“åº“è¿è¡Œç¯å¢ƒ

- å®‰è£…éƒ¨ç½²Hive

ä¸€æ ·çš„ï¼Œ**æ‹–æ‹½ï¼Œè§£å‹ï¼Œæ”¹åï¼Œèµ‹æƒ**

ç„¶åæˆ‘ä»¬é…ç½®ç¯å¢ƒå˜é‡ï¼š

```
sudo vim /etc/profile.d/my_env.sh
```

æ·»åŠ ä»¥ä¸‹ä¿¡æ¯ï¼š

```
#HIVE_HOME
export HIVE_HOME=/opt/module/hive
export PATH=$PATH:$HIVE_HOME/bin
```

æŠŠå®ƒåˆ†å‘ä¸€ä¸‹ï¼š

```
sudo /home/lchen/bin/xsync /etc/profile.d/my_env.sh 
```

ç„¶åsourceä¸€ä¸‹ï¼š

```
[lchen@hadoop102 module]$ source /etc/profile.d/my_env.sh 
```

è§£å†³jaråŒ…å†²çªï¼š

```
[lchen@hadoop102 hive]$ mv lib/log4j-slf4j-impl-2.17.1.jar lib/log4j-slf4j-impl-2.17.1.jar.bak
```



- æŠŠhiveå…ƒæ•°æ®é…ç½®åˆ°mysql

æ·»åŠ mysqlå–ç¬¬

```
[lchen@hadoop102 hive]$ sudo cp /opt/software/mysql/mysql-connector-j-8.0.31.jar lib/
```

ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š

```
[lchen@hadoop102 hive]$ vim conf/hive-site.xml
```

æ–‡ä»¶é‡Œå†™å…¥å¦‚ä¸‹å†…å®¹ï¼š

```
<?xml version="1.0"?>
<?xml-stylesheet type="text/xsl" href="configuration.xsl"?>
<configuration>
    <!--é…ç½®Hiveä¿å­˜å…ƒæ•°æ®ä¿¡æ¯æ‰€éœ€çš„ MySQL URLåœ°å€-->
    <property>
        <name>javax.jdo.option.ConnectionURL</name>
        <value>jdbc:mysql://hadoop102:3306/metastore?useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;allowPublicKeyRetrieval=true</value>
    </property>

    <!--é…ç½®Hiveè¿æ¥MySQLçš„é©±åŠ¨å…¨ç±»å-->
    <property>
        <name>javax.jdo.option.ConnectionDriverName</name>
        <value>com.mysql.cj.jdbc.Driver</value>
    </property>

    <!--é…ç½®Hiveè¿æ¥MySQLçš„ç”¨æˆ·å -->
    <property>
        <name>javax.jdo.option.ConnectionUserName</name>
        <value>root</value>
    </property>

    <!--é…ç½®Hiveè¿æ¥MySQLçš„å¯†ç  -->
    <property>
        <name>javax.jdo.option.ConnectionPassword</name>
        <value>000000</value>
    </property>

    <property>
        <name>hive.metastore.warehouse.dir</name>
        <value>/user/hive/warehouse</value>
    </property>

    <property>
        <name>hive.metastore.schema.verification</name>
        <value>false</value>
    </property>

    <property>
        <name>hive.metastore.event.db.notification.api.auth</name>
        <value>false</value>
    </property>
</configuration>

```



- å¯åŠ¨hive

å¤åˆ¶æ ‡ç­¾ï¼Œç™»é™†mysqlï¼š

```
 mysql -uroot -p000000
 æ–°å»ºhiveæ•°æ®åº“ï¼š
 mysql> create database metastore;
```

åˆå§‹åŒ–hiveå…ƒæ•°æ®ï¼šï¼ˆå‘½ä»¤è¡Œæ‰§è¡Œï¼‰

```
schematool -initSchema -dbType mysql -verbose
```

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230802173313694.png" alt="image-20230802173313694" style="zoom:33%;" />

æˆ‘ä»¬å¯ä»¥åˆ°mysqlå¯è§†åŒ–å·¥å…·ä¸­æŸ¥çœ‹ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230802173410889.png" alt="image-20230802173410889" style="zoom:25%;" />

ä¿®æ”¹å…ƒæ•°æ®å­—ç¬¦é›†ï¼Œé¿å…ä¹±ç ç°è±¡ï¼š

é¦–å…ˆæ¥åˆ°åˆšåˆšåˆ›å»ºçš„æ•°æ®åº“ï¼ˆmetastoreï¼‰ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230802173907724.png" alt="image-20230802173907724" style="zoom:25%;" />

```
å­—æ®µæ³¨é‡Šï¼š
mysql> alter table metastore.COLUMNS_V2 modify column COMMENT varchar(256) character set utf8mb4;

è¡¨æ³¨é‡Šï¼š
mysql> alter table metastore.TABLE_PARAMS modify column PARAM_VALUE mediumtext character set utf8mb4;

æ¨å‡ºmysqlï¼š
mysql> quit;
```



- å¯åŠ¨hiveå®¢æˆ·ç«¯

```
[lchen@hadoop102 hive]$ hive
```

æ‰§è¡Œå‘½ä»¤æŸ¥çœ‹æ•°æ®åº“ï¼Œè‹¥èƒ½å±•ç¤ºåˆ™æ²¡æœ‰é—®é¢˜ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230802175854947.png" alt="image-20230802175854947" style="zoom:33%;" />





- æ›¿æ¢Hiveå¼•æ“

Hiveçš„é»˜è®¤å¼•æ“æ˜¯MRï¼Œé€Ÿåº¦å¾ˆæ…¢ï¼Œæˆ‘ä»¬æ›¿æ¢æˆspark

é‚£ä¹ˆå°±æœ‰ä¸¤ç§ç”¨æ³•ï¼š

1. Hive on spark ï¼ˆè¯­æ³•è¿˜æ˜¯ç”¨HQLï¼Œä¸è¿‡åº•å±‚èµ°çš„æ˜¯sparkRDDè®¡ç®—ï¼‰
2. spark on hive ï¼ˆè¯­æ³•èµ°çš„æ˜¯spark sqlè¯­æ³•ï¼‰

æœ¬é¡¹ç›®ç”¨çš„æ˜¯Hive on Spark





ä¸Šä¼ è§£å‹sparkã€‚

ç„¶åä¿®æ”¹å…¶ä¸­çš„sparkç¯å¢ƒé…ç½®æ–‡ä»¶ï¼š

```
[lchen@hadoop102 spark]$ sudo vim conf/spark-env.sh.template 
```

åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ è¿™å¥è¯ï¼š

```
export SPARK_DIST_CLASSPATH=$(hadoop classpath)
```

ä¿®æ”¹æ–‡ä»¶åï¼Œå»æ‰åç¼€ä½¿å…¶ç”Ÿæ•ˆï¼š

```
[lchen@hadoop102 conf]$ sudo mv spark-env.sh.template spark-env.sh
```



é…ç½®sparkç¯å¢ƒå˜é‡ï¼š

```
[lchen@hadoop102 conf]$ sudo vim /etc/profile.d/my_env.sh 
```

æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```
# SPARK_HOME
export SPARK_HOME=/opt/module/spark
export PATH=$PATH:$SPARK_HOME/bin

```

sourceä½¿å…¶ç”Ÿæ•ˆï¼š

```
[lchen@hadoop102 conf]$ source /etc/profile.d/my_env.sh 
```



åœ¨hiveé‡Œé¢åˆ›å»ºsparké…ç½®æ–‡ä»¶ï¼š

```
vim /opt/module/hive/conf/spark-defaults.conf
```

æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```
spark.master                yarn

spark.eventLog.enabled          true

spark.eventLog.dir            hdfs://mycluster/spark-history

spark.executor.memory          1g

spark.driver.memory           1g
```

åœ¨HDFSä¸­åˆ›å»ºæ—¥å¿—æ–‡ä»¶ï¼š

```
 hadoop fs -mkdir /spark-history
```



å‘HDFSä¸Šä¼ sparkçº¯å‡€ç‰ˆçš„jaråŒ…ï¼š

è¯´æ˜ï¼š

1. ä½¿ç”¨sparkçº¯å‡€ç‰ˆçš„jaråŒ…ï¼Œä¸åŒ…å«Hadoopå’Œhiveçš„ç›¸å…³ä¾èµ–ï¼Œèƒ½é¿å…ä¾èµ–å†²çª
2. hiveä»»åŠ¡ç”±sparkæ‰§è¡Œï¼Œèµ„æºç”±yarnè°ƒåº¦ï¼Œè¯¥ä»»åŠ¡ä¹Ÿå¯èƒ½åˆ†é…åœ¨é›†ç¾¤ä»»æ„èŠ‚ç‚¹ï¼Œæ‰€ä»¥sparkä¾èµ–è¦éœ€è¦ä¸Šä¼ åˆ°Hadoopé›†ç¾¤è·¯å¾„ï¼Œè¿™æ ·ä»»ä½•èŠ‚ç‚¹éƒ½èƒ½åˆ°ã€‚

```
hadoop fs -mkdir /spark-jars
```

ä¸Šä¼ sparkç›¸å…³jaråŒ…ï¼š

```
[lchen@hadoop102 conf]$ cd /opt/module/spark/jars/
[lchen@hadoop102 jars]$ hadoop fs -put ./* /spark-jars
```



ç°åœ¨å°±å¯ä»¥æ›¿æ¢sparkå¼•æ“äº†ï¼š

```
[lchen@hadoop102 jars]$ cd /opt/module/hive/
[lchen@hadoop102 hive]$ sudo vim conf/hive-site.xml 
```

åœ¨æœ«å°¾ä½ç½®æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```
<!--Sparkä¾èµ–ä½ç½®ï¼ˆæ³¨æ„ï¼šç«¯å£å·8020å¿…é¡»å’Œnamenodeçš„ç«¯å£å·ä¸€è‡´ï¼‰-->
<property>
    <name>spark.yarn.jars</name>
    <value>hdfs://mycluster/spark-jars/*</value>
</property>
  
<!--Hiveæ‰§è¡Œå¼•æ“-->
<property>
    <name>hive.execution.engine</name>
    <value>spark</value>
</property>

```

æµ‹è¯•ä¸€ä¸‹æ›¿æ¢æ˜¯å¦æˆåŠŸï¼š

è¿›å…¥æœ¬åœ°å®¢æˆ·ç«¯ï¼š

```
hive
```

åˆ›å»ºä¸€å¼ æµ‹è¯•è¡¨å¹¶ä¸”æ’å…¥æ•°æ®ï¼š

```
create table student(id int, name string);
insert into table student values(1,'abc');           è¿™å°±æ˜¯ä¸€ä¸ªsparkä»»åŠ¡
```

å‡ºç°ä¸‹é¢å†…å®¹å³æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230803153644887.png" alt="image-20230803153644887" style="zoom:25%;" />

æˆ‘ä»¬å¯ä»¥åœ¨yarnä¸Šç›‘æ§åˆ°è¯¥ä»»åŠ¡ï¼šhttp://hadoop102:8088/cluster

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230803154034148.png" alt="image-20230803154034148" style="zoom:25%;" />





- yarnçš„ç¯å¢ƒé…ç½®

å¼•è¨€ï¼š

æˆ‘ä»¬åŒæ—¶æ‰“å¼€ä¸¤ä¸ªhiveå®¢æˆ·ç«¯ï¼Œæ‰§è¡Œä¸Šé¢çš„å‘½ä»¤ï¼Œæˆ‘ä»¬å‘ç°å…¶ä¸­ä¸€ä¸ªsparkä»»åŠ¡ä¸€ç›´å¤„äºâ€œæäº¤â€çŠ¶æ€ï¼Œæ— æ³•å®Œæˆã€‚

è¿™æ˜¯å› ä¸ºï¼š

å®¹é‡è°ƒåº¦å™¨å¯¹æ¯ä¸ªèµ„æºé˜Ÿåˆ—ä¸­åŒæ—¶è¿è¡Œçš„Application Masterå ç”¨çš„èµ„æºè¿›è¡Œäº†é™åˆ¶ï¼Œè¯¥é™åˆ¶é€šè¿‡yarn.scheduler.capacity.maximum-am-resource-percentå‚æ•°å®ç°ï¼Œå…¶é»˜è®¤å€¼æ˜¯0.1ï¼Œè¡¨ç¤ºæ¯ä¸ªèµ„æºé˜Ÿåˆ—ä¸ŠApplication Masteræœ€å¤šå¯ä½¿ç”¨çš„èµ„æºä¸ºè¯¥é˜Ÿåˆ—æ€»èµ„æºçš„10%ï¼Œç›®çš„æ˜¯é˜²æ­¢å¤§éƒ¨åˆ†èµ„æºéƒ½è¢«Application Masterå ç”¨ï¼Œè€Œå¯¼è‡´Map/Reduce Taskæ— æ³•æ‰§è¡Œã€‚

æˆ‘ä»¬å›åˆ°yarnä¸Šæ¥çœ‹ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230803154751134.png" alt="image-20230803154751134" style="zoom:25%;" />



è§£å†³æ–¹æ¡ˆï¼š

ä¿®æ”¹/opt/module/hadoop/etc/hadoop/capacity-scheduler.xmlæ–‡ä»¶ï¼š

```
[lchen@hadoop102 hive]$ cd /opt/module/hadoop/etc/hadoop/
[lchen@hadoop102 hadoop]$ sudo vim capacity-scheduler.xml 
```

ä¿®æ”¹å‚æ•°ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230803155238359.png" alt="image-20230803155238359" style="zoom:25%;" />

åˆ†å‘ä¸€ä¸‹è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼š

```
[lchen@hadoop102 hadoop]$ xsync capacity-scheduler.xml 
```

**ç„¶åé‡å¯hadoop**





- è¿æ¥datagrip


é¦–å…ˆåœ¨hiveæ–‡ä»¶å¤¹å¯åŠ¨hiveserver2ï¼š

```
[lchen@hadoop102 hive]$ hiveserver2
```

åœ¨datagripé‡Œè¿æ¥Hadoop102æœºå™¨

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230804085640726.png" alt="image-20230804085640726" style="zoom:33%;" />

è¿æ¥å®Œæˆä¹‹åï¼Œå¯èƒ½è™šæ‹Ÿæœºè¿™è¾¹ä¼šæŠ¥ä»¥ä¸‹å¼‚å¸¸ï¼Œä¸ç”¨ç®¡ä»–ã€‚è¿™æ˜¯æœ€æ–°ç‰ˆæœ¬æ²¡æœ‰æ‰€æœ‰åŠŸèƒ½å¯¼è‡´çš„ã€‚

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230804085841681.png" alt="image-20230804085841681" style="zoom:25%;" />

è¿˜æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼Œhiveserver2åå°é¢‘ç¹å‡ºç°OOMï¼ˆå†…å­˜æº¢å‡ºçš„å¼‚å¸¸ï¼‰ã€‚è¿™æ˜¯å› ä¸ºhiveé»˜è®¤å†…å­˜åªæœ‰256Mï¼Œä¸å¤Ÿã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ”¹ä¸€ä¸‹ï¼š

```
[lchen@hadoop102 root]$ cd /opt/module/hive/
[lchen@hadoop102 hive]$ cd conf/
[lchen@hadoop102 conf]$ sudo mv hive-env.sh.template  hive-env.sh     ä¿®æ”¹åç¼€æ¿€æ´»è¯¥æ–‡ä»¶
[lchen@hadoop102 conf]$ sudo vim hive-env.sh 
```

æŠŠè®¾ç½®å†…å®¹çš„æ³¨é‡Šè§£äº†ï¼Œå¦‚å›¾å¾—åˆ°ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230804090341973.png" alt="image-20230804090341973" style="zoom: 25%;" />

é‡å¯hiveserver2

```
hiveserver2
```



è¿˜æœ‰ä¸€ä¸ªåœ°æ–¹æˆ‘ä»¬éœ€è¦æå‰ä¿®æ”¹ï¼š

Hiveè¡¨çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–å™¨ç”¨æ¥è§£æJSONæ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦**åœ¨hive-site.xmlä¸­æ·»åŠ é…ç½®ï¼š**

åœ¨æœ€åä¸€è¡Œæ·»åŠ å¦‚ä¸‹é…ç½®å³å¯ï¼š

```
<property>
<name>metastore.storage.schema.reader.impl</name>
<value>org.apache.hadoop.hive.metastore.SerDeStorageSchemaReader</value>
</property>

```







## äº”.æ­å»ºæ•°ä»“

æ•´ä½“æ¶æ„ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230804203518790.png" alt="image-20230804203518790" style="zoom:25%;" />

å›é¡¾æ•°æ®æ¨¡æ‹Ÿéƒ¨åˆ†ï¼šä¹Ÿè®¸ä½ éœ€è¦å›é¡¾ä¸€ä¸‹æ•°æ®æ€ä¹ˆç”Ÿæˆçš„è¿˜æœ‰æ€ä¹ˆé‡‡é›†çš„ã€‚

æ•°æ®æµå‘ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230804221424284.png" alt="image-20230804221424284" style="zoom:33%;" />









### ï¼ˆ1ï¼‰ç”Ÿæˆ2023-07-27å·çš„æ•°æ®

æ³¨æ„ï¼Œä½ è¦æŠŠzookeep,hadoop,Flume(2å°)ï¼ŒKafkaå…¨å¯åŠ¨ã€‚å…¶ä¸­zookeeperéœ€è¦æœ€å…ˆå¯åŠ¨ï¼ŒKafkaå¯åŠ¨åœ¨flumeä¹‹å‰ã€‚

```
[lchen@hadoop102 bin]$ ./kf.sh start
 --------å¯åŠ¨ hadoop102 Kafka-------
 --------å¯åŠ¨ hadoop103 Kafka-------
 --------å¯åŠ¨ hadoop104 Kafka-------
[lchen@hadoop102 bin]$ ./f1.sh start
bash: ./f1.sh: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•
[lchen@hadoop102 bin]$ ./fl.sh start
 --------å¯åŠ¨hadoop102é‡‡é›†flume-------
[lchen@hadoop102 bin]$ ./f2.sh start

```



- åˆ›å»º2023-07-27çš„æ±½è½¦æ—¥å¿—æ•°æ®

```
[lchen@hadoop102 bin]$ lg.sh 2023-07-27

```

åªæœ‰ä½ å‰é¢Kafkaå’Œflumeéƒ½å¯åŠ¨äº†ï¼Œæ•°æ®ä¼šè‡ªåŠ¨ä¸Šä¼ è‡³HDFSï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230804212716616.png" alt="image-20230804212716616" style="zoom:33%;" />

æˆ‘ä»¬ç‚¹å‡»è¿›å…¥è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œå½“æ²¡æœ‰tmpä¸´æ—¶æ–‡ä»¶æ—¶åˆ™è¯´æ˜æ•°æ®å·²ç»ä¸Šä¼ å®Œæ¯•ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230804213114481.png" alt="image-20230804213114481" style="zoom:33%;" />



æŠŠç»´åº¦æ•°æ®ä¹Ÿæ”¾åˆ°HDFSé‡Œ/origin_dataï¼ˆå…¨é‡åŒæ­¥ï¼‰ï¼š

```
[lchen@hadoop102 bin]$ ./mysql_to_hdfs.sh 2023-07-27
```

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230804220548842.png" alt="image-20230804220548842" style="zoom:25%;" />

è¿™é‡Œå’±æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šï¼ˆâ­ï¼‰

ä¸ºä»€ä¹ˆflumeé€šå¸¸é‡‡é›†æ—¥å¿—æ•°æ®è€Œä¸æ˜¯ç»´åº¦æ•°æ®ï¼Ÿ

â€‹	æ•°æ®æ ¼å¼å’Œç»“æ„ï¼šç»´åº¦æ•°æ®é€šå¸¸æ˜¯ç»“æ„åŒ–çš„æ•°æ®ï¼Œä¾‹å¦‚æ•°æ®åº“ä¸­çš„è¡¨æ ¼æ•°æ®æˆ–è€…æ•°æ®ä»“åº“ä¸­çš„ç»´åº¦è¡¨ã€‚è¿™ç§æ•°æ®å·²ç»ç»è¿‡å¤„ç†å’Œæ•´ç†ï¼Œå…·æœ‰æ˜ç¡®çš„æ•°æ®æ¨¡å¼å’Œå­—æ®µå®šä¹‰ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œæ—¥å¿—æ•°æ®é€šå¸¸æ˜¯éç»“æ„åŒ–æˆ–åŠç»“æ„åŒ–çš„æ–‡æœ¬æ•°æ®ï¼Œå…¶æ ¼å¼å’Œç»“æ„å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œéœ€è¦è¿›è¡Œè§£æå’Œæå–ã€‚Flumeæä¾›äº†ä¸°å¯Œçš„æ—¥å¿—æ•°æ®å¤„ç†å·¥å…·å’Œæ’ä»¶ï¼Œèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·è§£æå’Œå¤„ç†å„ç§æ ¼å¼çš„æ—¥å¿—æ•°æ®ã€‚





### ï¼ˆ2ï¼‰æ•°ä»“åˆ†å±‚ä»‹ç»

*æ³¨ï¼šåŸå§‹æ•°æ®æ˜¯OLTPç³»ç»Ÿæ•°æ®ï¼Œç¬¦åˆä¸‰èŒƒå¼ã€‚ä½†æ˜¯æˆ‘ä»¬æƒ³è¦åˆ©äºåˆ†æçš„ç³»ç»ŸOLAPæ•…è¦è¿›è¡Œè½¬æ¢ï¼Œæ•°æ®ä¹Ÿä¼š**ä»ä¸‰èŒƒå¼ERæ¨¡å‹è½¬æ¢æˆç»´åº¦æ¨¡å‹**

#### 1.åˆ†å±‚è§„åˆ’ï¼šï¼ˆæœ€å°‘äº”å±‚ï¼Œå¯å¤šä¸å¯å°‘ï¼‰

1. æ•°æ®åº”ç”¨å±‚ï¼ˆADSï¼‰

   å­˜æ”¾å„é¡¹ç»Ÿè®¡æŒ‡æ ‡ç»“æœã€‚

2. æ±‡æ€»æ•°æ®å±‚ï¼ˆDWSï¼‰

   åŸºäºä¸Šå±‚æŒ‡æ ‡éœ€æ±‚ï¼Œä»¥åˆ†æä¸»é¢˜çš„å¯¹è±¡ä½œä¸ºå»ºæ¨¡é©±åŠ¨ï¼Œæ„å»ºå…¬å…±ç»Ÿè®¡ç²’åº¦æ±‡æ€»è¡¨

3. æ˜ç»†æ•°æ®å±‚ï¼ˆDWDï¼‰â€”â€”ç»´åº¦å»ºæ¨¡

   **åŸºäºç»´åº¦å»ºæ¨¡ç†è®ºæ„å»ºï¼Œå­˜æ”¾äº‹å®è¡¨ã€‚**ä¿å­˜ä¸šåŠ¡è¿‡ç¨‹æœ€å°ç²’åº¦æ“ä½œè®°å½•

4. å…¬å…±ç»´åº¦å±‚ï¼ˆDIMï¼‰â€”â€”ç»´åº¦å»ºæ¨¡

   **åŸºäºç»´åº¦å»ºæ¨¡ç†è®ºæ„å»ºï¼Œå­˜æ”¾ç»´åº¦è¡¨**ï¼Œä¿å­˜ä¸€è‡´çš„ç»´åº¦ä¿¡æ¯ã€‚

5. åŸå§‹æ•°æ®å±‚ï¼ˆODSï¼‰

**å­˜æ”¾æ²¡æœ‰ç»è¿‡å¤„ç†çš„åŸå§‹æ•°æ®**ï¼Œä¸ä¼šå¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚æ˜¯æ•°æ®ä»“åº“çš„æ•°æ®å‡†å¤‡åŒº



- ç›¸å…³æ¦‚å¿µï¼š

OLTPâ€”â€”æ“…é•¿CRUDï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰çš„æ•°æ®æ¦‚è®ºå­˜å‚¨ç³»ç»Ÿã€‚ä¸»è¦æ•°æ®æ“ä½œæ˜¯éšæœºè¯»å†™ï¼Œä¸»è¦é‡‡ç”¨æ»¡è¶³ 3NF çš„å®ä½“å…³ç³»å‹å­˜å‚¨æ•°æ®

OLAPâ€”â€”é¢å‘çš„ä¸»è¦æ•°æ®æ“ä½œæ˜¯æ‰¹é‡è¯»å†™ï¼Œä¸å…³æ³¨äº‹åŠ¡å¤„ç†çš„ä¸€è‡´æ€§ï¼Œä¸»è¦å…³æ³¨æ•°æ®çš„æ•´åˆï¼Œä»¥åŠåœ¨ä¸€æ¬¡æ€§çš„å¤æ‚æ•°æ®æŸ¥è¯¢å’Œå¤„ç†ä¸­çš„æ€§èƒ½ï¼ˆæ•°æ®åˆ†æï¼‰

ERæ¨¡å‹â€”â€”ä»å…¨ä¼ä¸šçš„é«˜åº¦è®¾è®¡ä¸€ä¸ª 3NF æ¨¡å‹ï¼Œç”¨å®ä½“å…³ç³»ï¼ˆERï¼‰æ¨¡å‹æè¿°ä¼ä¸šä¸šåŠ¡ï¼Œåœ¨èŒƒå¼ç†è®ºä¸Šç¬¦åˆ 3NFã€‚

ç»´åº¦æ¨¡å‹â€”â€”ä»åˆ†æå†³ç­–çš„éœ€æ±‚å‡ºå‘æ„å»ºæ¨¡å‹ï¼Œä¸ºåˆ†æéœ€æ±‚æœåŠ¡ï¼Œé‡ç‚¹å…³æ³¨ç”¨æˆ·å¦‚ä½•æ›´å¿«é€Ÿçš„å®Œæˆéœ€æ±‚åˆ†æï¼Œå…·æœ‰è¾ƒå¥½çš„å¤§è§„æ¨¡å¤æ‚æŸ¥è¯¢çš„å“åº”æ€§èƒ½

æ•°æ®ç²’åº¦â€”â€”æ•°æ®ç²’åº¦å…¶å®å°±æ˜¯æŒ‡æ•°æ®ä»“åº“çš„æ•°æ®å•ä½ä¸­ä¿å­˜æ•°æ®çš„ç»†åŒ–æˆ–ç»¼åˆç¨‹åº¦çš„çº§åˆ«ã€‚



ç»´åº¦æ¨¡å‹åˆ†ä¸ºä¸¤ä¸ªè¡¨ï¼š

1. äº‹å®è¡¨â€”â€”å­˜å‚¨æœ€ç»†çš„ä¸šåŠ¡äº‹ä»¶
2. ç»´åº¦è¡¨â€”â€”è®°å½•ä¸šåŠ¡äº‹ä»¶çš„ç¯å¢ƒ



#### 2.ç»´åº¦æ¨¡å‹ï¼ˆå•ç‹¬ä»‹ç»ï¼‰

è¿™é‡Œæˆ‘ä»¬ä»¥æ˜Ÿå‹æ¨¡å‹ä¸ºä¾‹

æˆ‘ä»¬åœ¨è¿›è¡Œç»´åº¦å»ºæ¨¡çš„æ—¶å€™ä¼šå»ºä¸€å¼ äº‹å®è¡¨ï¼Œè¿™ä¸ªäº‹å®è¡¨å°±æ˜¯æ˜Ÿå‹æ¨¡å‹çš„ä¸­å¿ƒï¼Œç„¶åä¼šæœ‰ä¸€å †ç»´åº¦è¡¨ï¼Œè¿™äº›ç»´åº¦è¡¨å°±æ˜¯å‘å¤–å‘æ•£çš„æ˜Ÿæ˜Ÿï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230805104155741.png" alt="image-20230805104155741" style="zoom:25%;" />

**å›¾ä¸­çš„è®¢å•è¡¨ï¼ˆICstockbillï¼‰å°±æ˜¯ä¸€ä¸ªäº‹å®è¡¨**ï¼Œä½ å¯ä»¥ç†è§£ä»–å°±æ˜¯åœ¨ç°å®ä¸­å‘ç”Ÿçš„ä¸€æ¬¡æ“ä½œå‹äº‹ä»¶ï¼Œæˆ‘ä»¬æ¯å®Œæˆä¸€ä¸ªè®¢å•ï¼Œå°±ä¼šåœ¨è®¢å•ä¸­å¢åŠ ä¸€æ¡è®°å½•ã€‚æˆ‘ä»¬å¯ä»¥å›è¿‡å¤´å†çœ‹ä¸€ä¸‹äº‹å®è¡¨çš„ç‰¹å¾ï¼Œ**åœ¨äº‹å®è¡¨é‡Œæ²¡æœ‰å­˜æ”¾å®é™…çš„å†…å®¹ï¼Œä»–æ˜¯ä¸€å †ä¸»é”®çš„é›†åˆ**ï¼Œè¿™äº›IDåˆ†åˆ«èƒ½å¯¹åº”åˆ°ç»´åº¦è¡¨ä¸­çš„ä¸€æ¡è®°å½•ã€‚

**æ¯ä¸ªç»´åº¦è¡¨éƒ½åŒ…å«å•ä¸€çš„ä¸»é”®åˆ—ã€‚**å›¾ä¸­çš„customerï¼ˆå®¢æˆ·è¡¨ï¼‰ã€goods(å•†å“è¡¨)ã€d_time(æ—¶é—´è¡¨)è¿™äº›éƒ½å±äºç»´åº¦è¡¨ï¼Œè¿™äº›è¡¨éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ä¸»é”®ï¼Œç„¶ååœ¨è¡¨ä¸­å­˜æ”¾äº†è¯¦ç»†çš„æ•°æ®ä¿¡æ¯ã€‚





### ï¼ˆ3ï¼‰åŸå§‹æ•°æ®å±‚ï¼ˆODSå±‚ï¼‰æ­å»º

å…³äºæŠŠæ–‡æœ¬æ•°æ®è½¬æ¢æˆhiveè¡¨çš„å†…å®¹å¯ä»¥å‚è€ƒ â€œhiveå­¦ä¹ ç¬”è®°â€

------

ä¸€å¥è¯æ¦‚æ‹¬ä»»åŠ¡â€”â€”**æŠŠæ•°æ®å˜æˆhiveè¡¨æ ¼**

ODSå±‚è®¾è®¡è¦ç‚¹ï¼š

1. ODSå±‚è¦ä¿å­˜æ‰€æœ‰çš„å†å²æ•°æ®ï¼Œæ•…å™¨å‹ç¼©ä¸ªæ•°æ¯”è¾ƒé«˜ï¼Œæ­¤å¤„é€‰æ‹©gzip

2. å‘½åè§„èŒƒï¼š

   ```
   ods_è¡¨å_æ ‡è¯†ï¼ˆinc/fullï¼‰å…¨é‡è¡¨/å¢é‡è¡¨
   ```

   å¦‚æ—¥å¿—ä¸€èˆ¬éƒ½æ˜¯å¢é‡è¡¨ï¼Œæ±½è½¦ä¿¡æ¯ä¸€èˆ¬æ˜¯å…¨é‡è¡¨



- å¦‚ä½•æŠŠJSONæ•°æ®ï¼ˆä¸ä¸€å®šæ˜¯JSONæ–‡ä»¶ï¼‰è½¬å˜é™ˆhiveè¡¨æ ¼

æ–¹å¼ä¸€ï¼š

æ‰€ç”¨JSONæ•°æ®ï¼šï¼ˆéœ€è¦æ”¾åˆ°hdfsï¼‰

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230805205227607.png" alt="image-20230805205227607" style="zoom:25%;" />

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230806100507026.png" alt="image-20230806100507026" style="zoom:25%;" />

**æ³¨æ„JSONè§£æçš„æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œçš„æ‰€æœ‰æ•°æ®ï¼Œæ•…è¦åœ¨å•ç‹¬çš„æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºæ•°æ®æ–‡ä»¶ã€‚**

å¯åŠ¨hiveï¼š

```
[lchen@hadoop102 root]$ cd /opt/module/hive/
[lchen@hadoop102 hive]$ hiveserver2
```

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230806101700339.png" alt="image-20230806101700339" style="zoom:33%;" />

è¾“å‡ºç»“æœï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230806101712866.png" alt="image-20230806101712866" style="zoom:33%;" />



æ–¹æ³•äºŒï¼šserde

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230806104238692.png" alt="image-20230806104238692" style="zoom:33%;" />



#### 1.ç”Ÿæˆè½¦è¾†æ—¥å¿—è¡¨ï¼ˆå¢é‡è¡¨ï¼‰

- é¦–å…ˆåˆ›å»ºè¡¨ï¼Œå¹¶å­˜å…¥HDFS

```
create external table ods_car_data_inc
(
    `vin`                                         string comment 'æ±½è½¦å”¯ä¸€ID',
    `car_status`                                  int comment 'è½¦è¾†çŠ¶æ€',
    `charge_status`                               int comment 'å……ç”µçŠ¶æ€',
    `execution_mode`                              int comment 'è¿è¡Œæ¨¡å¼',
    `velocity`                                    int comment 'è½¦é€Ÿ',
    `mileage`                                     int comment 'é‡Œç¨‹',
    `voltage`                                     int comment 'æ€»ç”µå‹',
    `electric_current`                            int comment 'æ€»ç”µæµ',
    `soc`                                         int comment 'SOC',
    `dc_status`                                   int comment 'DC-DCçŠ¶æ€',
    `gear`                                        int comment 'æŒ¡ä½',
    `insulation_resistance`                       int comment 'ç»ç¼˜ç”µé˜»',
    `motor_count`                                 int comment 'é©±åŠ¨ç”µæœºä¸ªæ•°',
    `motor_list`                                  array<struct<`id` :int, `status` :int, `rev` :int, `torque` :int,
                                                               `controller_temperature` :int, `temperature` :int,
                                                               `voltage`
                                                               :int, `electric_current` :int>> comment 'é©±åŠ¨ç”µæœºåˆ—è¡¨',
    `fuel_cell_voltage`                           int comment 'ç‡ƒæ–™ç”µæ± ç”µå‹',
    `fuel_cell_current`                           int comment 'ç‡ƒæ–™ç”µæ± ç”µæµ',
    `fuel_cell_consume_rate`                      int comment 'ç‡ƒæ–™æ¶ˆè€—ç‡',
    `fuel_cell_temperature_probe_count`           int comment 'ç‡ƒæ–™ç”µæ± æ¸©åº¦æ¢é’ˆæ€»æ•°',
    `fuel_cell_temperature`                       int comment 'ç‡ƒæ–™ç”µæ± æ¸©åº¦å€¼',
    `fuel_cell_max_temperature`                   int comment 'æ°¢ç³»ç»Ÿä¸­æœ€é«˜æ¸©åº¦',
    `fuel_cell_max_temperature_probe_id`          int comment 'æ°¢ç³»ç»Ÿä¸­æœ€é«˜æ¸©åº¦æ¢é’ˆå·',
    `fuel_cell_max_hydrogen_consistency`          int comment 'æ°¢æ°”æœ€é«˜æµ“åº¦',
    `fuel_cell_max_hydrogen_consistency_probe_id` int comment 'æ°¢æ°”æœ€é«˜æµ“åº¦ä¼ æ„Ÿå™¨ä»£å·',
    `fuel_cell_max_hydrogen_pressure`             int comment 'æ°¢æ°”æœ€é«˜å‹åŠ›',
    `fuel_cell_max_hydrogen_pressure_probe_id`    int comment 'æ°¢æ°”æœ€é«˜å‹åŠ›ä¼ æ„Ÿå™¨ä»£å·',
    `fuel_cell_dc_status`                         int comment 'é«˜å‹DC-DCçŠ¶æ€',
    `engine_status`                               int comment 'å‘åŠ¨æœºçŠ¶æ€',
    `crankshaft_speed`                            int comment 'æ›²è½´è½¬é€Ÿ',
    `fuel_consume_rate`                           int comment 'ç‡ƒæ–™æ¶ˆè€—ç‡',
    `max_voltage_battery_pack_id`                 int comment 'æœ€é«˜ç”µå‹ç”µæ± å­ç³»ç»Ÿå·',
    `max_voltage_battery_id`                      int comment 'æœ€é«˜ç”µå‹ç”µæ± å•ä½“ä»£å·',
    `max_voltage`                                 int comment 'ç”µæ± å•ä½“ç”µå‹æœ€é«˜å€¼',
    `min_temperature_subsystem_id`                int comment 'æœ€ä½ç”µå‹ç”µæ± å­ç³»ç»Ÿå·',
    `min_voltage_battery_id`                      int comment 'æœ€ä½ç”µå‹ç”µæ± å•ä½“ä»£å·',
    `min_voltage`                                 int comment 'ç”µæ± å•ä½“ç”µå‹æœ€ä½å€¼',
    `max_temperature_subsystem_id`                int comment 'æœ€é«˜æ¸©åº¦å­ç³»ç»Ÿå·',
    `max_temperature_probe_id`                    int comment 'æœ€é«˜æ¸©åº¦æ¢é’ˆå·',
    `max_temperature`                             int comment 'æœ€é«˜æ¸©åº¦å€¼',
    `min_voltage_battery_pack_id`                 int comment 'æœ€ä½æ¸©åº¦å­ç³»ç»Ÿå·',
    `min_temperature_probe_id`                    int comment 'æœ€ä½æ¸©åº¦æ¢é’ˆå·',
    `min_temperature`                             int comment 'æœ€ä½æ¸©åº¦å€¼',
    `alarm_level`                                 int comment 'æŠ¥è­¦çº§åˆ«',
    `alarm_sign`                                  int comment 'é€šç”¨æŠ¥è­¦æ ‡å¿—',
    `custom_battery_alarm_count`                  int comment 'å¯å……ç”µå‚¨èƒ½è£…ç½®æ•…éšœæ€»æ•°N1',
    `custom_battery_alarm_list`                   array<int> comment 'å¯å……ç”µå‚¨èƒ½è£…ç½®æ•…éšœä»£ç åˆ—è¡¨',
    `custom_motor_alarm_count`                    int comment 'é©±åŠ¨ç”µæœºæ•…éšœæ€»æ•°N2',
    `custom_motor_alarm_list`                     array<int> comment 'é©±åŠ¨ç”µæœºæ•…éšœä»£ç åˆ—è¡¨',
    `custom_engine_alarm_count`                   int comment 'å‘åŠ¨æœºæ•…éšœæ€»æ•°N3',
    `custom_engine_alarm_list`                    array<int> comment 'å‘åŠ¨æœºæ•…éšœä»£ç åˆ—è¡¨',
    `other_alarm_count`                           int comment 'å…¶ä»–æ•…éšœæ€»æ•°N4',
    `other_alarm_list`                            array<int> comment 'å…¶ä»–æ•…éšœä»£ç åˆ—è¡¨',
    `battery_count`                               int comment 'å•ä½“ç”µæ± æ€»æ•°',
    `battery_pack_count`                          int comment 'å•ä½“ç”µæ± åŒ…æ€»æ•°',
    `battery_voltages`                            array<int> comment 'å•ä½“ç”µæ± ç”µå‹å€¼åˆ—è¡¨',
    `battery_temperature_probe_count`             int comment 'å•ä½“ç”µæ± æ¸©åº¦æ¢é’ˆæ€»æ•°',
    `battery_pack_temperature_count`              int comment 'å•ä½“ç”µæ± åŒ…æ€»æ•°',
    `battery_temperatures`                        array<int> comment 'å•ä½“ç”µæ± æ¸©åº¦å€¼åˆ—è¡¨',
    `timestamp`                                   bigint comment 'æ—¥å¿—é‡‡é›†æ—¶é—´'
) 
    comment 'æ•´è½¦æ—¥å¿—è¡¨'
    partitioned by (`dt` string comment 'ç»Ÿè®¡æ—¥æœŸ')
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    location '/warehouse/car_data/ods/ods_car_data_inc';

```

- ç„¶åæ˜ å°„æ•°æ®åˆ°è¡¨ä¸­


**æ³¨æ„ï¼š1.ä¸å‡†ç›´æ¥æŠŠæ—¥å¿—æ•°æ®é€šè¿‡HDFSå¯è§†åŒ–å¤åˆ¶åˆ°â€”â€”/warehouse/car_data/ods/ods_car_data_inc**

å› ä¸ºè¿™é‡Œæ¶‰åŠåˆ°å…ƒæ•°æ®é—®é¢˜â€”â€”å³ç²˜è´´è¿‡æ¥çš„æ•°æ®æ²¡æœ‰å…ƒæ•°æ®ã€‚

åˆ†åŒºâ€”â€”å°±æ˜¯ä¸€å¼ è¡¨å¤šä¸ªç›®å½•ã€‚



**2.é”™è¯¯æ“ä½œï¼š**

```
load data inpath '/origin_data/car_data_full/2023-07-26' into table ods_car_data_inc;
```

æ²¡æœ‰è®¾ç½®åˆ†åŒºï¼Œå¼•æ“ä¼šèµ°MRã€‚æ•°æ®æ ¼å¼è¢«æ”¹å˜ã€‚



**æ­£ç¡®æ“ä½œï¼šï¼ˆå¯¹åŸæœ‰æ•°æ®è¿›è¡Œå‰ªåˆ‡æ“ä½œï¼Œå¹¶ä¸”åˆ›å»ºå¯¹åº”åˆ†åŒºçš„å…ƒæ•°æ®ï¼‰**

```
load data inpath '/origin_data/car_data_full/2023-07-26' into table ods_car_data_inc partition (dt='2023-07-26');
```

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230806202657491.png" alt="image-20230806202657491" style="zoom:33%;" />

/origin_data/car_data_full/2023-07-26è¢«æ›¿æ¢åˆ°äº†ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230806202932230.png" alt="image-20230806202932230" style="zoom:25%;" />

å¦‚æœä½ æŠŠè¯¥è¡¨åˆ é™¤ï¼Œå†åˆ›å»ºçš„æ—¶å€™ï¼Œå‘ç°æ•°æ®æ²¡äº†ï¼Œè¿™æ—¶å€™å¯ä»¥é€šè¿‡ä¿®å¤å…ƒæ•°æ®çš„æ–¹å¼æ¥è§£å†³ï¼šï¼ˆå‰ææ˜¯æ–‡ä»¶å¤¹æ•°æ®è¿˜å­˜åœ¨ï¼‰ï¼š

```
--ä¿®å¤hiveè¡¨çš„å…ƒæ•°æ®
msck repair table ods_car_data_inc;
```

hiveå…ƒæ•°æ®ï¼šå°±æ˜¯è¡¨çš„å±æ€§æ•°æ®ï¼Œè¡¨çš„åå­—ï¼Œåˆ—ä¿¡æ¯ï¼Œåˆ†åŒºç­‰æ ‡çš„å±æ€§ä¿¡æ¯





#### 2.ç”Ÿæˆæ±½è½¦ä¿¡æ¯è¡¨ï¼ˆå…¨é‡è¡¨ï¼‰

è¿™é‡Œè¿˜æ˜¯ä»¥2023-07-26çš„æ•°æ®ä¸ºä¾‹

**æ•°æ®æ ¼å¼ï¼šæŒ‰\tï¼ˆç©ºæ ¼åˆ†å¼€çš„æ•°æ®ï¼‰**

- åˆ›å»ºè¡¨æ ¼

```
drop table if exists ods_car_info_full;
create external table ods_car_info_full
(
    `id`               string comment 'è½¦è¾†å”¯ä¸€ç¼–ç ',
    `type_id`          string comment 'è½¦å‹ID',
    `type`             string comment 'è½¦å‹',
    `sale_type`        string comment 'é”€å”®è½¦å‹',
    `trademark`        string comment 'å“ç‰Œ',
    `company`          string comment 'å‚å•†',
    `seating_capacity` int comment 'å‡†è½½äººæ•°',
    `power_type`       string comment 'è½¦è¾†åŠ¨åŠ›ç±»å‹',
    `charge_type`      string comment 'è½¦è¾†æ”¯æŒå……ç”µç±»å‹',
    `category`         string comment 'è½¦è¾†åˆ†ç±»',
    `weight_kg`        int comment 'æ€»è´¨é‡ï¼ˆkgï¼‰',
    `warranty`         string comment 'æ•´è½¦è´¨ä¿æœŸï¼ˆå¹´/ä¸‡å…¬é‡Œï¼‰'
) comment 'æ•´è½¦ä¿¡æ¯è¡¨'
    partitioned by (`dt` string comment 'ç»Ÿè®¡æ—¥æœŸ')
    row format delimited fields terminated by '\t'
    null defined as ''
    location '/warehouse/car_data/ods/ods_car_info_full';

```

è¿™é‡Œæ³¨æ„ï¼š

hiveé‡Œé¢é»˜è®¤æ§åˆ¶nullä¸ºâ€˜\Nâ€™ï¼Œè€ŒdataxåŒæ­¥è¿‡æ¥çš„æ§åˆ¶é»˜è®¤ä¸º''ç©ºå­—ç¬¦ä¸²ã€‚æ‰€ä»¥null defined as ''è¯¥è¯­å¥æ˜¯ç”¨äºè¯†åˆ«ç©ºå€¼çš„ã€‚

**åˆ†åŒºâ€”â€”ä¸€å¼ è¡¨ä¸åŒåˆ†åŒºä¸åŒæ•°æ®**ã€‚åˆ†åŒºè¡¨å®é™…ä¸Šå°±æ˜¯å¯¹åº”ä¸€ä¸ªHDFSæ–‡ä»¶ç³»ç»Ÿä¸Šçš„ç‹¬ç«‹çš„æ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹ä¸‹æ˜¯è¯¥åˆ†åŒºæ‰€æœ‰çš„æ•°æ®æ–‡ä»¶ã€‚Hiveä¸­çš„åˆ†åŒºå°±æ˜¯åˆ†ç›®å½•ï¼ŒæŠŠä¸€ä¸ªå¤§çš„æ•°æ®é›†æ ¹æ®ä¸šåŠ¡éœ€è¦åˆ†å‰²æˆå°çš„æ•°æ®é›†ã€‚

- åŠ è½½æ•°æ®

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230806205349778.png" alt="image-20230806205349778" style="zoom:33%;" />



#### 3.è®¾ç½®è„šæœ¬æŠŠæ•°æ®è½¬ç§»åˆ°ODSå±‚

åœ¨lchen/binä¸‹åˆ›å»ºhdfs_to_ods.sh

```
#!/bin/bash

APP='default'

# åˆ¤æ–­ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¦å¡«å†™  å¦‚æœå¡«å†™ä½¿ç”¨ä½œä¸ºæ—¥æœŸ å¦‚æœæ²¡æœ‰å¡«å†™ é»˜è®¤ä½¿ç”¨æ˜¨å¤©ä½œä¸ºæ—¥æœŸ
if [ -n "$2" ]; then
	#statements
	do_date=$2
else
	do_date=`date -d '-1 day' +%F`
fi



case "$1" in
	"ods_car_data_inc" )
hive -e "load data inpath '/origin_data/car_data_full/$do_date' into table $APP.ods_car_data_inc partition (dt='$do_date');"
		;;
	"ods_car_info_full" )
hive -e "load data inpath '/origin_data/car_info_full/$do_date' into table $APP.ods_car_info_full partition (dt='$do_date');"
		;;
	"all" )
hive -e "load data inpath '/origin_data/car_data_full/$do_date' into table $APP.ods_car_data_inc partition (dt='$do_date');
	load data inpath '/origin_data/car_info_full/$do_date' into table  $APP.ods_car_info_full partition (dt='$do_date');"
		;;
esac

```

æ³¨æ„ï¼šæ•°æ®åº“åˆ«å†™é”™äº†ã€‚

èµ‹äºˆæƒé™ï¼š

```
sudo chmod 777 hdfs_to_ods.sh 
```

ä¹‹å‰æˆ‘ä»¬å¯¼å…¥çš„æ˜¯7-26å·çš„æ•°æ®ï¼Œç°åœ¨æˆ‘ä»¬åˆ©ç”¨è„šæœ¬å°†27å·çš„æ±½è½¦æ•°æ®+æ—¥å¿—æ•°æ®å…¨éƒ¨å¯¼å…¥é‚£ä¸¤å¼ è¡¨ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230806212350125.png" alt="image-20230806212350125" style="zoom:33%;" />

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230806212814241.png" alt="image-20230806212814241" style="zoom:25%;" />

å›åˆ°HDFSä¸­çš„origin_dataæŸ¥çœ‹ï¼Œå‘ç°27å·çš„æ•°æ®+æ—¥å¿—æ•°æ®éƒ½è¢«è½¬ç§»åˆ°/warehouse/car_data/odsä¸‹ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230806212921722.png" alt="image-20230806212921722" style="zoom:33%;" />

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åˆ†åŒºæŸ¥çœ‹ä»è¡¨ä¸­æŸ¥çœ‹27å·çš„æ•°æ®ï¼š

```
--æ—¥å¿—æ•°æ®
select * from ods_car_data_inc
where dt='2023-07-27';

--æ±½è½¦æ•°æ®
--æŸ¥çœ‹æ•°æ®
select * from ods_car_info_full
where dt='2023-07-27';
```

ä»¥27å·æ—¥å¿—ä¸ºä¾‹ï¼Œéƒ½èƒ½è¾“å‡ºï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230806213315220.png" alt="image-20230806213315220" style="zoom:33%;" />





### ï¼ˆ4ï¼‰å…¬å…±ç»´åº¦å±‚ï¼ˆDIMï¼‰æ­å»º

è®°å½•äº‹åŠ¡çš„ç¯å¢ƒä¿¡æ¯ï¼Œä¾‹å¦‚æ±½è½¦è¡Œé©¶è¿‡ç¨‹ä¸­çš„ç¯å¢ƒæ•°æ®ç­‰ã€‚

è®¾è®¡è¦ç‚¹ï¼š

- è¯¥å±‚å­˜å‚¨ç»´åº¦æ¨¡å‹çš„ç»´åº¦è¡¨
- DIMå±‚çš„æ•°æ®å­˜å‚¨æ ¼å¼ä¸ºorcåˆ—å¼å­˜å‚¨+snappyå‹ç¼©ï¼ˆè®©selectæŸ¥è¯¢é€Ÿåº¦æ›´å¿«ï¼‰
- DIMå±‚è¡¨åçš„å‘½åè§„èŒƒä¸ºdim_è¡¨å_å…¨é‡è¡¨æˆ–è€…æ‹‰é“¾è¡¨æ ‡è¯†ï¼ˆfull/zipï¼‰



åˆ—å¼å­˜å‚¨ç›¸æ¯”è¡Œå¼å­˜å‚¨çš„ä¼˜ç‚¹ï¼š

åˆ—å­˜æ›´æœ‰åˆ©äºæ•°æ®çš„åˆ†æè®¡ç®—ï¼ˆOLAPæ¨¡å‹ï¼‰ï¼Œè¡Œå­˜æœ‰åˆ©äºå¢åˆ æ”¹æŸ¥



#### 1.æ±½è½¦ä¿¡æ¯ç»´åº¦è¡¨å¯¼å…¥

å»ºè¡¨ï¼š

```
drop table if exists dim_car_info_full;
create external table dim_car_info_full
(
    `id`               string comment 'è½¦è¾†å”¯ä¸€ç¼–ç ',
    `type_id`          string comment 'è½¦å‹ID',
    `type`             string comment 'è½¦å‹',
    `sale_type`        string comment 'é”€å”®è½¦å‹',
    `trademark`        string comment 'å“ç‰Œ',
    `company`          string comment 'å‚å•†',
    `seating_capacity` int comment 'å‡†è½½äººæ•°',
    `power_type`       string comment 'è½¦è¾†åŠ¨åŠ›ç±»å‹',
    `charge_type`      string comment 'è½¦è¾†æ”¯æŒå……ç”µç±»å‹',
    `category`         string comment 'è½¦è¾†åˆ†ç±»',
    `weight_kg`        int comment 'æ€»è´¨é‡ï¼ˆkgï¼‰',
    `warranty`         string comment 'æ•´è½¦è´¨ä¿æœŸï¼ˆå¹´/ä¸‡å…¬é‡Œï¼‰'
) comment 'è½¦è¾†ä¿¡æ¯ç»´åº¦è¡¨'
    partitioned by (`dt` string comment 'ç»Ÿè®¡æ—¥æœŸ')
    stored as orc
    location '/warehouse/car_data/dim/dim_car_info_full'
    tblproperties ('orc.compress' = 'snappy');

```



#### 2.åŠ è½½æ•°æ®

ä¸€èˆ¬åªéœ€è¦æœ€æ–°çš„æ•°æ®å³å¯ã€‚

```
--è£…è½½æ•°æ®è¿›å…¥ç»´åº¦è¡¨ï¼ˆåŒæ­¥æœ€æ–°ä¸€å¤©çš„å…¨é‡æ•°æ®å³å¯ï¼‰
insert overwrite table dim_car_info_full partition (dt='2023-07-27')
select
    `id`,
    `type_id`,
    `type`,
    `sale_type`,
    `trademark`,
    `company`,
    `seating_capacity`,
    `power_type`,
    `charge_type`,
    `category` ,
    `weight_kg`,
    `warranty`
    from ods_car_info_full
    where dt='2023-07-27';
```





#### 3.æ—¥å¿—ç¼–ç ç»´åº¦è¡¨

é¢å¤–çš„ç¦»çº¿å¯¹ç…§è¡¨æ ¼ã€‚

```
drop table if exists dim_code_full;
create external table dim_code_full
(
    `type`               string comment 'ç¼–ç ç±»å‹',
    `code_id`          string comment 'ç¼–ç ID',
`code_name`             string comment 'ç¼–ç åç§°'
) comment 'æ—¥å¿—ç¼–ç ç»´åº¦è¡¨'
 stored as orc
location '/warehouse/car_data/dim/dim_code_full'
tblproperties ('orc.compress' = 'snappy');

```

ç¼–ç è¡¨å•¥æ„æ€å‘¢ï¼Ÿ

**ä¾‹å¦‚æ±½è½¦çŠ¶æ€ï¼Œç”µæ± æƒ…å†µå¯èƒ½ç”¨12345æ¥è¡¨ç¤ºã€‚ç„¶å12345åˆ†åˆ«ä»£è¡¨å•¥æ„æ€å°±é€šè¿‡ç¼–ç è¡¨å¯¹ç…§æ‰çŸ¥é“ã€‚**



#### 4.å¯¼å…¥ç¼–ç è¡¨æ•°æ®

è¿™é‡Œé¢å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œç¼–ç è¡¨æ˜¯ä»¥orcæ ¼å¼å­˜å‚¨+snappyæ ¼å¼å‹ç¼©çš„ã€‚è¿™å°±ä½¿å¾—æ— æ³•å’Œæ•°æ®å¯¹åº”ï¼ˆæ ¼å¼ä¸ä¸€æ ·ï¼‰

- åˆ›å»ºä¸€å¼ ä¸´æ—¶è¡¨æ ¼

```
drop table if exists tmp_code_full;
create external table tmp_code_full
(
    `type`               string comment 'ç¼–ç ç±»å‹',
    `code_id`          string comment 'ç¼–ç ID',
`code_name`             string comment 'ç¼–ç åç§°'
) comment 'æ—¥å¿—ç¼–ç ç»´åº¦è¡¨'
row format delimited
fields terminated by '\t'
location '/warehouse/car_data/tmp/tmp_code_full';

```

- æŠŠæ–‡ä»¶ä¸Šä¼ åˆ°ä¸´æ—¶è¡¨çš„ç›®å½•ä¸‹ï¼ˆé€šè¿‡HDFSçš„Webç•Œé¢ï¼Œæ•°æ®æ–‡ä»¶åœ¨èµ„æ–™é‡Œï¼‰

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230807160340884.png" alt="image-20230807160340884" style="zoom:25%;" />

- æŠŠä¸´æ—¶è¡¨æ•°æ®å†™å…¥ç¼–ç è¡¨ä¸­

```
--3.æŠŠä¸´æ—¶è¡¨çš„æ•°æ®åŠ è½½åˆ°ç¼–ç è¡¨
insert into table dim_code_full
select * from tmp_code_full;
```

- æŸ¥çœ‹ç¼–ç è¡¨æ˜¯å¦åŠ è½½æ•°æ®æˆåŠŸ

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230807160924481.png" alt="image-20230807160924481" style="zoom:25%;" />





#### 5.dimå±‚æ•°æ®åŠ è½½è„šæœ¬

æ“ä½œä¸€æ ·ï¼šlchen/binç›®å½•ä¸‹â€”â€”åˆ›å»ºæ–‡ä»¶ods_to_dim.shâ€”â€”èµ‹äºˆæƒé™

æ³¨æ„ï¼šæ•°æ®åº“ä¸è¦å†™é”™äº†ï¼š

```
#!/bin/bash

APP='default'

if [ -n "$2" ]; then
    do_date=$2
else
    do_date=$(date -d '-1 day' +%F)
fi

dim_car_info_full="
insert overwrite table ${APP}.dim_car_info_full partition (dt = '$do_date')
select id,
       type_id,
       type,
       sale_type,
       trademark,
       company,
       seating_capacity,
       power_type,
       charge_type,
       category,
       weight_kg,
       warranty
from ${APP}.ods_car_info_full o
where o.dt = '$do_date';
"

case $1 in
'dim_car_info_full')
    hive -e "${dim_car_info_full}"
    ;;
"all")
    hive -e "${dim_car_info_full}"
    ;;
esac
```

èµ‹äºˆæƒé™ï¼š

```
[lchen@hadoop102 bin]$ sudo chmod 777 ods_to_dim.sh 
```

ä½¿ç”¨ï¼š

å’Œodså±‚è„šæœ¬é€»è¾‘å·®ä¸å¤šä¸€æ ·ã€‚ï¼ˆæŠŠodså±‚å¯¹åº”åˆ†åŒºæ•°æ®â€”â€”>dimå±‚å¯¹åº”åˆ†åŒºæ•°æ®ï¼‰ä¸è¿‡æ²¡æœ‰åŠ¨æ—¥å¿—æ•°æ®ï¼ŒåŠ¨çš„æ˜¯æ±½è½¦æ•°æ®ä¿¡æ¯ã€‚

æ³¨æ„ï¼šä½ çš„dimè¡¨ç”¨çš„æ˜¯overwriteï¼Œæ‰€ä»¥å¯ä»¥é‡å¤è¿è¡Œ

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230807162434114.png" alt="image-20230807162434114" style="zoom:33%;" />

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230807163344705.png" alt="image-20230807163344705" style="zoom:33%;" />





### ï¼ˆ5ï¼‰æ˜ç»†æ•°æ®å±‚ï¼ˆDWDï¼‰æ­å»º

æ³¨æ„å­˜å‚¨äº‹å®è¡¨ï¼Œäº‹å®è¡¨è®°å½•ä¸šåŠ¡çš„è¿‡ç¨‹

äº‹å®è¡¨çš„ç‰¹ç‚¹â€”â€”ç»†é•¿ã€‚å³åˆ—å°‘è¡Œå¤š

å»ºæ¨¡ç†è®ºï¼š

- å­˜å‚¨ç»´åº¦æ¨¡å‹çš„äº‹å®è¡¨
- å­˜å‚¨æ ¼å¼æ˜¯orcåˆ—å¼å­˜å‚¨+snappyå‹ç¼©
- DWDå±‚è¡¨åçš„å‘½åè§„èŒƒä¸ºdwd_æ•°æ®åŸŸ_è¡¨å_å•åˆ†åŒºå¢é‡å…¨é‡æ ‡è¯†ï¼ˆinc/fullï¼‰



#### 1.äº‹å®è¡¨åˆ†ç±»

1. äº‹åŠ¡äº‹å®è¡¨ï¼ˆä½¿ç”¨è¿™ä¸ªï¼‰â€”â€”äº‹åŠ¡æ€§äº‹å®è¡¨é€šå¸¸ç”¨ä¸€æ¡è®°å½•è¡¨ç¤ºæŸä¸ªæ—¶é—´ç‚¹å‘ç”Ÿçš„äº‹ä»¶æˆ–è¡Œä¸ºã€‚
2. å‘¨æœŸå¿«ç…§äº‹å®è¡¨
3. ç´¯è®¡å¿«ç…§äº‹å®è¡¨



**äº‹åŠ¡äº‹å®è¡¨çš„è®¾è®¡æµç¨‹ï¼š**

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230807184721677.png" alt="image-20230807184721677" style="zoom:33%;" />

1. é€‰æ‹©ä¸šåŠ¡è¿‡ç¨‹
2. å£°æ˜ç²’åº¦ï¼ˆç²’åº¦â€”â€”äº‹å®è¡¨ä¸€è¡Œè¡¨ç¤ºä»€ä¹ˆï¼Œå°½é‡é€‰æ‹©æœ€ç»†ç²’åº¦ï¼‰
3. ç¡®è®¤ç»´åº¦
4. ç¡®è®¤äº‹å®



#### 2.ç”µåŠ¨æ¨¡å¼è¡Œé©¶æ—¥å¿—å®ç°è¡¨çš„è£…è½½

å»ºè¡¨ï¼šï¼ˆæå–å‡ºç”µåŠ¨æ¨¡å¼å½¢å¼çš„ç›¸å…³å±æ€§ï¼‰

```
drop table if exists dwd_car_running_electricity_inc;
create external table dwd_car_running_electricity_inc
(
    `vin`                                         string comment 'æ±½è½¦å”¯ä¸€ID',
    `velocity`                                    int comment 'è½¦é€Ÿ',
    `mileage`                                     int comment 'é‡Œç¨‹',
    `voltage`                                     int comment 'æ€»ç”µå‹',
    `electric_current`                            int comment 'æ€»ç”µæµ',
    `soc`                                         int comment 'SOC',
    `dc_status`                                   int comment 'DC-DCçŠ¶æ€',
    `gear`                                        int comment 'æŒ¡ä½',
    `insulation_resistance`                       int comment 'ç»ç¼˜ç”µé˜»',
    `motor_count`                                 int comment 'é©±åŠ¨ç”µæœºä¸ªæ•°',
    `motor_list`                                  array<struct<`id` :int, `status` :int, `rev` :int, `torque` :int,
                                                               `controller_temperature` :int, `temperature` :int,
                                                               `voltage`
                                                               :int, `electric_current` :int>> comment 'é©±åŠ¨ç”µæœºåˆ—è¡¨',
    `fuel_cell_dc_status`                         int comment 'é«˜å‹DC-DCçŠ¶æ€',
    `engine_status`                               int comment 'å‘åŠ¨æœºçŠ¶æ€',
    `crankshaft_speed`                            int comment 'æ›²è½´è½¬é€Ÿ',
    `fuel_consume_rate`                           int comment 'ç‡ƒæ–™æ¶ˆè€—ç‡',
    `max_voltage_battery_pack_id`                 int comment 'æœ€é«˜ç”µå‹ç”µæ± å­ç³»ç»Ÿå·',
    `max_voltage_battery_id`                      int comment 'æœ€é«˜ç”µå‹ç”µæ± å•ä½“ä»£å·',
    `max_voltage`                                 int comment 'ç”µæ± å•ä½“ç”µå‹æœ€é«˜å€¼',
    `min_temperature_subsystem_id`                int comment 'æœ€ä½ç”µå‹ç”µæ± å­ç³»ç»Ÿå·',
    `min_voltage_battery_id`                      int comment 'æœ€ä½ç”µå‹ç”µæ± å•ä½“ä»£å·',
    `min_voltage`                                 int comment 'ç”µæ± å•ä½“ç”µå‹æœ€ä½å€¼',
    `max_temperature_subsystem_id`                int comment 'æœ€é«˜æ¸©åº¦å­ç³»ç»Ÿå·',
    `max_temperature_probe_id`                    int comment 'æœ€é«˜æ¸©åº¦æ¢é’ˆå·',
    `max_temperature`                             int comment 'æœ€é«˜æ¸©åº¦å€¼',
    `min_voltage_battery_pack_id`                 int comment 'æœ€ä½æ¸©åº¦å­ç³»ç»Ÿå·',
    `min_temperature_probe_id`                    int comment 'æœ€ä½æ¸©åº¦æ¢é’ˆå·',
    `min_temperature`                             int comment 'æœ€ä½æ¸©åº¦å€¼',
    `battery_count`                               int comment 'å•ä½“ç”µæ± æ€»æ•°',
    `battery_pack_count`                          int comment 'å•ä½“ç”µæ± åŒ…æ€»æ•°',
    `battery_voltages`                            array<int> comment 'å•ä½“ç”µæ± ç”µå‹å€¼åˆ—è¡¨',
    `battery_temperature_probe_count`             int comment 'å•ä½“ç”µæ± æ¸©åº¦æ¢é’ˆæ€»æ•°',
    `battery_pack_temperature_count`              int comment 'å•ä½“ç”µæ± åŒ…æ€»æ•°',
    `battery_temperatures`                        array<int> comment 'å•ä½“ç”µæ± æ¸©åº¦å€¼åˆ—è¡¨',
    `timestamp`                                   bigint comment 'æ—¥å¿—é‡‡é›†æ—¶é—´'
)
comment 'ç”µåŠ¨æ¨¡å¼è¡Œé©¶æ—¥å¿—äº‹å®è¡¨'
partitioned by (`dt` string comment 'ç»Ÿè®¡æ—¥æœŸ')
stored as orc
location '/warehouse/car_data/dwd/dwd_car_running_electricity_inc'
tblproperties ('orc.compress' = 'snappy');

```

æ•°æ®è£…è½½ï¼šï¼ˆè¿™é‡Œé‡‡ç”¨åŠ¨æ€åˆ†åŒºï¼‰ã€é¦–æ—¥è£…è½½ã€‘

```
--åŠ è½½æ•°æ®

insert overwrite table default.dwd_car_running_electricity_inc partition(dt)
select
    `vin`,
    `velocity`,
    `mileage`,
    `voltage`,
    `electric_current`,
    `soc`,
    `dc_status`,
    `gear`,
    `insulation_resistance`,
    `motor_count`,
    `motor_list`,
    `fuel_cell_dc_status`,
    `engine_status`,
    `crankshaft_speed`,
    `fuel_consume_rate`  ,
    `max_voltage_battery_pack_id`,
    `max_voltage_battery_id`,
    `max_voltage`,
    `min_temperature_subsystem_id`,
    `min_voltage_battery_id`,
    `min_voltage`,
    `max_temperature_subsystem_id`,
    `max_temperature_probe_id`,
    `max_temperature`,
    `min_voltage_battery_pack_id`,
    `min_temperature_probe_id`,
    `min_temperature`,
    `battery_count`,
    `battery_pack_count`,
    `battery_voltages`,
    `battery_temperature_probe_count`,
    `battery_pack_temperature_count`,
    `battery_temperatures`,
    `timestamp`
from default.ods_car_data_inc
where dt <='2023-07-27'
and car_status=1
and execution_mode=1;  
```

è¿™é‡Œé™åˆ¶äº†:

dt <='2023-07-27' and

car_status=1
and execution_mode=1;  

å³è¦æ±‚æ±½è½¦æ­£åœ¨è¡Œé©¶ï¼Œè€Œä¸”æ¨¡å¼æ˜¯å­˜ç”µåŠ¨ã€‚

**åŠ¨æ€åˆ†åŒºï¼š**

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230808170117220.png" alt="image-20230808170117220" style="zoom:25%;" />

æ³¨æ„Hiveä¸å…è®¸ä¸€çº§åˆ†åŒºä¸‹çš„åŠ¨æ€åˆ†åŒºâ€”â€”hiveçš„åˆ†åŒºå°±æ˜¯åˆ†æ–‡ä»¶å¤¹

è§£å†³æ–¹æ¡ˆâ€”â€”å…³é—­ä¸¥æ ¼æ¨¡å¼ï¼š

```
set hive.exec.dynamic.partition.mode=nonstrict;
```

ä¸ºä»€ä¹ˆä¼šæœ‰ä¸€ä¸ªä¸¥æ ¼æ¨¡å¼ï¼šé¿å…ä¸€çº§ç›®å½•ä¸‹å‡ºç°å¤ªå¤šçš„æ•°æ®ï¼ˆä¼šé€ æˆè¦†ç›–ï¼‰ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

å‡è®¾æˆ‘æ˜¨å¤©å¯¼å…¥äº†ä¸Šä¸ªæœˆçš„æ•°æ®ï¼Œä»Šå¤©æˆ‘è¦å¯¼å…¥è¿™ä¸ªæœˆçš„æ•°æ®ï¼ˆå¦‚æœé‡Œé¢æ··åˆäº†ä¸Šä¸ªæœˆçš„dtï¼‰ã€‚æˆ‘é‡‡ç”¨åŠ¨æ€åˆ†åŒºï¼Œæˆ‘çš„è¡¨è¿˜æ˜¯overwriteï¼Œä¸€æ—¦æ‰§è¡Œä¸Šä¸ªæœˆçš„æ•°æ®å°±ä¼šè¢«è¿™ä¸ªæœˆè¦†ç›–æ‰ã€‚ï¼ˆè¿™é‡Œç”±äºæ˜¯é¦–æ¬¡åŠ è½½æ•…ä¸å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼Œå¦åˆ™å°±è¦é™å®šdtçš„å€¼ï¼‰ã€‚åŒæ—¶éå†æ‰€æœ‰çš„dtæ¶ˆè€—å¤§é‡çš„èµ„æº



**æŠ¥é”™äº†ï¼šæ³¨æ„è¡¨å‰é¢å¯èƒ½è¦åŠ â€”â€”æ•°æ®åº“.**

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230808195804480.png" alt="image-20230808195804480" style="zoom:50%;" />



**æ¯æ—¥è£…è½½ï¼šï¼ˆæ­£å¸¸åŠ è½½å°±è¡Œï¼‰**

```
insert overwrite table default.dwd_car_running_electricity_inc partition(dt='2023-05-03')
select
    `vin`,
    `velocity`,
    `mileage`,
    `voltage`,
    `electric_current`,
    `soc`,
    `dc_status`,
    `gear`,
    `insulation_resistance`,
    `motor_count`,
    `motor_list`,
    `fuel_cell_dc_status`,
    `engine_status`,
    `crankshaft_speed`,
    `fuel_consume_rate`  ,
    `max_voltage_battery_pack_id`,
    `max_voltage_battery_id`,
    `max_voltage`,
    `min_temperature_subsystem_id`,
    `min_voltage_battery_id`,
    `min_voltage`,
    `max_temperature_subsystem_id`,
    `max_temperature_probe_id`,
    `max_temperature`,
    `min_voltage_battery_pack_id`,
    `min_temperature_probe_id`,
    `min_temperature`,
    `battery_count`,
    `battery_pack_count`,
    `battery_voltages`,
    `battery_temperature_probe_count`,
    `battery_pack_temperature_count`,
    `battery_temperatures`,
    \`timestamp\`
from default.ods_car_data_inc
where dt='2023-05-03'
and car_status=1
and execution_mode=1;
```



#### 3.æ··åˆæ¨¡å¼è¡Œé©¶æ—¥å¿—å®ç°è¡¨çš„è£…è½½

å»ºè¡¨ï¼š

```
drop table if exists dwd_car_running_hybrid_inc;
create external table dwd_car_running_hybrid_inc
(
    `vin`                                         string comment 'æ±½è½¦å”¯ä¸€ID',
    `velocity`                                    int comment 'è½¦é€Ÿ',
    `mileage`                                     int comment 'é‡Œç¨‹',
    `voltage`                                     int comment 'æ€»ç”µå‹',
    `electric_current`                            int comment 'æ€»ç”µæµ',
    `soc`                                         int comment 'SOC',
    `dc_status`                                   int comment 'DC-DCçŠ¶æ€',
    `gear`                                        int comment 'æŒ¡ä½',
    `insulation_resistance`                       int comment 'ç»ç¼˜ç”µé˜»',
    `motor_count`                                 int comment 'é©±åŠ¨ç”µæœºä¸ªæ•°',
    `motor_list`                                  array<struct<`id` :int, `status` :int, `rev` :int, `torque` :int,
                                                               `controller_temperature` :int, `temperature` :int,
                                                               `voltage`
                                                               :int, `electric_current` :int>> comment 'é©±åŠ¨ç”µæœºåˆ—è¡¨',
    `fuel_cell_dc_status`                         int comment 'é«˜å‹DC-DCçŠ¶æ€',
    `engine_status`                               int comment 'å‘åŠ¨æœºçŠ¶æ€',
    `crankshaft_speed`                            int comment 'æ›²è½´è½¬é€Ÿ',
    `fuel_consume_rate`                           int comment 'ç‡ƒæ–™æ¶ˆè€—ç‡',
    `max_voltage_battery_pack_id`                 int comment 'æœ€é«˜ç”µå‹ç”µæ± å­ç³»ç»Ÿå·',
    `max_voltage_battery_id`                      int comment 'æœ€é«˜ç”µå‹ç”µæ± å•ä½“ä»£å·',
    `max_voltage`                                 int comment 'ç”µæ± å•ä½“ç”µå‹æœ€é«˜å€¼',
    `min_temperature_subsystem_id`                int comment 'æœ€ä½ç”µå‹ç”µæ± å­ç³»ç»Ÿå·',
    `min_voltage_battery_id`                      int comment 'æœ€ä½ç”µå‹ç”µæ± å•ä½“ä»£å·',
    `min_voltage`                                 int comment 'ç”µæ± å•ä½“ç”µå‹æœ€ä½å€¼',
    `max_temperature_subsystem_id`                int comment 'æœ€é«˜æ¸©åº¦å­ç³»ç»Ÿå·',
    `max_temperature_probe_id`                    int comment 'æœ€é«˜æ¸©åº¦æ¢é’ˆå·',
    `max_temperature`                             int comment 'æœ€é«˜æ¸©åº¦å€¼',
    `min_voltage_battery_pack_id`                 int comment 'æœ€ä½æ¸©åº¦å­ç³»ç»Ÿå·',
    `min_temperature_probe_id`                    int comment 'æœ€ä½æ¸©åº¦æ¢é’ˆå·',
    `min_temperature`                             int comment 'æœ€ä½æ¸©åº¦å€¼',
    `battery_count`                               int comment 'å•ä½“ç”µæ± æ€»æ•°',
    `battery_pack_count`                          int comment 'å•ä½“ç”µæ± åŒ…æ€»æ•°',
    `battery_voltages`                            array<int> comment 'å•ä½“ç”µæ± ç”µå‹å€¼åˆ—è¡¨',
    `battery_temperature_probe_count`             int comment 'å•ä½“ç”µæ± æ¸©åº¦æ¢é’ˆæ€»æ•°',
    `battery_pack_temperature_count`              int comment 'å•ä½“ç”µæ± åŒ…æ€»æ•°',
    `battery_temperatures`                        array<int> comment 'å•ä½“ç”µæ± æ¸©åº¦å€¼åˆ—è¡¨',
    `timestamp`                                   bigint comment 'æ—¥å¿—é‡‡é›†æ—¶é—´'
)
comment 'æ··åŠ¨æ¨¡å¼è¡Œé©¶æ—¥å¿—äº‹å®è¡¨'
partitioned by (`dt` string comment 'ç»Ÿè®¡æ—¥æœŸ')
stored as orc
location '/warehouse/car_data/dwd/dwd_car_running_hybrid_inc'
tblproperties ('orc.compress' = 'snappy');

```

å‰©ä¸‹çš„æ•°æ®å¯¼å…¥ï¼ˆåŒ…æ‹¬é¦–æ—¥å’Œæ¯æ—¥ï¼‰å†…å®¹é€»è¾‘å’Œä¸Šé¢æ˜¯ä¸€æ ·çš„ï¼š

è¿™é‡Œåªå†™å‡ºé¦–æ¬¡åŠ è½½ï¼š

```
--æ•°æ®é¦–æ¬¡åŠ è½½
set hive.exec.dynamic.partition.mode=nonstrict;
insert overwrite table default.dwd_car_running_hybrid_inc partition(dt)
select
    `vin`,
    `velocity`,
    `mileage`,
    `voltage`,
    `electric_current`,
    `soc`,
    `dc_status`,
    `gear`,
    `insulation_resistance`,
    `motor_count`,
    `motor_list`,
    `fuel_cell_dc_status`,
    `engine_status`,
    `crankshaft_speed`,
    `fuel_consume_rate`  ,
    `max_voltage_battery_pack_id`,
    `max_voltage_battery_id`,
    `max_voltage`,
    `min_temperature_subsystem_id`,
    `min_voltage_battery_id`,
    `min_voltage`,
    `max_temperature_subsystem_id`,
    `max_temperature_probe_id`,
    `max_temperature`,
    `min_voltage_battery_pack_id`,
    `min_temperature_probe_id`,
    `min_temperature`,
    `battery_count`,
    `battery_pack_count`,
    `battery_voltages`,
    `battery_temperature_probe_count`,
    `battery_pack_temperature_count`,
    `battery_temperatures`,
    `timestamp`,
    `dt`
from default.ods_car_data_inc
where dt <= '2023-07-27'
and car_status=1
and execution_mode=2;
```

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230808202136973.png" alt="image-20230808202136973" style="zoom:33%;" />









#### 4.ç‡ƒæ–™æ¨¡å¼æ±½è½¦è¡Œé©¶æ—¥å¿—äº‹å®è¡¨

å»ºè¡¨ï¼š

```
--ç‡ƒæ–™æ¨¡å¼æ±½è½¦è¡Œé©¶æ—¥å¿—äº‹å®è¡¨
Drop table if exists dwd_car_running_fuel_inc;
create external table dwd_car_running_fuel_inc
(
    `vin`                                         string comment 'æ±½è½¦å”¯ä¸€ID',
    `velocity`                                    int comment 'è½¦é€Ÿ',
    `mileage`                                     int comment 'é‡Œç¨‹',
    `voltage`                                     int comment 'æ€»ç”µå‹',
    `electric_current`                            int comment 'æ€»ç”µæµ',
    `soc`                                         int comment 'SOC',
    `dc_status`                                   int comment 'DC-DCçŠ¶æ€',
    `gear`                                        int comment 'æŒ¡ä½',
    `insulation_resistance`                       int comment 'ç»ç¼˜ç”µé˜»',
    `fuel_cell_voltage`                           int comment 'ç‡ƒæ–™ç”µæ± ç”µå‹',
    `fuel_cell_current`                           int comment 'ç‡ƒæ–™ç”µæ± ç”µæµ',
    `fuel_cell_consume_rate`                      int comment 'ç‡ƒæ–™æ¶ˆè€—ç‡',
    `fuel_cell_temperature_probe_count`           int comment 'ç‡ƒæ–™ç”µæ± æ¸©åº¦æ¢é’ˆæ€»æ•°',
    `fuel_cell_temperature`                       int comment 'ç‡ƒæ–™ç”µæ± æ¸©åº¦å€¼',
    `fuel_cell_max_temperature`                   int comment 'æ°¢ç³»ç»Ÿä¸­æœ€é«˜æ¸©åº¦',
    `fuel_cell_max_temperature_probe_id`          int comment 'æ°¢ç³»ç»Ÿä¸­æœ€é«˜æ¸©åº¦æ¢é’ˆå·',
    `fuel_cell_max_hydrogen_consistency`          int comment 'æ°¢æ°”æœ€é«˜æµ“åº¦',
    `fuel_cell_max_hydrogen_consistency_probe_id` int comment 'æ°¢æ°”æœ€é«˜æµ“åº¦ä¼ æ„Ÿå™¨ä»£å·',
    `fuel_cell_max_hydrogen_pressure`             int comment 'æ°¢æ°”æœ€é«˜å‹åŠ›',
    `fuel_cell_max_hydrogen_pressure_probe_id`    int comment 'æ°¢æ°”æœ€é«˜å‹åŠ›ä¼ æ„Ÿå™¨ä»£å·',
    `fuel_cell_dc_status`                         int comment 'é«˜å‹DC-DCçŠ¶æ€',
    `engine_status`                               int comment 'å‘åŠ¨æœºçŠ¶æ€',
    `crankshaft_speed`                            int comment 'æ›²è½´è½¬é€Ÿ',
    `fuel_consume_rate`                           int comment 'ç‡ƒæ–™æ¶ˆè€—ç‡',
    `max_voltage_battery_pack_id`                 int comment 'æœ€é«˜ç”µå‹ç”µæ± å­ç³»ç»Ÿå·',
    `max_voltage_battery_id`                      int comment 'æœ€é«˜ç”µå‹ç”µæ± å•ä½“ä»£å·',
    `max_voltage`                                 int comment 'ç”µæ± å•ä½“ç”µå‹æœ€é«˜å€¼',
    `min_temperature_subsystem_id`                int comment 'æœ€ä½ç”µå‹ç”µæ± å­ç³»ç»Ÿå·',
    `min_voltage_battery_id`                      int comment 'æœ€ä½ç”µå‹ç”µæ± å•ä½“ä»£å·',
    `min_voltage`                                 int comment 'ç”µæ± å•ä½“ç”µå‹æœ€ä½å€¼',
    `max_temperature_subsystem_id`                int comment 'æœ€é«˜æ¸©åº¦å­ç³»ç»Ÿå·',
    `max_temperature_probe_id`                    int comment 'æœ€é«˜æ¸©åº¦æ¢é’ˆå·',
    `max_temperature`                             int comment 'æœ€é«˜æ¸©åº¦å€¼',
    `min_voltage_battery_pack_id`                 int comment 'æœ€ä½æ¸©åº¦å­ç³»ç»Ÿå·',
    `min_temperature_probe_id`                    int comment 'æœ€ä½æ¸©åº¦æ¢é’ˆå·',
    `min_temperature`                             int comment 'æœ€ä½æ¸©åº¦å€¼',
    `timestamp`                                   bigint comment 'æ—¥å¿—é‡‡é›†æ—¶é—´'
)
comment 'æ–°èƒ½æºç‡ƒæ–™æ¨¡å¼è¡Œé©¶æ—¥å¿—äº‹å®è¡¨'
partitioned by (`dt` string comment 'ç»Ÿè®¡æ—¥æœŸ')
stored as orc
location '/warehouse/car_data/dwd/dwd_car_running_fuel_inc'
tblproperties ('orc.compress' = 'snappy');
```

é¦–æ—¥/æ¯æ—¥åŠ è½½æ•°æ®â€”â€”é€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯ç”±äºäº‹åŠ¡ä¸ä¸€æ ·ï¼Œå±æ€§å’Œwhereåˆ é€‰ä¹Ÿå°±å¯èƒ½ä¸ä¸€æ ·ï¼š

```
--åŠ è½½æ•°æ®
insert overwrite table dwd_car_running_fuel_inc partition(dt)
select
    `vin`,
    `velocity`,
    `mileage`,
    `voltage`,
    `electric_current`,
    `soc`,
    `dc_status`,
    `gear`,
    `insulation_resistance`,
    `fuel_cell_voltage`,
    `fuel_cell_current`,
    `fuel_cell_consume_rate`,
    `fuel_cell_temperature_probe_count`,
    `fuel_cell_temperature`,
    `fuel_cell_max_temperature`,
    `fuel_cell_max_temperature_probe_id`,
    `fuel_cell_max_hydrogen_consistency`,
    `fuel_cell_max_hydrogen_consistency_probe_id`,
    `fuel_cell_max_hydrogen_pressure`,
    `fuel_cell_max_hydrogen_pressure_probe_id`,
    `fuel_cell_dc_status`,
    `engine_status`,
    `crankshaft_speed`,
    `fuel_consume_rate`,
    `max_voltage_battery_pack_id`,
    `max_voltage_battery_id`,
    `max_voltage`,
    `min_temperature_subsystem_id`,
    `min_voltage_battery_id`,
    `min_voltage`,
    `max_temperature_subsystem_id`,
    `max_temperature_probe_id`,
    `max_temperature`,
    `min_voltage_battery_pack_id`,
    `min_temperature_probe_id`,
    `min_temperature`,
    `timestamp`,
    dt
from ods_car_data_inc
where dt<='2023-07-27'
and car_status=1
and execution_mode=3;
```

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230808203430813.png" alt="image-20230808203430813" style="zoom:25%;" />







#### 5.å……ç”µæ¡©å……ç”µæ—¥å¿—äº‹å®è¡¨

å‰é¢éƒ½æ˜¯æ±½è½¦è¡Œé©¶è¿‡ç¨‹ä¸­çš„æ—¥å¿—äº‹å®è¡¨ï¼Œå…¶äº‹åŠ¡æ˜¯è¡Œé©¶ï¼Œè¿™é‡Œçš„äº‹åŠ¡æ˜¯â€”â€”å……ç”µ

è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œå……ç”µåˆ†ä¸º4ä¸ªçŠ¶æ€ï¼š

- å……ç”µä¸­
- è¡Œé©¶æ—¶å……ç”µï¼ˆè¿‡æ»¤æ‰ï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´ä¸å«ä½¿ç”¨å……ç”µæ¡©å……ç”µï¼‰
- æ²¡å……ç”µï¼ˆè¿‡æ»¤æ‰ï¼‰
- å……ç”µå®Œæˆ

æ³¨æ„ï¼šå¯¹äºå……ç”µæ—¶é—´çš„æ¦‚å¿µâ€”â€”å‡å¦‚æ±½è½¦ä»å¼€å§‹å……ç”µåˆ°ç”µæ»¡ç”¨äº†5ä¸ªå°æ—¶ï¼Œäº‹åæ²¡æœ‰é©¬ä¸Šæ‹”å‡ºå……ç”µå£ï¼Œ8ä¸ªå°æ—¶åæ‰æ‹”å‡ºã€‚é‚£ä¹ˆå……ç”µæ—¶é—´æˆ‘ä»¬è®¤ä¸ºæ˜¯5.



å»ºè¡¨ï¼š

```
--å……ç”µæ¡©å……ç”µæ—¥å¿—äº‹å®è¡¨
drop table if exists dwd_car_parking_charging_inc;
create external table dwd_car_parking_charging_inc
(
    `vin`                                         string comment 'æ±½è½¦å”¯ä¸€ID',
    `voltage`                                     int comment 'æ€»ç”µå‹',
    `electric_current`                            int comment 'æ€»ç”µæµ',
    `soc`                                         int comment 'SOC',
    `dc_status`                                   int comment 'DC-DCçŠ¶æ€',
    `gear`                                        int comment 'æŒ¡ä½',
    `insulation_resistance`                       int comment 'ç»ç¼˜ç”µé˜»',
    `engine_status`                               int comment 'å‘åŠ¨æœºçŠ¶æ€',
    `crankshaft_speed`                            int comment 'æ›²è½´è½¬é€Ÿ',
    `fuel_consume_rate`                           int comment 'ç‡ƒæ–™æ¶ˆè€—ç‡',
    `max_voltage_battery_pack_id`                 int comment 'æœ€é«˜ç”µå‹ç”µæ± å­ç³»ç»Ÿå·',
    `max_voltage_battery_id`                      int comment 'æœ€é«˜ç”µå‹ç”µæ± å•ä½“ä»£å·',
    `max_voltage`                                 int comment 'ç”µæ± å•ä½“ç”µå‹æœ€é«˜å€¼',
    `min_temperature_subsystem_id`                int comment 'æœ€ä½ç”µå‹ç”µæ± å­ç³»ç»Ÿå·',
    `min_voltage_battery_id`                      int comment 'æœ€ä½ç”µå‹ç”µæ± å•ä½“ä»£å·',
    `min_voltage`                                 int comment 'ç”µæ± å•ä½“ç”µå‹æœ€ä½å€¼',
    `max_temperature_subsystem_id`                int comment 'æœ€é«˜æ¸©åº¦å­ç³»ç»Ÿå·',
    `max_temperature_probe_id`                    int comment 'æœ€é«˜æ¸©åº¦æ¢é’ˆå·',
    `max_temperature`                             int comment 'æœ€é«˜æ¸©åº¦å€¼',
    `min_voltage_battery_pack_id`                 int comment 'æœ€ä½æ¸©åº¦å­ç³»ç»Ÿå·',
    `min_temperature_probe_id`                    int comment 'æœ€ä½æ¸©åº¦æ¢é’ˆå·',
    `min_temperature`                             int comment 'æœ€ä½æ¸©åº¦å€¼',
    `battery_count`                               int comment 'å•ä½“ç”µæ± æ€»æ•°',
    `battery_pack_count`                          int comment 'å•ä½“ç”µæ± åŒ…æ€»æ•°',
    `battery_voltages`                            array<int> comment 'å•ä½“ç”µæ± ç”µå‹å€¼åˆ—è¡¨',
    `battery_temperature_probe_count`             int comment 'å•ä½“ç”µæ± æ¸©åº¦æ¢é’ˆæ€»æ•°',
    `battery_pack_temperature_count`              int comment 'å•ä½“ç”µæ± åŒ…æ€»æ•°',
    `battery_temperatures`                        array<int> comment 'å•ä½“ç”µæ± æ¸©åº¦å€¼åˆ—è¡¨',
    `timestamp`                                   bigint comment 'æ—¥å¿—é‡‡é›†æ—¶é—´'
)
comment 'å……ç”µæ¡©å……ç”µæ—¥å¿—äº‹å®è¡¨'
partitioned by (`dt` string comment 'ç»Ÿè®¡æ—¥æœŸ')
stored as orc
location '/warehouse/car_data/dwd/dwd_car_parking_charging_inc'
tblproperties ('orc.compress' = 'snappy');
```

é¦–æ¬¡/æ¯æ—¥æ•°æ®å¯¼å…¥â€”â€”é€»è¾‘ä¸€æ ·ä¸å¤šè¿½è¿°ï¼š

```
--æ•°æ®å¯¼å…¥/åŠ è½½
insert overwrite table dwd_car_parking_charging_inc partition(dt)
select
    `vin`,
    `voltage`,
    `electric_current`,
    `soc`,
    `dc_status`,
    `gear`,
    `insulation_resistance`,
    `engine_status`,
    `crankshaft_speed`,
    `fuel_consume_rate`,
    `max_voltage_battery_pack_id`,
    `max_voltage_battery_id`,
    `max_voltage`,
    `min_temperature_subsystem_id`,
    `min_voltage_battery_id`,
    `min_voltage`,
    `max_temperature_subsystem_id`,
    `max_temperature_probe_id`,
    `max_temperature`,
    `min_voltage_battery_pack_id`,
    `min_temperature_probe_id`,
    `min_temperature`,
    `battery_count`,
    `battery_pack_count`,
    `battery_voltages`,
    `battery_temperature_probe_count`,
    `battery_pack_temperature_count`,
    `battery_temperatures`,
    `timestamp`,
    dt
from ods_car_data_inc
where dt<='2023-07-27'
and car_status=2
and charge_status=1;
```

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230808205508038.png" alt="image-20230808205508038" style="zoom:25%;" />







#### 6.è¡Œé©¶å……ç”µå’Œæ•…éšœè®°å½•æ—¥å¿—äº‹å®è¡¨

- è¡Œé©¶å……ç”µ

å»ºè¡¨ï¼š

```
--è¡Œé©¶å……ç”µæ—¥å¿—è¡¨
drop table if exists dwd_car_running_charging_inc;
create external table dwd_car_running_charging_inc
(
    `vin`                                         string comment 'æ±½è½¦å”¯ä¸€ID',
    `velocity`                                    int comment 'è½¦é€Ÿ',
    `mileage`                                     int comment 'é‡Œç¨‹',
    `voltage`                                     int comment 'æ€»ç”µå‹',
    `electric_current`                            int comment 'æ€»ç”µæµ',
    `soc`                                         int comment 'SOC',
    `dc_status`                                   int comment 'DC-DCçŠ¶æ€',
    `gear`                                        int comment 'æŒ¡ä½',
    `insulation_resistance`                       int comment 'ç»ç¼˜ç”µé˜»',
    `motor_count`                                 int comment 'é©±åŠ¨ç”µæœºä¸ªæ•°',
    `motor_list`                                  array<struct<`id` :int, `status` :int, `rev` :int, `torque` :int,
                                                               `controller_temperature` :int, `temperature` :int,
                                                               `voltage`
                                                               :int, `electric_current` :int>> comment 'é©±åŠ¨ç”µæœºåˆ—è¡¨',
    `fuel_cell_voltage`                           int comment 'ç‡ƒæ–™ç”µæ± ç”µå‹',
    `fuel_cell_current`                           int comment 'ç‡ƒæ–™ç”µæ± ç”µæµ',
    `fuel_cell_consume_rate`                      int comment 'ç‡ƒæ–™æ¶ˆè€—ç‡',
    `fuel_cell_temperature_probe_count`           int comment 'ç‡ƒæ–™ç”µæ± æ¸©åº¦æ¢é’ˆæ€»æ•°',
    `fuel_cell_temperature`                       int comment 'ç‡ƒæ–™ç”µæ± æ¸©åº¦å€¼',
    `fuel_cell_max_temperature`                   int comment 'æ°¢ç³»ç»Ÿä¸­æœ€é«˜æ¸©åº¦',
    `fuel_cell_max_temperature_probe_id`          int comment 'æ°¢ç³»ç»Ÿä¸­æœ€é«˜æ¸©åº¦æ¢é’ˆå·',
    `fuel_cell_max_hydrogen_consistency`          int comment 'æ°¢æ°”æœ€é«˜æµ“åº¦',
    `fuel_cell_max_hydrogen_consistency_probe_id` int comment 'æ°¢æ°”æœ€é«˜æµ“åº¦ä¼ æ„Ÿå™¨ä»£å·',
    `fuel_cell_max_hydrogen_pressure`             int comment 'æ°¢æ°”æœ€é«˜å‹åŠ›',
    `fuel_cell_max_hydrogen_pressure_probe_id`    int comment 'æ°¢æ°”æœ€é«˜å‹åŠ›ä¼ æ„Ÿå™¨ä»£å·',
    `fuel_cell_dc_status`                         int comment 'é«˜å‹DC-DCçŠ¶æ€',
    `engine_status`                               int comment 'å‘åŠ¨æœºçŠ¶æ€',
    `crankshaft_speed`                            int comment 'æ›²è½´è½¬é€Ÿ',
    `fuel_consume_rate`                           int comment 'ç‡ƒæ–™æ¶ˆè€—ç‡',
    `max_voltage_battery_pack_id`                 int comment 'æœ€é«˜ç”µå‹ç”µæ± å­ç³»ç»Ÿå·',
    `max_voltage_battery_id`                      int comment 'æœ€é«˜ç”µå‹ç”µæ± å•ä½“ä»£å·',
    `max_voltage`                                 int comment 'ç”µæ± å•ä½“ç”µå‹æœ€é«˜å€¼',
    `min_temperature_subsystem_id`                int comment 'æœ€ä½ç”µå‹ç”µæ± å­ç³»ç»Ÿå·',
    `min_voltage_battery_id`                      int comment 'æœ€ä½ç”µå‹ç”µæ± å•ä½“ä»£å·',
    `min_voltage`                                 int comment 'ç”µæ± å•ä½“ç”µå‹æœ€ä½å€¼',
    `max_temperature_subsystem_id`                int comment 'æœ€é«˜æ¸©åº¦å­ç³»ç»Ÿå·',
    `max_temperature_probe_id`                    int comment 'æœ€é«˜æ¸©åº¦æ¢é’ˆå·',
    `max_temperature`                             int comment 'æœ€é«˜æ¸©åº¦å€¼',
    `min_voltage_battery_pack_id`                 int comment 'æœ€ä½æ¸©åº¦å­ç³»ç»Ÿå·',
    `min_temperature_probe_id`                    int comment 'æœ€ä½æ¸©åº¦æ¢é’ˆå·',
    `min_temperature`                             int comment 'æœ€ä½æ¸©åº¦å€¼',
    `battery_count`                               int comment 'å•ä½“ç”µæ± æ€»æ•°',
    `battery_pack_count`                          int comment 'å•ä½“ç”µæ± åŒ…æ€»æ•°',
    `battery_voltages`                            array<int> comment 'å•ä½“ç”µæ± ç”µå‹å€¼åˆ—è¡¨',
    `battery_temperature_probe_count`             int comment 'å•ä½“ç”µæ± æ¸©åº¦æ¢é’ˆæ€»æ•°',
    `battery_pack_temperature_count`              int comment 'å•ä½“ç”µæ± åŒ…æ€»æ•°',
    `battery_temperatures`                        array<int> comment 'å•ä½“ç”µæ± æ¸©åº¦å€¼åˆ—è¡¨',
    `timestamp`                                   bigint comment 'æ—¥å¿—é‡‡é›†æ—¶é—´'
)
comment 'å……ç”µæ¡©å……ç”µæ—¥å¿—äº‹å®è¡¨'
partitioned by (`dt` string comment 'ç»Ÿè®¡æ—¥æœŸ')
stored as orc
location '/warehouse/car_data/dwd/dwd_car_running_charging_inc'
tblproperties ('orc.compress' = 'snappy');
```

é¦–æ¬¡åŠ è½½ï¼š

```
--åŠ è½½æ•°æ®
insert overwrite table dwd_car_running_charging_inc partition(dt)
select
    `vin`,
    `velocity`,
    `mileage`,
    `voltage`,
    `electric_current`,
    `soc`,
    `dc_status`,
    `gear`,
    `insulation_resistance`,
    `motor_count`,
    `motor_list`,
    `fuel_cell_voltage`,
    `fuel_cell_current`,
    `fuel_cell_consume_rate`,
    `fuel_cell_temperature_probe_count`,
    `fuel_cell_temperature`,
    `fuel_cell_max_temperature`,
    `fuel_cell_max_temperature_probe_id`,
    `fuel_cell_max_hydrogen_consistency`,
    `fuel_cell_max_hydrogen_consistency_probe_id`,
    `fuel_cell_max_hydrogen_pressure`,
    `fuel_cell_max_hydrogen_pressure_probe_id`,
    `fuel_cell_dc_status`,
    `engine_status`,
    `crankshaft_speed`,
    `fuel_consume_rate`,
    `max_voltage_battery_pack_id`,
    `max_voltage_battery_id`,
    `max_voltage`,
    `min_temperature_subsystem_id`,
    `min_voltage_battery_id`,
    `min_voltage`,
    `max_temperature_subsystem_id`,
    `max_temperature_probe_id`,
    `max_temperature`,
    `min_voltage_battery_pack_id`,
    `min_temperature_probe_id`,
    `min_temperature`,
    `battery_count`,
    `battery_pack_count`,
    `battery_voltages`,
    `battery_temperature_probe_count`,
    `battery_pack_temperature_count`,
    `battery_temperatures`,
    `timestamp`,
    dt
from ods_car_data_inc
where dt<='2023-07-27'
and car_status=1
and charge_status=2;
```

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230808210539282.png" alt="image-20230808210539282" style="zoom:33%;" />





- æ•…éšœå‘Šè­¦æ—¥å¿—äº‹å®è¡¨

å»ºè¡¨ä¸é¦–æ¬¡åŠ è½½ï¼šï¼ˆæ³¨æ„è¿‡æ»¤å‡ºæŠ¥è­¦ç­‰çº§å¤§äº0çš„ï¼‰

```
--æ•…éšœå‘Šè­¦æ—¥å¿—äº‹å®è¡¨
drop table if exists dwd_car_alarm_inc;
create external table dwd_car_alarm_inc
(
    `vin`                                         string comment 'æ±½è½¦å”¯ä¸€ID',
    `car_status`                                  int comment 'è½¦è¾†çŠ¶æ€',
    `charge_status`                               int comment 'å……ç”µçŠ¶æ€',
    `execution_mode`                              int comment 'è¿è¡Œæ¨¡å¼',
    `velocity`                                    int comment 'è½¦é€Ÿ',
    `mileage`                                     int comment 'é‡Œç¨‹',
    `voltage`                                     int comment 'æ€»ç”µå‹',
    `electric_current`                            int comment 'æ€»ç”µæµ',
    `soc`                                         int comment 'SOC',
    `dc_status`                                   int comment 'DC-DCçŠ¶æ€',
    `gear`                                        int comment 'æŒ¡ä½',
    `insulation_resistance`                       int comment 'ç»ç¼˜ç”µé˜»',
    `motor_count`                                 int comment 'é©±åŠ¨ç”µæœºä¸ªæ•°',
    `motor_list`                                  array<struct<`id` :int, `status` :int, `rev` :int, `torque` :int,
                                                               `controller_temperature` :int, `temperature` :int,
                                                               `voltage`
                                                               :int, `electric_current` :int>> comment 'é©±åŠ¨ç”µæœºåˆ—è¡¨',
    `fuel_cell_voltage`                           int comment 'ç‡ƒæ–™ç”µæ± ç”µå‹',
    `fuel_cell_current`                           int comment 'ç‡ƒæ–™ç”µæ± ç”µæµ',
    `fuel_cell_consume_rate`                      int comment 'ç‡ƒæ–™æ¶ˆè€—ç‡',
    `fuel_cell_temperature_probe_count`           int comment 'ç‡ƒæ–™ç”µæ± æ¸©åº¦æ¢é’ˆæ€»æ•°',
    `fuel_cell_temperature`                       int comment 'ç‡ƒæ–™ç”µæ± æ¸©åº¦å€¼',
    `fuel_cell_max_temperature`                   int comment 'æ°¢ç³»ç»Ÿä¸­æœ€é«˜æ¸©åº¦',
    `fuel_cell_max_temperature_probe_id`          int comment 'æ°¢ç³»ç»Ÿä¸­æœ€é«˜æ¸©åº¦æ¢é’ˆå·',
    `fuel_cell_max_hydrogen_consistency`          int comment 'æ°¢æ°”æœ€é«˜æµ“åº¦',
    `fuel_cell_max_hydrogen_consistency_probe_id` int comment 'æ°¢æ°”æœ€é«˜æµ“åº¦ä¼ æ„Ÿå™¨ä»£å·',
    `fuel_cell_max_hydrogen_pressure`             int comment 'æ°¢æ°”æœ€é«˜å‹åŠ›',
    `fuel_cell_max_hydrogen_pressure_probe_id`    int comment 'æ°¢æ°”æœ€é«˜å‹åŠ›ä¼ æ„Ÿå™¨ä»£å·',
    `fuel_cell_dc_status`                         int comment 'é«˜å‹DC-DCçŠ¶æ€',
    `engine_status`                               int comment 'å‘åŠ¨æœºçŠ¶æ€',
    `crankshaft_speed`                            int comment 'æ›²è½´è½¬é€Ÿ',
    `fuel_consume_rate`                           int comment 'ç‡ƒæ–™æ¶ˆè€—ç‡',
    `max_voltage_battery_pack_id`                 int comment 'æœ€é«˜ç”µå‹ç”µæ± å­ç³»ç»Ÿå·',
    `max_voltage_battery_id`                      int comment 'æœ€é«˜ç”µå‹ç”µæ± å•ä½“ä»£å·',
    `max_voltage`                                 int comment 'ç”µæ± å•ä½“ç”µå‹æœ€é«˜å€¼',
    `min_temperature_subsystem_id`                int comment 'æœ€ä½ç”µå‹ç”µæ± å­ç³»ç»Ÿå·',
    `min_voltage_battery_id`                      int comment 'æœ€ä½ç”µå‹ç”µæ± å•ä½“ä»£å·',
    `min_voltage`                                 int comment 'ç”µæ± å•ä½“ç”µå‹æœ€ä½å€¼',
    `max_temperature_subsystem_id`                int comment 'æœ€é«˜æ¸©åº¦å­ç³»ç»Ÿå·',
    `max_temperature_probe_id`                    int comment 'æœ€é«˜æ¸©åº¦æ¢é’ˆå·',
    `max_temperature`                             int comment 'æœ€é«˜æ¸©åº¦å€¼',
    `min_voltage_battery_pack_id`                 int comment 'æœ€ä½æ¸©åº¦å­ç³»ç»Ÿå·',
    `min_temperature_probe_id`                    int comment 'æœ€ä½æ¸©åº¦æ¢é’ˆå·',
    `min_temperature`                             int comment 'æœ€ä½æ¸©åº¦å€¼',
    `alarm_level`                                 int comment 'æŠ¥è­¦çº§åˆ«',
    `alarm_sign`                                  int comment 'é€šç”¨æŠ¥è­¦æ ‡å¿—',
    `custom_battery_alarm_count`                  int comment 'å¯å……ç”µå‚¨èƒ½è£…ç½®æ•…éšœæ€»æ•°N1',
    `custom_battery_alarm_list`                   array<int> comment 'å¯å……ç”µå‚¨èƒ½è£…ç½®æ•…éšœä»£ç åˆ—è¡¨',
    `custom_motor_alarm_count`                    int comment 'é©±åŠ¨ç”µæœºæ•…éšœæ€»æ•°N2',
    `custom_motor_alarm_list`                     array<int> comment 'é©±åŠ¨ç”µæœºæ•…éšœä»£ç åˆ—è¡¨',
    `custom_engine_alarm_count`                   int comment 'å‘åŠ¨æœºæ•…éšœæ€»æ•°N3',
    `custom_engine_alarm_list`                    array<int> comment 'å‘åŠ¨æœºæ•…éšœä»£ç åˆ—è¡¨',
    `other_alarm_count`                           int comment 'å…¶ä»–æ•…éšœæ€»æ•°N4',
    `other_alarm_list`                            array<int> comment 'å…¶ä»–æ•…éšœä»£ç åˆ—è¡¨',
    `battery_count`                               int comment 'å•ä½“ç”µæ± æ€»æ•°',
    `battery_pack_count`                          int comment 'å•ä½“ç”µæ± åŒ…æ€»æ•°',
    `battery_voltages`                            array<int> comment 'å•ä½“ç”µæ± ç”µå‹å€¼åˆ—è¡¨',
    `battery_temperature_probe_count`             int comment 'å•ä½“ç”µæ± æ¸©åº¦æ¢é’ˆæ€»æ•°',
    `battery_pack_temperature_count`              int comment 'å•ä½“ç”µæ± åŒ…æ€»æ•°',
    `battery_temperatures`                        array<int> comment 'å•ä½“ç”µæ± æ¸©åº¦å€¼åˆ—è¡¨',
    `timestamp`                                   bigint comment 'æ—¥å¿—é‡‡é›†æ—¶é—´'
)
comment 'æ•…éšœå……ç”µæ—¥å¿—äº‹å®è¡¨'
partitioned by (`dt` string comment 'ç»Ÿè®¡æ—¥æœŸ')
stored as orc
location '/warehouse/car_data/dwd/dwd_car_alarm_inc'
tblproperties ('orc.compress' = 'snappy');


--åŠ è½½æ•°æ®
insert overwrite table dwd_car_alarm_inc partition(dt)
select
    `vin`,
    `car_status`,
    `charge_status`,
    `execution_mode`,
    `velocity`,
    `mileage`,
    `voltage`,
    `electric_current`,
    `soc`,
    `dc_status`,
    `gear`,
    `insulation_resistance`,
    `motor_count`,
    `motor_list`,
    `fuel_cell_voltage`,
    `fuel_cell_current`,
    `fuel_cell_consume_rate`,
    `fuel_cell_temperature_probe_count`,
    `fuel_cell_temperature`,
    `fuel_cell_max_temperature`,
    `fuel_cell_max_temperature_probe_id`,
    `fuel_cell_max_hydrogen_consistency`,
    `fuel_cell_max_hydrogen_consistency_probe_id`,
    `fuel_cell_max_hydrogen_pressure`,
    `fuel_cell_max_hydrogen_pressure_probe_id`,
    `fuel_cell_dc_status`,
    `engine_status`,
    `crankshaft_speed`,
    `fuel_consume_rate`,
    `max_voltage_battery_pack_id`,
    `max_voltage_battery_id`,
    `max_voltage`,
    `min_temperature_subsystem_id`,
    `min_voltage_battery_id`,
    `min_voltage`,
    `max_temperature_subsystem_id`,
    `max_temperature_probe_id`,
    `max_temperature`,
    `min_voltage_battery_pack_id`,
    `min_temperature_probe_id`,
    `min_temperature`,
    `alarm_level`,
    `alarm_sign`,
    `custom_battery_alarm_count`,
    `custom_battery_alarm_list`,
    `custom_motor_alarm_count`,
    `custom_motor_alarm_list`,
    `custom_engine_alarm_count`,
    `custom_engine_alarm_list`,
    `other_alarm_count`,
    `other_alarm_list`,
    `battery_count`,
    `battery_pack_count`,
    `battery_voltages`,
    `battery_temperature_probe_count`,
    `battery_pack_temperature_count`,
    `battery_temperatures`,
    `timestamp`,
    dt
from ods_car_data_inc
where dt<='2023-07-27'
and alarm_level>0;
```



#### 7.ç”µæœºæ—¥å¿—äº‹å®è¡¨(â­)

ä¸å…¶ä»–äº‹å®è¡¨æœ‰äº›ä¸åŒï¼Œå®ƒçš„ç²’åº¦æ›´ç»†

å»ºè¡¨ï¼š

```
--ç‚¹å‡»æ—¥å¿—äº‹å®è¡¨
drop table if exists dwd_car_motor_inc;
create external table dwd_car_motor_inc
(
    `vin` string comment 'æ±½è½¦å”¯ä¸€ID',
    `id`  int comment 'ç”µæœºID',
    `status` int comment 'ç”µæœºçŠ¶æ€',
    `rev`  int comment 'ç”µæœºè½¬é€Ÿ',
    `torque`  int comment 'ç”µæœºè½¬çŸ©',
    `controller_temperature`  int comment 'ç”µæœºæ§åˆ¶å™¨æ¸©åº¦',
    `temperature`  int comment 'ç”µæœºæ¸©åº¦',
    `voltage` int comment 'ç”µæœºæ§åˆ¶å™¨è¾“å…¥ç”µå‹',
`electric_current` int comment 'ç”µæœºæ§åˆ¶å™¨ç›´æµæ¯çº¿ç”µæµ',
`timestamp`          bigint comment 'æ—¥å¿—é‡‡é›†æ—¶é—´'
)
comment 'é©±åŠ¨ç”µæœºæ—¥å¿—äº‹å®è¡¨'
partitioned by (`dt` string comment 'ç»Ÿè®¡æ—¥æœŸ')
stored as orc
location '/warehouse/car_data/dwd/dwd_car_motor_inc'
tblproperties ('orc.compress' = 'snappy');
```

åŠ è½½æ•°æ®ï¼ˆé¦–æ—¥ï¼‰ï¼š

```
set hive.exec.dynamic.partition.mode=nonstrict;
insert overwrite table dwd_car_motor_inc partition(dt)
select
    vin,
    motor.id ,
    motor.status,
    motor.rev,
    motor.torque,
    motor.controller_temperature,
    motor.temperature,
    motor.voltage,
    motor.electric_current,
`timestamp` ,
    dt
from ods_car_data_inc
lateral view explode(motor_list) tmp as motor
where dt<='2023-07-27';
```

**è¿™é‡Œæ³¨æ„ï¼Œè§£é‡Šä¸€ä¸‹ç‚¸è£‚å‡½æ•°ï¼š**

lateral view explode(motor_list) tmp as motor

ç‚¸è£‚çš„å¯¹è±¡æ˜¯motor_listè¿™ä¸ªå±æ€§ï¼Œæ‰“ä¸ªæ¯”æ–¹ï¼š

motor_listå±æ€§å€¼æ˜¯[{A},{B}]ï¼Œç‚¸è£‚åmotor_listä¸å˜**å‡ºç°motorå±æ€§**ï¼Œå±æ€§å€¼åˆ†ä¸¤è¡Œæ˜¯åˆ†åˆ«æ˜¯{A}å’Œ{B}ã€‚

**ä¹Ÿè®¸ç”»å›¾æ›´å¥½ç†è§£ï¼š**

è¿™æ˜¯ç‚¸è£‚å‰ï¼š

| list      |
| --------- |
| ({A},{B}) |
| ({C},{D}) |

è¿™æ˜¯ç‚¸è£‚åï¼š

| list      | motor |
| --------- | ----- |
| ({A},{B}) | {A}   |
| ({C},{D}) | {B}   |
|           | {C}   |
|           | {D}   |

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230808213432256.png" alt="image-20230808213432256" style="zoom:33%;" />









#### 8.æ¯æ¬¡/æ¯æ—¥è£…è½½è„šæœ¬

é¦–å…ˆæˆ‘ä»¬è®¾ç½®Hiveå¼€å¯éä¸¥æ ¼æ¨¡å¼ã€‚

```
[lchen@hadoop102 root]$ cd /opt/module/hive/conf/
```

åŠ ä¸€è¡Œï¼š

```
<!--Hiveè®¾ç½®ä¸ºéä¸¥æ ¼æ¨¡å¼-->
<property>
    <name>hive.exec.dynamic.partition.mode</name>
    <value>nonstrict</value>
</property>
```

ç„¶ååœ¨lchen/binä¸‹åˆ›å»ºè„šæœ¬æ–‡ä»¶ods_to_dwd_init.shï¼ˆé¦–æ¬¡ï¼‰å’Œods_to_dwd.shï¼ˆæ¯æ¬¡ï¼‰å³å¯ã€‚ï¼ˆå¤ªå¤šå°±ä¸åšæ¼”ç¤ºäº†ï¼‰

ä¸€æ ·çš„ç¼–å†™è„šæœ¬â€”â€”èµ‹èƒ½

**æ³¨æ„linuxä¸æ”¯æŒ''è¿™ä¸ªç¬¦å·ï¼Œå¦‚æœå‡ºç°å±æ€§å‡ºç°æ­§ä¹‰éœ€è¦ç”¨â€”â€”åœ¨ç”¨\ç¬¦å·+'**

ä½¿ç”¨æ–¹å¼ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼š

```
è„šæœ¬æ–‡ä»¶ + è¡¨å/allå…¨éƒ¨è¡¨  +  åˆ†åŒº/æ—¶é—´dt
```

ä¾‹å¦‚ï¼š

```
[lchen@hadoop102 bin]$ ./ods_to_dwd_init.sh all 2023-07-27
```

æŠ¥é”™/è¿›ç¨‹è¢«æ€æ­»ï¼š Failed to submit Spark work, please retry laterâ€”â€”åŸå› æ˜¯å†…å­˜ä¸å¤Ÿç”¨

åªæœ‰é‡æ–°è¯•ä¸€è¯•ï¼ˆæ²¡åŠæ³•æˆ‘ç”µè„‘å†…å­˜å°±é‚£ä¹ˆå¤šï¼Œä¸‹æ¬¡æ¢ç”µè„‘ç”¨32Gçš„=_=ï¼‰

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230809154457823.png" alt="image-20230809154457823" style="zoom:33%;" />





### ï¼ˆ6ï¼‰æ±‡æ€»æ•°æ®å±‚ï¼ˆDWSï¼‰çš„æ­å»ºï¼ˆâ­â­â­ï¼‰

ç”¨äºå­˜å‚¨åŸºç¡€èšåˆç²’åº¦ã€‚



#### 1.è¡Œç¨‹ä¸»é¢˜ï¼ˆâ­ï¼‰

**å¤§è‡´é€»è¾‘éƒ½å’Œâ€œçº¯ç”µåŠ¨æ±½è½¦å•æ¬¡å½¢æˆæ±‡æ€»è¡¨â€ä¸€æ ·ï¼Œé‡ç‚¹çœ‹å®ƒ**

1. çº¯ç”µåŠ¨æ±½è½¦å•æ¬¡å½¢æˆæ±‡æ€»è¡¨ï¼ˆé‡ç‚¹å†…å®¹ï¼‰

2. æ±½è½¦å•æ¬¡å……ç”µè®°å½•æ±‡æ€»è¡¨

3. æ±½è½¦å•æ—¥å‘Šè­¦è®°å½•æ±‡æ€»è¡¨

4. ç”µæœºä¿¡æ¯å•æ—¥æ±‡æ€»è¡¨

   ç­‰

**æœ‰äº†ä¹‹å‰çš„ç»éªŒè¿™é‡ŒHQLä»£ç ä¸å†å…¨éƒ¨å±•ç¤ºï¼Œå°±æ˜¯å»ºè¡¨+å¯¼å…¥æ•°æ®ã€‚æŒ‘é€‰å…¶ä¸­éœ€è¦æ³¨æ„çš„ã€‚**



- æ±½è½¦å•æ¬¡å½¢æˆæ±‡æ€»è¡¨ï¼ˆâ­ï¼‰


æ³¨æ„ç‚¹ï¼šæ±½è½¦æ¯30ç§’å½¢æˆä¸€æ¡æ•°æ®ï¼Œæ„æ€æ˜¯æ¯è¡Œå°±æ˜¯æ±½è½¦30ç§’å†…çš„è¡Œé©¶æ•°æ®ã€‚ä¸€æ—¦é—´éš”è¶…è¿‡30ç§’åˆ™è®¤ä¸ºæœ¬æ¬¡è¡Œç¨‹ç»“æŸ

æ•°æ®è£…è½½è¿‡æ»¤æ¡ä»¶ï¼š

```
if((lag(`timestamp`,1,0)over (partition by vin order by `timestamp` ) - `timestamp`) < -60000,1,0) mark
```

**å¦‚æœå½“å‰æ—¶é—´æˆ³å‡ä¸Šä¸€è¡Œçš„æ—¶é—´æˆ³å¤§äº60ç§’ï¼ˆå°±æ˜¯æ—¶é—´é—´éš”å¤§äº60ç§’ï¼‰åˆ™è®¤å®šæœ¬æ¬¡è¡Œç¨‹ç»“æŸ**

**ifï¼ˆA,B,Cï¼‰è¯­å¥ï¼šå¦‚æœAæ˜¯true markå€¼ä¸ºB ï¼Œå¦‚æœAä¸ºfalse markå€¼ä¸ºC**



##### è¯¥è¡¨çš„è£…è½½è¯­æ³•æœ‰å†™ä¸‹æ¥çš„å¿…è¦ï¼Œè¿™é‡Œçš„å±æ€§ä¸å…¨å†™å‡ºæ¥ï¼š

é¦–æ¬¡è£…è½½ï¼šï¼ˆæ¯æ—¥è£…è½½æŒ‡å®šåˆ†åŒºå³å¯ï¼Œå¯ä»¥çœ‹SQLæ–‡ä»¶ï¼‰

```
insert overwrite table dws_electricity_single_trip_detail partition (dt)
select
    concat(vin,'-',min(\`timestamp\`)) id,
    vin,
    min(`timestamp`) start_timestamp,
    max(`timestamp`)`end_timestamp`,
    min(mileage) `start_mileage`,
    max(mileage)`end_mileage`,
    max(soc) `start_soc`,
    min(soc) `end_soc`,
    avg(velocity) `avg_speed`,
    avg(voltage) `car_avg_voltage`,
    avg(electric_current) `car_avg_electric_current`,
    avg(max_temperature) `battery_avg_max_temperature`,
    collect_list(max_temperature)[cast(count(*)/2 as int)]  `battery_mid_max_temperature`,
    avg(min_temperature) `battery_avg_min_temperature`,
    collect_list(min_temperature)[cast(count(*)/2 as int)]` battery_mid_min_temperature`,
    avg(max_voltage) `battery_avg_max_voltage`,
    collect_list(max_voltage)[cast(count(*)/2 as int)]` battery_mid_max_voltage`,
    avg(min_voltage) `battery_avg_min_voltage`,
    collect_list(min_voltage)[cast(count(*)/2 as int)] `battery_mid_min_voltage`,
    dt
from (
     select
      ç›¸å…³å±æ€§
        sum(mark)over (partition by vin order by \`timestamp\`) singer_trip
    from (
         select
            ç›¸å…³å±æ€§
            if((lag(`timestamp`,1,0)over (partition by vin order by `timestamp` ) - `timestamp`) < -60000,1,0) mark
        from dwd_car_running_electricity_inc
        where dt<='2023-05-02'
    )t1
)t2
group by dt,vin,singer_trip;

```

è¿™é‡ŒåµŒå¥—äº†æ•´æ•´3å¼ è¡¨=_=ï¼Œ6.åº”è¯¥æ˜¯è¿™5å±‚ä¸­æœ€éš¾çš„éƒ¨åˆ†äº†ã€‚

1. t1è¡¨ï¼š

   æŒ‰æ±½è½¦idåˆ†ç»„ï¼ŒæŒ‰æ—¶é—´æˆ³æ’åºï¼Œå½“å‰æ—¶é—´-ä¸Šè¡Œæ•°æ®>60sçš„markå€¼ä¸º1ï¼Œå¦åˆ™ä¸º0ã€1æ„å‘³ç€è¿›ç¨‹çš„ç»“æŸã€‘

2. t2è¡¨ï¼šï¼ˆå¯ä»¥å®Œæ•´çš„åˆ†å‡ºæ¯æ¬¡è¡Œç¨‹äº†ï¼‰

â€‹	ç»§ç»­æŒ‰æ±½è½¦idåˆ†ç»„ï¼ŒæŒ‰æ—¶é—´æˆ³æ’åºï¼Œä¸è¿‡å¯¹markå±æ€§æ‰§è¡Œäº†èšåˆçª—å£æ“ä½œï¼ˆå³sun+overè¯­å¥ï¼‰ï¼Œmarkå€¼ç›¸ç­‰çš„è¡Œè¡¨ç¤ºåŒä¸€è¿›ç¨‹ã€‚

â€‹	3.æœ€åselectå‡ºæ¥çš„è¡¨ï¼š

å¯¹åŒä¸€è¿›ç¨‹çš„æ•°æ®ç»§ç»­è®¡ç®—ï¼Œä¾‹å¦‚è®¡ç®—è¯¥è¿›ç¨‹çš„é€Ÿåº¦ç­‰ç­‰ï¼ˆè¿™äº›å±æ€§æ ¹æ®å»ºè¡¨é€»è¾‘å¯ä»¥æŸ¥çœ‹ï¼‰ã€‚ç„¶ååŠ è½½è¿›å»

**æœ€åæ¯ç»„è¡Œç¨‹ä¸€è‡´çš„æ•°æ®éƒ½ä¼šèšåˆæˆä¸€è¡Œï¼Œæ˜¾ç¤ºçš„æ˜¯æ±½è½¦æ¯ä¸ªè¡Œç¨‹çš„æ•°æ®**



*æ³¨ï¼šè¿™é‡Œå–ä¸­ä½æ•°çš„é€»è¾‘æ³¨æ„ä¸€ä¸‹ï¼š

```
collect_list(max_temperature)[cast(count(*)/2 as int)] 
```

collect_listï¼šæŠŠæŸåˆ—å±æ€§å…¨æ”¶é›†èµ·æ¥

[cast(count(*)/2 as int)]â€”â€”å°±æ˜¯å–ä¸­é—´åºåˆ—çš„æ•°æ®ï¼Œè¿™é‡Œæ³¨æ„æ•°æ®ç±»å‹å¼ºåˆ¶è½¬æ¢ä¸ºint



##### æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230812210013806.png" alt="image-20230812210013806" style="zoom:33%;" />

é€»è¾‘ä¸è¶³ï¼šæ³¨æ„æˆ‘ä»¬æ˜¯æŒ‰æ—¥æœŸåˆ†åŒºæ“ä½œçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™ä¸ªæ­å»ºé€»è¾‘å°±æ²¡æœ‰è€ƒè™‘åˆ°å¼€å¤œç­è½¦çš„äººå‘ã€‚ç­‰äºä¸€ä¸ªäººå¼€å¤œè½¦ä»23ï¼š00å¼€åˆ°3ï¼š00ï¼Œæ•°æ®è¢«æ‹†åˆ†æˆäº†ä¸¤ä¸ªè¡Œç¨‹ï¼Œä½†äº‹å®ä¸Šæ˜¯ä¸€ä¸ªè¡Œç¨‹ï¼ˆå…³äºè¿™ä¸€ç‚¹åé¢æˆ‘ä»¬æœ‰è§£å†³é€»è¾‘ï¼‰



- çº¯ç”µåŠ¨æ±½è½¦å•æ¬¡å½¢æˆæ±‡æ€»è¡¨

åˆ¤æ–­å•è¯çš„é€»è¾‘ä¹Ÿæ˜¯ä¸Šä¸‹æ—¶é—´æˆ³ä¸è¶…è¿‡60sï¼Œé€»è¾‘å’Œä¸Šä¸€ä¸ªè¡¨ä¸€è‡´ã€‚

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230812214717556.png" alt="image-20230812214717556" style="zoom:25%;" />



##### åœ¨è™šæ‹Ÿæœºæ·»åŠ åŠ è½½è¿™ä¸¤å¼ è¡¨çš„è„šæœ¬ï¼ˆåŒ…æ‹¬é¦–æ¬¡/æ¯æ—¥åŠ è½½ï¼‰å³å•æ¬¡æ•°æ®çš„æ±‡æ€»ï¼Œæ–¹ä¾¿dwdâ€”â€”dwsçš„å†™å…¥ã€‚

dwd_to_dws_single_init.shå’Œdwd_to_dws_single.shã€‚è¯¦æƒ…å¯ä»¥åˆ°lchen/binç›®å½•ä¸‹æŸ¥çœ‹ã€‚

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230812220033722.png" alt="image-20230812220033722" style="zoom:25%;" />





- æ±½è½¦å•æ—¥è¡Œé©¶æƒ…å†µ

éœ€è¦æ³¨æ„çš„æ˜¯â€œæ€¥åŠ å‡é€Ÿâ€è¿™ä¸ªå±æ€§çš„è®¡ç®—ï¼š

ç›¸é‚»ä¸¤è¡Œé€Ÿåº¦ç›¸å·®å¤§äº500ï¼ˆå³50km/hï¼‰å°±ç®—æ€¥åŠ /å‡é€Ÿã€‚ï¼ˆé¢ï¼Œ30ç§’å†…ä¸Šä¸‹50km/hå¾ˆæ­£å¸¸å§ï¼Œè¿™é‡Œä¸€ä½æ˜¯30ç§’è®°å½•ä¸€æ¬¡æœ‰ç‚¹ä¸æ­£å¸¸=_=ï¼‰

æ³¨æ„ï¼šè¿è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¼šè¢«æ€æ­»è¿›ç¨‹ï¼ˆå—ç”µè„‘ç¡¬ä»¶èµ„æºå½±å“ï¼Œå†…å­˜å°äº†æ²¡åŠæ³•ï¼‰

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230813110612519.png" alt="image-20230813110612519" style="zoom:25%;" />



- å•æ—¥æŠ¥è­¦ç´¯è®¡è¡¨å’Œå•æ—¥ä¿¡æ¯è¡¨

è¿™æ²¡å•¥å¥½è¯´çš„ã€‚sumèšåˆå°±è¡Œäº†

ç»“æœï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230813111837044.png" alt="image-20230813111837044" style="zoom:25%;" />

ä¸€å¤©100å¤šæ¬¡è­¦æŠ¥ï¼Ÿè¿™æ•°æ®ç”Ÿæˆè„šæœ¬å±å®æ˜¯ä¸€æ´¾èƒ¡è¨€=_=

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230813113447786.png" alt="image-20230813113447786" style="zoom:33%;" />



- å•æ—¥ç”µæ± ç»„ä½¿ç”¨æƒ…å†µè¡¨ï¼ˆâ­ï¼‰

æ³¨æ„ï¼šç”µæ± çš„ä½¿ç”¨ä¼šè®¾è®¡ä¸¤ä¸ªä¸šåŠ¡â€”â€”å……ç”µå’Œç”¨ç”µï¼ˆä¹Ÿå°±æ˜¯æ±½è½¦çš„å……ç”µå’Œè¡Œé©¶ï¼‰ã€**æ‰€ä»¥è¦ç”¨ä¸¤å¼ è¡¨ï¼Œå……ç”µäº‹åŠ¡è¡¨å’Œè¡Œé©¶äº‹åŠ¡è¡¨ï¼Œå®é™…ä¸Šéœ€è¦ä¸‰å¼ **ã€‘

é¢„å¤‡å†·çŸ¥è¯†ï¼š

æ–°èƒ½æºæ±½è½¦çš„ç”µæ± æ­£å¸¸æ¸©åº¦æ˜¯0~45åº¦ã€‚

â€‹	1.æ³¨æ„ç‚¹1ï¼š

å­˜åœ¨é—®é¢˜ï¼šsocç”¨ç”µé‡çš„è®¡ç®—

åœ¨æ¯æ—¥ç”µæ± ä½¿ç”¨ä¸­å­˜åœ¨ï¼šæ”¾ç”µâ€”â€”å……ç”µâ€”â€”æ”¾ç”µè¿™æ ·çš„è¿‡ç¨‹ï¼Œå› æ­¤è¦è®¡ç®—ä½¿ç”¨çš„ç‚¹äº®éœ€è¦æŠŠå……ç”µé‡ä¹Ÿç®—è¿›å»æ‰è¡Œã€‚æ•…**åªç”¨è¡Œé©¶äº‹åŠ¡è¡¨maxç”µ-minç”µçš„è¿™ä¸ªé€»è¾‘è¡Œä¸é€šï¼Œå› ä¸ºä¸­é—´å¯èƒ½æœ‰å……ç”µè¡Œä¸ºã€‚**

å› æ­¤æˆ‘ä»¬**éœ€è¦é¢å¤–åˆ›å»ºä¸€å¼ è¡¨æ¥è®¡ç®—ç”µé‡æ¶ˆè€—**ï¼ˆ**dwsæˆ‘ä»¬ä¸æ˜¯æœ‰å•æ¬¡è¡Œç¨‹è¡¨å—ï¼Œåªè¦æŠŠæ¯æ¬¡è¡Œç¨‹çš„ç”¨ç”µé‡ç›¸åŠ å°±å¯ä»¥å¾—åˆ°æˆ‘ä»¬éœ€è¦çš„ç”¨ç”µæƒ…å†µ**ï¼‰



â€‹	2.æ³¨æ„ç‚¹2ï¼š

å­˜åœ¨é—®é¢˜ï¼šä¸å­˜åœ¨å……ç”µ/æ”¾ç”µ

å¦‚æœæˆ‘è¿™è¾†æ±½è½¦ä»Šå¤©å³å……ç”µåˆæ”¾ç”µäº†ï¼Œé‚£æˆ‘ä»¬ç›´æ¥join3å¼ è¡¨å°±è¡Œäº†ã€‚ä½†æ˜¯å¦‚æœå‡ºç°å•è¾¹æƒ…å†µï¼Œæ¯”å¦‚æˆ‘ä»Šå¤©æ²¡å‡ºé—¨ï¼Œæ‰€ä»¥æ²¡æ”¾ç”µå°±å‡ºäº‹äº†â€”â€”ä¼šé€ æˆjoinæ•°æ®ä¸¢å¤±ã€‚**äºæ˜¯æˆ‘ä»¬è¦ç”¨æ»¡å¤–è¿æ¥**



è®¾è¡¨Aï¼ŒBï¼ŒCåˆ†åˆ«æ˜¯å¤„ç†åçš„å•æ—¥å……ç”µè¡¨ï¼Œå•æ—¥æ”¾ç”µè¡¨ï¼ˆè®°å½•ç”µæ± æ¸©åº¦ç­‰ï¼‰ï¼Œä»¥åŠå•æ—¥æ¶ˆè€—ç”µé‡æ€»é‡è¡¨ã€‚

åˆ™ACå†…è¿æ¥ï¼ŒABå…¨å¤–è¿æ¥ã€‚

å¤§è‡´ä»£ç ï¼š

```
with t1 as (
    select
       å……ç”µå±æ€§
    from dwd_car_running_electricity_inc
    where dt<='2023-07-27'
    group by vin,dt
),t2 as (
    select
       æ”¾ç”µå±æ€§ï¼ˆæ¸©åº¦ç­‰ï¼‰
    from dwd_car_parking_charging_inc
    where dt<='2023-05-02'
    group by vin,dt
),t3 as (
    select
        æ€»çš„è€—ç”µæ•°
    from dws_electricity_single_trip_detail
    where dt<='2023-05-02'
    group by vin,dt
)
insert overwrite table dws_car_battery_1d partition(dt)
select
   å±æ€§
from t1
full outer join t2
on t1.vin=t2.vin and t1.dt=t2.vin
left join t3
on t1.vin=t3.vin and t1.dt=t3.dt;

```

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230813211156669.png" alt="image-20230813211156669" style="zoom:25%;" />



- è£…è½½æ¯æ—¥ä¿¡æ¯èšåˆè„šæœ¬

dwd_to_dws_1d_init.shå’Œdwd_to_dws_1d.sh

å†…å®¹ä¸€è‡´å°±ä¸é‡å¤äº†ã€‚

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230813212656219.png" alt="image-20230813212656219" style="zoom:25%;" />

å¯èƒ½ä¼šåœ¨åŠé€”è¢«namenodeæ€æ‰(è®¡ç®—æœºå†…å­˜ä¸å¤Ÿ)ğŸ˜‚



#### 2.è¿™é‡Œç”¨åˆ°äº†çª—å£å‡½æ•°â€”â€”hiveåˆ†æå‡½æ•°ï¼šï¼ˆâ­ï¼‰

- LAGï¼ˆcol,n,DEFAULTï¼‰

ç”¨äºç»Ÿè®¡çª—å£å†…å¾€ä¸Šç¬¬nè¡Œå€¼ï¼Œ**å‚æ•°1ï¼šåˆ—åï¼Œå‚æ•°2ï¼šå¾€ä¸Šç¬¬nè¡Œï¼ˆé»˜è®¤ä¸º1ï¼‰ï¼Œå‚æ•°3ï¼šnullé»˜è®¤å€¼**ï¼ˆè‹¥ä¸Šé¢ç¬¬nè¡Œæ²¡æœ‰åŒä¸€ç»„æ•°æ®ï¼Œåˆ™è®¾ç½®é»˜è®¤å€¼ï¼Œå¦åˆ™ä¸ºnullï¼‰

ä¾‹å¦‚ï¼š

- LEADï¼ˆcol,n,DEFAULTï¼‰


ç”¨äºç»Ÿè®¡çª—å£å†…å¾€ä¸‹ç¬¬nè¡Œå€¼ã€‚**å‚æ•°1ä¸ºåˆ—åï¼Œå‚æ•°2ä¸ºå¾€ä¸‹ç¬¬nè¡Œï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º1ï¼‰ï¼Œå‚æ•°3ä¸ºé»˜è®¤å€¼**ï¼ˆè‹¥ä¸Šé¢ç¬¬ä¸‹è¡Œæ²¡æœ‰åŒä¸€ç»„æ•°æ®ï¼Œåˆ™è®¾ç½®é»˜è®¤å€¼ï¼Œå¦åˆ™ä¸ºnullï¼‰

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230811210540230.png" alt="image-20230811210540230" style="zoom:25%;" />



##### **è¿™é‡Œå…ˆäº†è§£ä¸€ä¸‹çª—å£å‡½æ•°ï¼Œä»‹ç»ä¸€ä¸‹ï¼š**

1. é¦–å…ˆå¯¹çª—å£å‡½æ•°çš„ç†è§£ï¼š

èšåˆå‡½æ•°â€”â€”å¤šè¡Œèšåˆæˆä¸€è¡Œ

çª—å£å‡½æ•°â€”â€”**å®ƒæœ€æ˜¾è‘—çš„ç‰¹ç‚¹å°±æ˜¯ OVER å…³é”®å­—**ã€‚æ—¢æ˜¾ç¤ºèšé›†å‰çš„æ•°æ®,åˆè¦æ˜¾ç¤ºèšé›†åçš„æ•°æ®

- çª—å£å‡½æ•°çš„è¯­æ³•ï¼š

```
Function() Over (Partition By Column1ï¼ŒColumn2ï¼ŒOrder By Column3)
è¿™é‡Œçš„Function()å¯ä»¥æ˜¯ï¼š
1. èšåˆå‡½æ•°,æ¯”å¦‚ï¼šsum(...)ã€ max(...)ã€min(...)ã€avg(...)ç­‰.
2.æ•°æ®æ’åºå‡½æ•°, æ¯”å¦‚ ï¼šrank(...)ã€row_number(...)ç­‰.
3.ç»Ÿè®¡å’Œæ¯”è¾ƒå‡½æ•°, æ¯”å¦‚ï¼šlead(...)ã€lag(...)ã€ first_value(...)ç­‰.
```

PARTITION BY è¡¨ç¤ºå°†æ•°æ®å…ˆæŒ‰ å­—æ®µ è¿›è¡Œåˆ†åŒº

ORDER BY è¡¨ç¤ºå°†å„ä¸ªåˆ†åŒºå†…çš„æ•°æ®æŒ‰ æ’åºå­—æ®µ è¿›è¡Œæ’åº

**ä¾‹å­ï¼š**

![image-20230811210104305](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230811210104305.png)





##### åˆ°è¿™é‡Œä¹Ÿè®¸åˆ†æå‡½æ•°+overçª—å£å‡½æ•°è¿˜æ˜¯æœ‰ç‚¹ä¸äº†è§£

æˆ‘ä»¬ä¸¾ä¸ªæ —å­ï¼ˆä»¥æœ¬é¡¹ç›®æ±½è½¦å•æ¬¡å½¢æˆè¡¨ä¸ºä¾‹ï¼‰ï¼š

å‡è®¾åŸè¡¨ï¼š

| æ±½è½¦id | æ—¶é—´æˆ³ |
| ------ | ------ |
| A      | 100    |
| B      | 200    |
| A      | 130    |
| A      | 170    |
| B      | 230    |

```
select * if((lag(`timestamp`,1,0)over (partition by vin order by `timestamp` ) - `timestamp`) > 30,1,0) mark
```

markè¡Œå½¢æˆé€»è¾‘ï¼š

1.é¦–å…ˆåˆ†ç»„â€”â€”partition by æ±½è½¦idï¼Œç„¶åæ’åºâ€”â€” oderby æ—¶é—´æˆ³

| æ±½è½¦id | æ—¶é—´æˆ³ |
| ------ | ------ |
| A      | 100    |
| A      | 130    |
| A      | 170    |
| B      | 200    |
| B      | 230    |

2.ç„¶åæ‰§è¡Œlagåˆ†æå‡½æ•°é€»è¾‘

lagçš„å‚æ•°ï¼š

å‚æ•°1â€”â€”æ˜¾ç¤ºå½“å‰è¡Œä¸Šnè¡Œçš„å“ªä¸ªå±æ€§ï¼ˆæ—¶é—´æˆ³ï¼‰

å‚æ•°2â€”â€”å°±æ˜¯nçš„å€¼ï¼ˆ1ï¼‰

å‚æ•°3â€”â€”è‹¥ç¬¬nè¡Œè¶…è¿‡å½“å‰ç»„èŒƒå›´ï¼Œé»˜è®¤æ˜¯éƒ½æ˜¯ï¼ˆ0ï¼‰

**ä¸€å¥è¯ç¿»è¯‘å°±æ˜¯â€”â€”markæ˜¾ç¤ºå½“å‰ç»„å½“å‰è¡Œçš„å‰ä¸€è¡Œçš„æ—¶é—´æˆ³å±æ€§å€¼ï¼Œå¦‚æœæ²¡æœ‰å‰ä¸€è¡Œåˆ™é»˜è®¤å€¼ä¸º0**

| æ±½è½¦id | æ—¶é—´æˆ³ | mark |
| ------ | ------ | ---- |
| A      | 100    | 0    |
| A      | 130    | 100  |
| A      | 170    | 130  |
| B      | 200    | 0    |
| B      | 230    | 200  |

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230811212431374.png" alt="image-20230811212431374" style="zoom:33%;" />

**åŒç†ï¼Œlearå‡½æ•°é€»è¾‘ç›¸åï¼ŒæŒ‡å‘çš„æ˜¯ä¸‹è¡Œçš„å€¼**



3.ç„¶åæ‰§è¡Œå‡æ³•æ“ä½œï¼Œå½“å‰æ—¶é—´æˆ³-ä¸Šè¡Œçš„æ—¶é—´æˆ³

| æ±½è½¦id | æ—¶é—´æˆ³ | mark |
| ------ | ------ | ---- |
| A      | 100    | 100  |
| A      | 130    | 30   |
| A      | 170    | 40   |
| B      | 200    | 200  |
| B      | 230    | 30   |

4.æœ€åæ‰§è¡Œifè¯­å¥åˆ¤æ–­ï¼Œå¦‚æœå½“å‰æ—¶é—´æˆ³-ä¸Šè¡Œæ—¶é—´æˆ³>30åˆ™ä¸º1ï¼Œå¦åˆ™ä¸º0

| æ±½è½¦id | æ—¶é—´æˆ³ | mark |
| ------ | ------ | ---- |
| A      | 100    | 1    |
| A      | 130    | 0    |
| A      | 170    | 1    |
| B      | 200    | 1    |
| B      | 230    | 0    |

ç”±é€»è¾‘æ•°æ®æ—¶é—´ä¸Šä¼ è¶…è¿‡30ç§’åˆ™è§†ä¸ºæœ¬è¡Œç¨‹ç»“æŸï¼Œæ•…Aæœ‰2ä¸ªè¡Œç¨‹Bæœ‰1ä¸ªè¡Œç¨‹ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230811215025960.png" alt="image-20230811215025960" style="zoom:25%;" />

å¦‚ä½•è¡¨ç¤ºåŒä¸€çº¿ç¨‹ï¼Œå¯ä»¥ç”¨sumæŠŠè¿™å¼ è¡¨åˆ†ç»„æ±‚å’Œï¼ŒåŒä¸€æ•°å­—å°±æ˜¯åŒä¸€çº¿ç¨‹ã€‚

![image-20230811215132964](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230811215132964.png)







#### 3.å†…å¤–è¿æ¥å’Œå…¨å¤–è¿æ¥

å‚è€ƒåšå®¢ï¼šhttp://lxw1234.com/archives/2015/06/315.htm

å†…è¿æ¥ï¼Œå·¦å³è¿æ¥éƒ½å¥½ç†è§£ã€‚

åè€…å°±æ˜¯æ ¹æ®å·¦/å³è¡¨çš„ONå˜é‡æ¡ä»¶ï¼ŒåŒ¹é…å¹¶ç»“åˆï¼ŒåŒ¹é…ä¸ä¸Šçš„å±æ€§ç”¨nullè¡¨ç¤ºã€‚

è¿™é‡Œæˆ‘ä»¬ä¸»è¦è¯´å…¨å¤–è¿æ¥ï¼š

å…¨å¤–è¿æ¥è¿”å›æ‰€æœ‰è¡¨ä¸­æ»¡è¶³whereæ¡ä»¶çš„æ•°æ®ï¼Œä¸æ»¡è¶³æ¡ä»¶çš„æ•°æ®ä»¥NULLä»£æ›¿ï¼š

å¯ä»¥ç†è§£ä¸ºå·¦è¿æ¥+å³è¿æ¥



å†…å¤–è¿æ¥å»åŒºåˆ«ï¼š

**å†…è¿æ¥ ï¼šæŒ‡è¿æ¥ç»“æœä»…åŒ…å«ç¬¦åˆè¿æ¥æ¡ä»¶çš„è¡Œï¼Œå‚ä¸è¿æ¥çš„ä¸¤ä¸ªè¡¨éƒ½åº”è¯¥ç¬¦åˆè¿æ¥æ¡ä»¶ã€‚** **å¤–è¿æ¥ ï¼šè¿æ¥ç»“æœä¸ä»…åŒ…å«ç¬¦åˆè¿æ¥æ¡ä»¶çš„è¡ŒåŒæ—¶ä¹ŸåŒ…å«è‡ªèº«ä¸ç¬¦åˆæ¡ä»¶çš„è¡Œ**ã€‚

ä¾‹å¦‚ï¼š

| åå­—  | id   |
| ----- | ---- |
| clx   | 1    |
| barry | 2    |
| q     | 3    |

| id   | salary |
| ---- | ------ |
| 1    | 100    |
| 3    | 200    |
| 4    | 300    |

å†…è¿æ¥ on idç›¸åŒï¼š

| åå­— | id   | salary |
| ---- | ---- | ------ |
| clx  | 1    | 100    |
| q    | 3    | 200    |

**ä¸¤è¡¨éƒ½å¿…é¡»æ»¡è¶³idç›¸ç­‰ã€‚**

å·¦å¤–è¿æ¥ on idç›¸åŒ:

| åå­—  | id   | salary |
| ----- | ---- | ------ |
| clx   | 1    | 100    |
| barry | 2    | null   |
| q     | 3    | 200    |

å·¦è¡¨å®Œæ•´ä¿ç•™ï¼Œå³è¡¨ä¼šæ˜¾ç¤ºæ»¡è¶³idç›¸åŒçš„è®°å½•ï¼Œå¦åˆ™ä¸ºnull

åŒç†å³å¤–è¿æ¥ä¹Ÿæ˜¯è¿™æ ·





### ï¼ˆ7ï¼‰æ•°æ®åº”ç”¨å±‚ï¼ˆADSï¼‰çš„æ­å»º

å°±æ˜¯æœ€ç»ˆç»Ÿè®¡è§‚çœ‹çš„éœ€æ±‚ã€‚

æ²¡æœ‰ä½¿ç”¨å‹ç¼©å’Œå­˜å‚¨ï¼Œè¿™æ˜¯å› ä¸ºï¼š

1. ç»“æœæ•°æ®ç”±äºæ˜¯è®¡ç®—å®Œåçš„ç»“æœï¼Œæ‰€ä»¥ä¸ä¼šå¾ˆå¤§
2. adså±‚æ•°æ®éœ€è¦å¯¼å‡º



è¿™é‡Œæ³¨æ„å•Šï¼š

ä¸èƒ½ä¹‹é—´è¦†ç›–å•Šã€‚æ¯”å¦‚1æœˆçš„æ•°æ®ä½ å¡«è¡¨äº†ä»¥åï¼Œä½ åœ¨insert overwrite 2æœˆçš„æ•°æ®1æœˆçš„å°±æ²¡äº†ã€‚

æ‰€ä»¥æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š

1. 1æœˆçš„å†™å®Œé©¬ä¸Šæ”¾åˆ°mysqlé‡Œé¢æˆ–è€…é©¬ä¸Šä½¿ç”¨
2. overwriteçš„æ—¶å€™æŠŠ1æœˆçš„ä¸€èµ·å†™ä¸€éï¼ˆè¿™é‡Œç”¨çš„è¿™ä¸ªæ–¹æ¡ˆï¼‰



- æ¯æœˆæ—¥ç¨‹ç»Ÿè®¡è¡¨

æ²¡å•¥æ³¨æ„ç‚¹

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230814173559125.png" alt="image-20230814173559125" style="zoom:25%;" />

- æœ€è¿‘ä¸ƒå¤©ç»Ÿè®¡é‡Œç¨‹è®¡ç®—

æ³¨æ„ï¼šæ—¥æœŸçš„è¾“å…¥åªå…è®¸æœ‰ä¸€ä¸ªã€‚å› ä¸ºå¦‚æœæœ‰ä¸¤ä¸ªæ—¥æœŸå‚æ•°ï¼Œåœ¨å†™shellè„šæœ¬çš„æ—¶å€™å°±å¾ˆä¸æ–¹ä¾¿

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230814173656419.png" alt="image-20230814173656419" style="zoom:25%;" />

- ä¸åŒç±»å‹æ±½è½¦çš„æ¯æœˆè¡Œç¨‹ç»Ÿè®¡

ä¸ç»´åº¦è¡¨å…³è”ï¼Œé€šè¿‡å†…è¿æ¥åŒ¹é…æ±½è½¦ç±»å‹

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230816162813074.png" alt="image-20230816162813074" style="zoom:25%;" />

- æ¯æœˆè­¦å‘Šæ±‡æ€»è¡¨

  <img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230816163134555.png" alt="image-20230816163134555" style="zoom:25%;" />

- æ¸©æ§ä¸»é¢˜æ¯æœˆæ±‡æ€»

ç”µæœºæ¸©åº¦+ç”µæ± æ¸©åº¦

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230816171041761.png" alt="image-20230816171041761" style="zoom:25%;" />

- æ¯æœˆèƒ½è€—ä¸»é¢˜è¡¨ï¼ˆâ­â­éš¾ï¼‰

**å¾ˆéš¾ï¼Œè¡¨è¦åˆ†å¥½å‡ ä¸ªã€‚ä½†æ˜¯ä»é‡Œå¾€å¤–çœ‹èƒ½çœ‹æ‡‚**

å¿«å……â€”â€”å¹³å‡ç”µæµ180Aä»¥ä¸Š

æ…¢å……â€”â€”å¹³å‡ç”µæµ180Aä»¥ä¸‹

æ·±åº¦å……ç”µâ€”â€”ç”µé‡ä»å°äº20%~åˆ°80%ä»¥ä¸Š



1. å……ç”µæŒ‡æ ‡å±æ€§ï¼š


<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230816202400366.png" alt="image-20230816202400366" style="zoom:25%;" />

 ä¸¤ä¸ªå±æ€§éœ€è¦è®¡ç®—ï¼š

1. markè¡¨ç¤ºè¿™æ•°æ®å±äºç¬¬næ¬¡å……ç”µ
2. æ¯æ¬¡å……ç”µçš„å¹³å‡ç”µæµ



â€‹	2.è¡Œç¨‹æŒ‡æ ‡å±æ€§ï¼šï¼ˆå³è€—ç”µæŒ‡æ ‡å±æ€§ï¼‰

æ³¨æ„ç‚¹ï¼š

1.åœ¨dwså±‚ä¸­æˆ‘ä»¬å·²ç»å®ç°äº†ç”µåŠ¨æ¨¡å¼ä¸‹å•æ¬¡è¡Œç¨‹æ±‡æ€»è¡¨ä½†æ˜¯é—ç•™äº†ä¸€ä¸ªé—®é¢˜â€”â€”**è·¨å¤©é—®é¢˜**

é‡‡ç”¨å·¦å¤–è¿æ¥çš„è¿æ¥æ–¹å¼

2.è®¡ç®—æœ€è¿‘100kmçš„èƒ½è€—

**æ³¨æ„ï¼šæˆ‘ä»¬çš„æ•°æ®ç”Ÿæˆè„šæœ¬æœ‰ç‚¹é—®é¢˜ï¼šå®ƒæ¯æ¬¡é‡Œç¨‹çš„å¼€å§‹é‡Œç¨‹=ç»“æŸé‡Œç¨‹ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§é€»è¾‘å»ç®—**



æœ€åä¸¤è¡¨ç”¨joinåˆå¹¶ï¼š



#### å®Œæ•´ä»£ç ï¼š

```
with single_trip as (
    select
    vin,
    start_soc, --å¼€å§‹ç”µé‡
    end_soc,
    start_mileage, --å¼€å§‹æ—¶çš„é‡Œç¨‹æ•°
    end_mileage,
    start_timestamp, --å¼€å§‹æ—¶çš„æ—¶é—´æˆ³
    end_timestamp,  --ç»“æŸæ—¶çš„æ—¶é—´æˆ³
    dt
from dws_electricity_single_trip_detail   --å­˜ç”µåŠ¨æ¨¡å¼å•æ¬¡è¡Œç¨‹æ±‡æ€»è¡¨
where substr(dt, 0, 7) = '2023-07'
) ,a0 as (
    select--æ ¹æ®å¹³å‡ç”µæµå¾—åˆ°å……ç”µæ¨¡å‹ï¼Œå±•ç¤ºå®Œæ•´æ•°æ®(æ¯è¡Œä»£è¡¨æ¯æœˆçš„æ•°æ®)
    vin,
    '2023-07' mon,
    avg(soc)  soc_per_charge,    --æœ¬æœˆæ‰€æœ‰å……ç”µçš„ å¹³å‡å……ç”µé‡
    avg(duration)  duration_per_charge, --å¹³å‡å……ç”µæ—¶é•¿
    count(*)   charge_count ,--æœ¬æœˆå……ç”µæ¬¡æ•°
    sum(`if`(avg_electric>=180,1,0)) fast_charge_count,  --å¿«å……æ¬¡æ•°
    sum(`if`(avg_electric<180,1,0)) slow_charge_count, --æ…¢å……æ¬¡æ•°
    sum(full_charge) fully_charge_count
from(
select--è®¡ç®—å¹³å‡ç”µæµ(æ¯è¡Œå°±ä»£è¡¨æ¯æ¬¡çš„æ•°æ®)
    vin,
    '2023-07' mon,
    max(soc)-min(soc)  soc,  --æ¯æ¬¡å……ç”µé‡
    (max(`timestamp`)-min(`timestamp`))/1000  duration,  --æ¯æ¬¡å……ç”µæ—¶é•¿(å•ä½æ˜¯s)
    mark,   --ç¬¬næ¬¡å……ç”µæ¬¡æ•°
    avg(electric_current) avg_electric, --å¹³å‡ç”µæµï¼Œç”¨äºåˆ¤æ–­å……ç”µç±»å‹'
    `if`(min(soc)<=20 and max(soc)>=80,1,0)  full_charge --åˆ¤æ–­æœ¬æ¬¡sbs'æ·±åº¦å……ç”µ'

from (select--ç”±æ—¶é—´æˆ³ä¹‹å·®è®¡ç®—ç¬¬næ¬¡å……ç”µæ¬¡æ•°ï¼ˆmarkï¼‰
            vin,
            soc,                                                  --å‰©ä½™ç”µé‡
            electric_current,--ç”µæµ
            `timestamp`,
            sum(`if`(dif_time > 60000, 1, 0)) over (partition by vin order by `timestamp`) mark --åˆ¤æ–­ä¸Šä¸‹æ—¶é—´æˆ³ç›¸å·®æ˜¯å¦å¤§äº60sï¼Œæ˜¯:1ï¼Œå¦:0ã€‚å…¶ä¸­1è¡¨ç¤ºæ˜¯ä¸€æ¬¡æ–°çš„å……ç”µ,åˆ©ç”¨sumå‡½æ•°å¯è¡¨ç¤ºç¬¬å‡ æ¬¡å……ç”µ
      from (--åŸºæœ¬æ•°æ®ä¸å˜ï¼Œè®¡ç®—æ—¶é—´æˆ³ä¹‹å·®
               select vin,
                      soc,                                                                                       --å‰©ä½™ç”µé‡
                      electric_current,--ç”µæµ
                      `timestamp`,
                      `timestamp` - lag(`timestamp`, 1, 0) over (partition by vin order by `timestamp`) dif_time --æ—¶é—´æˆ³ä¹‹å·®
               from dwd_car_parking_charging_inc
               where substr(dt, 0, 7) = '2023-07'
               ) a1
      )a2
group by vin,mark
)a3
group by vin
)
insert overwrite table ads_consume_stat_last_month
select *
from ads_consume_stat_last_month
union
select
    a0.vin,
    '2023-07' mon,
    cast(nvl(soc_per_charge,0) as  decimal(16,2)),              --æœ¬æœˆæ‰€æœ‰å……ç”µçš„ å¹³å‡å……ç”µé‡
    cast(nvl(duration_per_charge,0)as  decimal(16,2)),                                          --æœ¬æœˆå¹³å‡å……ç”µæ—¶é•¿
    charge_count,
    fast_charge_count,
    slow_charge_count,
    fully_charge_count,
    cast(nvl(soc_per_100km,0)as  decimal(16,2)),
    cast(nvl(soc_per_run,0)as  decimal(16,2)),
    cast(nvl(soc_last_100km,0)as  decimal(16,2))
from (select vin,
             avg(start_soc - end_soc)                                           soc_per_run, --æ¯æ¬¡é‡Œç¨‹çš„å¹³å‡æ¶ˆè€—
             sum(start_soc - end_soc) / sum(end_mileage - start_mileage) * 1000 soc_per_100km, --æ€»èƒ½é‡/æ€»é‡Œç¨‹=æ¯0.1mçš„å¹³å‡è€—èƒ½ï¼Œx1000å°±æ˜¯æ¯100kmçš„å¹³å‡è€—èƒ½
    sum(`if`(dif_of_sum_mileage<1000 and sum_of_mileage>=1000,sum_of_mileage,0))/
    sum(`if`(dif_of_sum_mileage<1000 and sum_of_mileage>=1000,cost_sum_of_soc,0)) *1000  soc_last_100km--æœ€è¿‘100kmè€—èƒ½
      from (select vin,
                   start_soc,
                   end_soc,
                   start_mileage,
                   end_mileage,
                   sum_of_mileage,--æ€»é‡Œç¨‹(åŠ¨æ€)
                   cost_sum_of_soc, --æ€»è€—ç”µï¼ˆåŠ¨æ€ï¼‰
                   lag(sum_of_mileage, 1, 0) over (partition by vin order by end_timestamp desc ) dif_of_sum_mileage
            from (select vin,
                         start_soc,
                         end_soc,
                         start_timestamp,
                         end_timestamp,
                         start_mileage,
                         end_mileage,
                         sum(end_mileage - start_mileage)
                             over (partition by vin order by end_timestamp desc ) sum_of_mileage,--æ€»é‡Œç¨‹(åŠ¨æ€)
                         sum(start_soc - end_soc)
                             over (partition by vin order by end_timestamp desc ) cost_sum_of_soc --æ€»è€—ç”µï¼ˆåŠ¨æ€ï¼‰
                  from (select --åˆå¹¶å¤œç­è¡Œç¨‹æ•°æ®ï¼Œå¹¶æ ‡è¯†å†—ä½™æ•°æ®
                               t1.vin,
                               t1.start_soc    start_soc,                                                                              --å¼€å§‹ç”µé‡
                               nvl(t2.end_soc, t1.end_soc)                                                 end_soc,--å¦‚æœå­˜åœ¨t2.end_socè¯´æ˜æ˜¯å¤œè½¦ï¼Œç”¨t2çš„å‰©ä½™ç”µæµ
                               t1.start_mileage,                                                                          --å¼€å§‹æ—¶çš„é‡Œç¨‹æ•°
                               nvl(t2.end_mileage, t1.end_mileage)                                         end_mileage,
                               t1.start_timestamp,                                                                        --å¼€å§‹æ—¶çš„æ—¶é—´æˆ³
                               nvl(t2.end_timestamp, t1.end_timestamp)                                     end_timestamp, --ç»“æŸæ—¶çš„æ—¶é—´æˆ³
                               lag(t2.vin, 1, null) over (partition by t1.vin order by t1.start_timestamp) del_mark--åˆ é™¤æ ‡è®°ï¼Œåˆ é™¤ä»Šå¤©ç¬¬ä¸€æ¬¡æ•°æ®ï¼ˆå› ä¸ºå·²ç»å’Œæ˜¨å¤©çš„åˆå¹¶äº†ï¼‰
                        from single_trip t1
                                 left join single_trip t2 --ä¿ç•™ä¸€ç»„æ•°æ®ï¼Œåª
                                           on t1.vin = t2.vin and datediff(t2.dt, t1.dt) = 1 and
                                              t2.start_timestamp - t1.end_timestamp = 30000
--å…³è”æ¡ä»¶ï¼š1.æ˜¯åŒä¸€è¾†è½¦ 2.ä¸¤å¤©ç›¸å·®1å¤©  3.ä»Šå¤©å¼€å§‹æ—¶é—´æˆ³-æ˜¨å¤©ç»“æŸæ—¶é—´æˆ³å°äº30sâ€”â€”è¯´æ˜å±äºåŒä¸€æ¬¡è¡Œç¨‹ï¼ˆä¹Ÿå°±è¯´åªæœ‰å¤œè½¦è¡Œç¨‹æ‰ä¼šè¢«å…³è”ï¼‰
                       ) t3
                  where del_mark is null) t4) t5
      group by vin
)t6 join a0
on t6.vin=a0.vin;


select * from ads_consume_stat_last_month;
```

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230818204313893.png" alt="image-20230818204313893" style="zoom:33%;" />

- ä¸åŒæ±½è½¦ç±»å‹çš„å¹³å‡èƒ½è€—

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230818204249260.png" alt="image-20230818204249260" style="zoom:33%;" />



åŒæ ·çš„é…ç½®adså±‚è„šæœ¬å³å¯ã€‚





## å…­.æ•°æ®å¯¼å‡º

- æ¥åˆ°mysqlæ•°æ®åº“ï¼Œåˆ›å»ºæ•°æ®åº“

```
CREATE DATABASE IF NOT EXISTS car_data_report DEFAULT CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
```

- è¿›å…¥æ•°æ®åº“åˆ›å»ºè¡¨æ ¼

å…·ä½“å°±ä¸å†™äº†ï¼Œæ²¡è¦ç‚¹ã€‚

ä¸€å…±å››å¼ è¡¨

1. é‡Œç¨‹ç›¸å…³ç»Ÿè®¡
2. è­¦å‘Šç›¸å…³ç»Ÿè®¡
3. æ¸©æ§ç›¸å…³ç»Ÿè®¡
4. èƒ½è€—ç›¸å…³ç»Ÿè®¡



- æ•°æ®å¯¼å‡º

å·¥å…·é€‰ç”¨DataXï¼Œé€‰ç”¨HDFSReaderå’ŒMySQLWriterã€‚





#### DataXé…ç½®æ–‡ä»¶ç”Ÿæˆè„šæœ¬

å¼•è¨€ï¼š

å‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“äº†dataxçš„åŸºæœ¬ä½¿ç”¨æ‰‹æ³•ï¼Œä½†æ˜¯å¦‚æœæˆ‘è¦å¯¼å…¥å¤šå¼ è¡¨åˆ°hdfså°±éœ€è¦å¤šä¸ªjsoné…ç½®æ–‡ä»¶ï¼Œè¿™æ˜¯å¾ˆä¸æ–¹ä¾¿çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨è„šæœ¬çš„æ–¹å¼ï¼Œä¸€æ¬¡æ€§ç”Ÿæˆå¤šä¸ªjsoné…ç½®æ–‡ä»¶ã€‚

1.åˆ›å»º**/opt/module/datax_config_generator/configuration.propertiesæ–‡ä»¶**ï¼ˆåœ¨èµ„æ–™ä¸­å¤åˆ¶ï¼‰

ç„¶åä¿®æ”¹æˆï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230819110701094.png" alt="image-20230819110701094" style="zoom: 33%;" />

å¯åŠ¨è„šæœ¬ï¼š

```
[lchen@hadoop102 datax_config_generator]$ java -jar datax-config-generator-1.0-SNAPSHOT-jar-with-dependencies.jar 
```

å®Œæˆï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230819112346413.png" alt="image-20230819112346413" style="zoom:25%;" />



æˆ‘ä»¬å°è¯•ä¸€ä¸‹ç”Ÿæˆçš„é…ç½®æ–‡ä»¶å¥½ä¸å¥½ç”¨ï¼š

```
[lchen@hadoop102 datax]$ python bin/datax.py -p"-Dexportdir=//warehouse/car_data/ads/ads_consume_stat_last_month" job/export/car_data_report.ads_consume_stat_last_month.json

å‘½ä»¤æ ¼å¼:
python bin/datax.py -p"-D å‚æ•°= +hiveè¡¨æ ¼å†hdfsä¸­çš„è·¯å¾„" + dataxé…ç½®æ–‡ä»¶è·¯å¾„

```

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230819113429542.png" alt="image-20230819113429542" style="zoom:25%;" />

å¯ä»¥çœ‹åˆ°æ•°æ®æˆåŠŸå¯¼å…¥ åˆ°äº†mysqlï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230819113504278.png" alt="image-20230819113504278" style="zoom:25%;" />





#### ä½¿ç”¨è„šæœ¬å®Œæˆæ•°æ®çš„å¯¼å‡º

åœ¨home/lchen/binä¸‹åˆ›å»ºhdfs_to_mysql.sh 

```
[lchen@hadoop102 bin]$ sudo vim hdfs_to_mysql.sh 
[lchen@hadoop102 bin]$ sudo chmod 777 hdfs_to_mysql.sh 
[lchen@hadoop102 bin]$ ./hdfs_to_mysql.sh all

```

æˆåŠŸï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230819122044846.png" alt="image-20230819122044846" style="zoom:25%;" />

è¿™æ ·car_data_reportçš„æ•°æ®å°±å¡«å®Œäº†ã€‚

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230819122140342.png" alt="image-20230819122140342" style="zoom:25%;" />







## ä¸ƒ.dolphinSchedulerï¼ˆæµ·è±šè°ƒåº¦å™¨ï¼‰

åˆ†å¸ƒå¼ï¼Œæ˜“æ‰©å±•çš„å¯è§†åŒ–DAGå·¥ä½œæµä»»åŠ¡è°ƒåº¦å¹³å°ã€‚(æ‰€è°“DAGä»»åŠ¡æµè°ƒåº¦â€”â€”å°±æ˜¯æœ‰é¡ºåºä¸”æœ‰å‘æ— ç¯ï¼Œä¸èƒ½ä¸€ç›´é‡å¤)

**Gï¼Œå†…å­˜è¦æ±‚é«˜ã€‚å®å®ç”µè„‘æ‰›ä¸ä½äº†è¦=_=**



### 1.æ ¸å¿ƒæ¶æ„

- MasterServer

é‡‡ç”¨åˆ†å¸ƒå¼æ— ä¸­å¿ƒè®¾è®¡ç†å¿µï¼Œä¸»è¦è´Ÿè´£DAGä»»åŠ¡çš„åˆ’åˆ†ï¼Œæäº¤ï¼Œç›‘æ§ï¼Œå¹¶ç›‘å¬MasterServerå’ŒWorkerServerçš„å¥åº·çŠ¶æ€

- WorkerServer

ä¹Ÿé‡‡ç”¨åˆ†å¸ƒå¼æ— ä¸­å¿ƒè®¾è®¡ç†å¿µï¼Œä¸»è¦è´Ÿè´£ä»»åŠ¡çš„æ‰§è¡Œå’Œæä¾›æ—¥å¿—æœåŠ¡

- Zookeeper

MasterServerå’ŒWorkerServeré€šè¿‡å®ƒè¿›è¡Œé›†ç¾¤ç®¡ç†å’Œå®¹é”™

- Alert

æä¾›è­¦å‘Šç›¸å…³æœåŠ¡

- API

ä¸»è¦è´Ÿè´£å¤„ç†å‰ç«¯UIè¯·æ±‚

- UI

æä¾›å¯è§†åŒ–é¡µé¢



è¿è¡Œæ¨¡å¼ï¼š

- å•æœºæ¨¡å¼
- ä¼ªåˆ†å¸ƒå¼æ¨¡å¼â€”â€”è¯¥æ¨¡å¼ä¸‹masterã€workerã€api serverã€logger serverç­‰æœåŠ¡éƒ½åªåœ¨åŒä¸€å°æœºå™¨ä¸Š
- åˆ†å¸ƒå¼æ¨¡å¼â€”â€”ä¸ä¼ªé›†ç¾¤æ¨¡å¼çš„åŒºåˆ«å°±æ˜¯åœ¨å¤šå°æœºå™¨éƒ¨ç½² DolphinSchedulerå„é¡¹æœåŠ¡ï¼Œå¹¶ä¸”Masterã€Workerç­‰æœåŠ¡å¯é…ç½®å¤šä¸ªã€‚





é›†ç¾¤è§„åˆ’ï¼š

| hadoop102 | masterã€worker |
| --------- | -------------- |
| hadoop103 | worker         |
| hadoop104 | worker         |





### 2.å®‰è£…éƒ¨ç½²

1.å®‰è£…åˆ†æå·¥å…·ï¼ˆä¸‰å°éƒ½è¦ï¼‰

```
sudo yum install -y psmisc
```

2.ä¸Šä¼ å®‰è£…åŒ…è‡³/opt/softwareå¹¶è§£å‹åˆ°å½“å‰ç›®å½•ï¼Œæ­¤æ—¶å¹¶ä¸ç®—å®‰è£…å¥½ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå®‰è£…åŒ…

```
[lchen@hadoop102 software]$ tar -zxvf apache-dolphinscheduler-2.0.8-bin.tar.gz 
```

3.æ”¹å˜å®‰è£…åŒ…å‚æ•°ï¼Œé»˜è®¤æ˜¯å•æœºæ¨¡å¼æˆ‘ä»¬è¦æ”¹ä¸€ä¸‹å‚æ•°

cdåˆ°è¿™ä¸ªå®‰è£…åŒ…çš„conf/config

```
vim  install_config.conf 
```

å…·ä½“å†…å®¹å¯ä»¥çœ‹èµ„æ–™

4.å°†å¯¹åº”æ–‡ä»¶æ‹·è´åˆ°å¯¹åº”ç›®å½•

cd å®‰è£…åŒ…æ ¹ç›®å½•ï¼Œç„¶åæŠŠå¯¹åº”é…ç½®å¤åˆ¶è¿‡æ¥ï¼š

```
[lchen@hadoop102 apache-dolphinscheduler-2.0.8-bin]$ sudo cp /opt/module/hadoop/etc/hadoop/core-site.xml conf
[lchen@hadoop102 apache-dolphinscheduler-2.0.8-bin]$ sudo cp /opt/module/hadoop/etc/hadoop/hdfs-site.xml conf

```



5.

æµ·è±šè°ƒåº¦å™¨ä¼šæŠŠå…ƒæ•°æ®å­˜åˆ°mysqlé‡Œé¢ï¼Œæ•…è¦åˆ›å»ºæ•°æ®åº“ï¼ˆå®‰è£…ä¸Šé¢çš„å®‰è£…é…ç½®æ–‡ä»¶åˆ›å»ºï¼‰

```
mysql -uroot -p000000    è¿›å…¥mysql

CREATE DATABASE dolphinscheduler DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;   å»ºåº“

CREATE USER 'dolphinscheduler'@'%' IDENTIFIED BY 'dolphinscheduler'; åˆ›å»ºç”¨æˆ·ï¼Œå¹¶è®¾ç½®å¯†ç ç”¨æˆ·ä¸ºdolphinscheduler

GRANT ALL PRIVILEGES ON dolphinscheduler.* TO 'dolphinscheduler'@'%';ç»™ä¸è¯¥ç”¨æˆ·æ“ä½œæ•°æ®åº“çš„æƒé™

flush privileges; åˆ·æ–°
```



6.

åˆå§‹åŒ–æ•°æ®åº“

æŠŠmysqlè¿æ¥å™¨ç»™è°ƒåº¦å™¨ï¼š

```
[lchen@hadoop102 apache-dolphinscheduler-2.0.8-bin]$ sudo sudo cp /opt/software/mysql/mysql-connector-j-8.0.31.jar lib/
```

åˆå§‹åŒ–å‘½ä»¤ï¼š

```
script/create-dolphinscheduler.sh
```

å¦‚å›¾ï¼šæµ·è±šè°ƒåº¦å™¨çš„å…ƒæ•°æ®æ•°æ®åº“ä¹Ÿå»ºç«‹å®Œæˆäº†ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230823202405952.png" alt="image-20230823202405952" style="zoom:25%;" />

ç¡®ä¿zookeeperå¯åŠ¨ç€ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹å®‰è£…äº†ï¼š

```
[lchen@hadoop102 apache-dolphinscheduler-2.0.8-bin]$ ./install.sh 
```

**æ³¨æ„ä½ è¦ä½¿ä½ çš„hadoop102å¤„äºæ´»è·ƒçŠ¶æ€ã€‚**

å®‰è£…å®Œæˆï¼

UIåœ°å€ï¼š[http://hadoop104:12345/dolphinscheduler](http://hadoop102:12345/dolphinscheduler)

ç”¨æˆ·åï¼šadmin

å¯†ç ï¼šdolphinscheduler123

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230823204331239.png" alt="image-20230823204331239" style="zoom:33%;" />





### 3.ä½¿ç”¨/åœæ­¢å‘½ä»¤

```
[lchen@hadoop102 /]$ cd /opt/module/dolphinscheduler/
[lchen@hadoop102 dolphinscheduler]$ cd bin/
[lchen@hadoop102 bin]$ ./stop-all.sh 
å¯åŠ¨å°±start-all.shå°±è¡Œäº†
```

æ³¨æ„ï¼š

Masteræ— æ³•å¯åŠ¨ï¼ŒæŸ¥çœ‹æ—¥å¿—ä¿¡æ¯â€”â€”Cannot allocate memory

**å³å†…å­˜ä¸å¤Ÿäº†ï¼=_=æœç„¶ï¼ŒGã€‚**

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230823212543054.png" alt="image-20230823212543054" style="zoom:25%;" />

æˆ‘å·²ç»åˆ†é…å†…å­˜äº†ã€‚åªèƒ½ç¡¬ç€å¤´çš®å–å†™ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½ç»§ç»­å§





åˆ›å»ºç§Ÿæˆ·ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230824202934718.png" alt="image-20230824202934718" style="zoom:25%;" />

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230824203038186.png" alt="image-20230824203038186" style="zoom:25%;" />

åˆ›å»ºç”¨æˆ·ï¼š

ç”¨æˆ·åï¼šlchen

å¯†ç ï¼šlchen123

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230824203216034.png" alt="image-20230824203216034" style="zoom:25%;" />

é‚®ç®±å¡«è‡ªå·±çš„å³å¯



### 4.ç®¡ç†è°ƒåº¦ä»»åŠ¡

æ¨å‡ºç™»é™†ï¼Œç”¨lchenç™»é™†ã€‚ç‚¹å‡»é¡¹ç›®ç®¡ç†å¼€å§‹åˆ›å»ºé¡¹ç›®ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230824203903347.png" alt="image-20230824203903347" style="zoom:25%;" />

åˆ›å»ºå®Œåç‚¹å‡»è¿™ä¸ªé¡¹ç›®ï¼Œè¿›å…¥ç®¡ç†å¹³å°ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230824204010785.png" alt="image-20230824204010785" style="zoom:25%;" />

è¿™é‡Œçš„æ“ä½œæ¨¡å—å¯ä»¥ç±»æ¯”ä»£ç ï¼š

å·¥ä½œæµå®šä¹‰â€”â€”å£°æ˜ç±»

å·¥ä½œæµå®ä¾‹â€”â€”å£°æ˜å¯¹è±¡



#### ï¼ˆ1ï¼‰å…¥é—¨æ¡ˆä¾‹ï¼š

å·¥ä½œæµå®šä¹‰â€”â€”åˆ›å»ºå·¥ä½œæµã€‚é€šè¿‡æ‹–æ‹½ä½¿ç”¨åŠŸèƒ½

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230824204456334.png" alt="image-20230824204456334" style="zoom:25%;" />

node2/3åˆ†åˆ«æ˜¯helloå’Œbarryï¼Œæ¥ä¸‹æ¥é€šè¿‡è¿çº¿è®¾ç½®è¿è¡Œé¡ºåºï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230824204828787.png" alt="image-20230824204828787" style="zoom:25%;" />

ç‚¹å‡»ä¿å­˜ï¼Œè®¾ç½®åå­—ä¸ºtestï¼š

![image-20230824205010595](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230824205010595.png)

ç‚¹å‡»ä¸Šçº¿+è¿è¡Œï¼š

å•Š~æ²¡æœ‰masterè¿è¡Œä¸äº†ã€‚å°è¯•ç»™1å·è™šæ‹ŸæœºåŠ 1Gå†…å­˜ã€‚

æ€»ç®—è°ƒå‡ºæ¥äº†=_=ç”µè„‘è¦ç‚¸äº†æ„Ÿè§‰ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230824211831318.png" alt="image-20230824211831318" style="zoom:25%;" />

**æ³¨æ„ï¼šå³ä½¿å¦‚æ­¤Masterä¹Ÿå¯èƒ½æ‰çº¿ï¼Œé‡å¯å³å¯ã€‚**



ç‚¹å‡»â€œå·¥ä½œæµå®ä¾‹â€ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230824214600884.png" alt="image-20230824214600884" style="zoom: 25%;" />

å¦‚æœæ²¡æœ‰ï¼Œæ­å–œä½ å†…å­˜åˆä¸å¤Ÿäº†ã€‚

ç‚¹å‡»è¿›å»å‘ç°è¿è¡Œå¤±è´¥ï¼Œä¸æ­¤åŒæ—¶masteråˆæ‰äº†ã€‚æˆ‘ä»¬è¿›å…¥æ—¥å¿—æ–‡ä»¶ï¼š

```
[lchen@hadoop102 logs]$ tail -200 dolphinscheduler-master.log
```

æŸ¥çœ‹æŠ¥é”™ä¿¡æ¯ï¼š

 zookeeper connect timeout æˆ–è€…current cpu load average 0.75 is too high or available memory 0.07G is too lowã€‚

å†…å­˜è¿˜æ˜¯ä¸å¤Ÿã€‚**ç»å¸¸æŒ‚ï¼Œæ²¡åŠæ³•æˆ‘ä»¬æŠŠHadoopé›†ç¾¤å…³æ‰ç¼“è§£å‹åŠ›**



å…³é—­hadoopåå†…å­˜å¤Ÿç”¨äº†ï¼Œå†æ¬¡ç‚¹å‡»å·¥ä½œæµå®ä¾‹ï¼Œå‘ç°è¿è¡Œå®Œæˆï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825095812834.png" alt="image-20230825095812834" style="zoom:25%;" />

ç‚¹å‡»å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹â€”â€”æŸ¥çœ‹æ—¥å¿—ï¼Œå³å¯æŸ¥çœ‹åˆ°è¾“å‡ºæ•°æ®ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825095928677.png" alt="image-20230825095928677" style="zoom:25%;" />

åæ§½ï¼šå¥½å®¶ä¼™ä¸å¼€Hadoopä¹Ÿå ç”¨è¿™ä¹ˆå¤šå‘€

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825100025408.png" alt="image-20230825100025408" style="zoom:25%;" />





#### ï¼ˆ2ï¼‰å®šæ—¶å’Œä¼ å‚åŠŸèƒ½

- å®šæ—¶åŠŸèƒ½

è¦æ±‚æµç¨‹è°ƒåº¦ä¸€å¤©æ‰§è¡Œä¸€æ¬¡ï¼Œè¦æ±‚å®šæ—¶å¯åŠ¨ã€‚

1.å·¥ä½œæµå®šä¹‰â€”â€”ç‚¹å‡»å®šæ—¶

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825100646777.png" alt="image-20230825100646777" style="zoom:33%;" />

2.é»˜è®¤1å°æ—¶æ‰§1æ¬¡

è¿™é‡Œæˆ‘ä»¬è®¾ç½®1åˆ†é’Ÿ1æ¬¡

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825103651938.png" alt="image-20230825103651938" style="zoom:25%;" />

æŸ¥çœ‹æ—¶é—´å¯¹ä¸å¯¹ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825103715411.png" alt="image-20230825103715411" style="zoom:25%;" />

ç‚¹å‡»åˆ›å»ºå³å¯



3.ç‚¹å‡»å®šæ—¶ç®¡ç†

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825103959241.png" alt="image-20230825103959241" style="zoom:25%;" />

ç‚¹å‡»ä¸Šçº¿

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825104034441.png" alt="image-20230825104034441" style="zoom:25%;" />

1åˆ†é’Ÿåï¼šï¼ˆæ•°æ®æµå®ä¾‹ï¼‰

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825104128410.png" alt="image-20230825104128410" style="zoom:33%;" />

å†åˆ·æ–°ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825104218448.png" alt="image-20230825104218448" style="zoom:25%;" />



- ä¼ å‚åŠŸèƒ½

å…ˆè®©å·¥ä½œæµå®šä¹‰ä¸‹çº¿ï¼Œç„¶åä¿®æ”¹ç¼–è¾‘

ç¬¬ä¸€ç§ï¼šè®¾ç½®å±€éƒ¨å‚æ•°ï¼šï¼ˆåªä½œç”¨äºå¯¹åº”èŠ‚ç‚¹ï¼‰

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825105916828.png" alt="image-20230825105916828" style="zoom:25%;" />

ç¬¬äºŒç§ï¼šè®¾ç½®å…¨å±€å‚æ•°ï¼ˆä½œç”¨äºæ‰€æœ‰èŠ‚ç‚¹ï¼‰

ç‚¹å‡»ä¿å­˜æ—¶ä¼šè®©ä½ è®¾ç½®ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825110046766.png" alt="image-20230825110046766" style="zoom:25%;" />

**æ³¨æ„ï¼šè‹¥å…¨å±€å‚æ•°å’Œå±€éƒ¨å‚æ•°éƒ½è®¾ç½®äº†ï¼Œé‚£ä¹ˆé»˜è®¤é‡‡ç”¨å…¨å±€å‚æ•°**



ç¬¬ä¸‰ç§ï¼šä¼ é€’å‚æ•°

å°±æ˜¯ä¸Šæ¸¸èŠ‚ç‚¹ä¼ é€’ç»™ä¸‹æ¸¸

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825111635769.png" alt="image-20230825111635769" style="zoom:25%;" />

å†™æ³•ï¼š

```
"${setValue{key=value}}"
```

keyå’Œvalueè‡ªå·±ç¼–

æˆ–è€…ï¼š

æŠŠå‚æ•°ç±»å‹æ”¹æˆOUTï¼Œæ•ˆæœä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825111447367.png" alt="image-20230825111447367" style="zoom:25%;" />



- å†…ç½®å‚æ•°

| **å˜é‡å**             | **å‚æ•°**              | **è¯´æ˜**                        |
| ---------------------- | --------------------- | ------------------------------- |
| **system.biz.date**    | ${system.biz.date}    | å®šæ—¶æ—¶é—´å‰ä¸€å¤©ï¼Œæ ¼å¼ä¸º yyyyMMdd |
| **system.biz.curdate** | ${system.biz.curdate} | å®šæ—¶æ—¶é—´ï¼Œæ ¼å¼ä¸º yyyyMMdd       |
| **system.datetime**    | ${system.datetime}    | å®šæ—¶æ—¶é—´ï¼Œæ ¼å¼ä¸º yyyyMMddHHmmss |



- è‡ªå®šä¹‰æ—¥æœŸæ ¼å¼

å¯ä»¥å¯¹ $[yyyyMMddHHmmss] ä»»æ„åˆ†è§£ç»„åˆï¼Œå¦‚ $[yyyyMMdd], $[HHmmss], $[yyyy-MM-dd]ã€‚

ä¾‹å¦‚ï¼š

| **å‚æ•°**                           | **è¯´æ˜** |
| ---------------------------------- | -------- |
| **$[add_months(yyyyMMdd,12\*N)]**  | å N å¹´  |
| **$[add_months(yyyyMMdd,-12\*N)]** | å‰ N å¹´  |
| **$[add_months(yyyyMMdd,N)]**      | å N æœˆ  |
| **$[add_months(yyyyMMdd,-N)]**     | å‰ N æœˆ  |







#### ï¼ˆ3ï¼‰å¼•ç”¨ä¾èµ–èµ„æºå’Œå‘Šè­¦åŠŸèƒ½

ä¸ºäº†é˜²æ­¢å†…å­˜ä¸å¤Ÿç”¨ï¼Œæˆ‘ä»¬åªå¯åŠ¨HDFSï¼š

```
[lchen@hadoop102 root]$ start-dfs.sh
```



#### èµ„æºä¾èµ–

1.é¦–å…ˆç‚¹å‡»èµ„æºä¸­å¿ƒâ€”â€”åˆ›å»ºæ–‡ä»¶å¤¹â€œtest_shellâ€

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825202214611.png" alt="image-20230825202214611" style="zoom:25%;" />

åœ¨HDFSé‡Œçš„ä½ç½®ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825202200290.png" alt="image-20230825202200290" style="zoom:25%;" />

2.è¿›å…¥æ–‡ä»¶å¤¹é‡Œï¼Œç‚¹å‡»åˆ›å»ºæ–‡ä»¶

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825202403479.png" alt="image-20230825202403479" style="zoom:25%;" />



å¦‚ä½•åœ¨å·¥å…·æµä¸­ä½¿ç”¨ï¼Ÿ

ç‚¹å‡»èŠ‚ç‚¹è®¾ç½®èµ„æºï¼Œå†å†™ä¸Šç›¸å¯¹è·¯å¾„å³å¯

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825202542196.png" alt="image-20230825202542196" style="zoom:25%;" />





#### å‘Šè­¦é€šçŸ¥

å³èŠ‚ç‚¹è¿è¡Œå¤±è´¥ï¼Œéœ€è¦å®ƒå‘Šè¯‰æˆ‘ä»¬å“ªé‡Œæœ‰é—®é¢˜ã€‚

1.é¦–å…ˆæˆ‘ä»¬åˆ‡æ¢æˆadminç”¨æˆ·ï¼Œç„¶åè¿›å…¥å®‰å…¨ä¸­å¿ƒâ€”â€”å‘Šè­¦å®ä¾‹ç®¡ç†â€”â€”â€œåˆ›å»ºå‘Šè­¦å®ä¾‹â€

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825205237312.png" alt="image-20230825205237312" style="zoom:25%;" />

å¡«å†™é‚®ç®±ä¿¡æ¯ï¼Œå…¶ä¸­hostä¿¡æ¯éœ€è¦åœ¨é‚®ç®±ä¸­å¯»æ‰¾ï¼Œç‚¹å‡»æäº¤å³å¯ã€‚









### 5.æ•°ä»“è°ƒåº¦å…¨æµç¨‹

- ç”Ÿäº§æ•°æ®

å…³é—­æµ·è±šè°ƒåº¦å™¨ï¼Œå¯åŠ¨zookeeperå’ŒHDFSï¼š

```
[lchen@hadoop102 bin]$ start-dfs.sh
```

å¯åŠ¨Kafkaå’Œä¸¤ä¸ªflumeï¼š

```
[lchen@hadoop102 bin]$ ./kf.sh start
[lchen@hadoop102 bin]$ ./fl.sh start
[lchen@hadoop102 bin]$ ./f2.sh start
```

é€ æ–°çš„ä¸€å¤©æ•°æ®ï¼š

```
[lchen@hadoop102 bin]$ lg.sh 2023-07-28
```

æŸ¥çœ‹æ•°æ®â€”â€”ç›´åˆ°æ²¡æœ‰tmpæ–‡ä»¶å°±è¡¨æ˜ä¸Šä¼ å®Œæ¯•ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825210840373.png" alt="image-20230825210840373" style="zoom:25%;" />



æ¥ä¸‹æ¥å¯åŠ¨æµ·è±šè°ƒåº¦å™¨ï¼ˆä¸ºäº†é¿å…å†…å­˜ä¸è¶³æˆ‘ä»¬ä½¿ç”¨å•æœºæ¨¡å¼ï¼‰

```
[lchen@hadoop102 bin]$ cd /opt/module/dolphinscheduler/bin/ 
[lchen@hadoop102 bin]$ ./dolphinscheduler-daemon.sh start standalone-server
```

æ³¨æ„ï¼šæ­¤æ—¶å¯è§†åŒ–åœ°å€å˜æˆ102äº†ï¼šhttp://hadoop102:12345/dolphinscheduler/ui/view/login/index.html

æˆ‘ä»¬ç”¨lchenç™»é™†



- è„šæœ¬ä¸Šä¼ 

åœ¨å…ˆæŠŠè„šæœ¬æ”¾åˆ°æœ¬åœ°ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825212558077.png" alt="image-20230825212558077" style="zoom:25%;" />

ç„¶åä¸Šä¼ åˆ°æµ·è±šè°ƒåº¦å™¨ï¼š

èµ„æºä¸­å¿ƒâ€”â€”åˆ›å»ºæ–‡ä»¶å¤¹â€”â€”è¿›å…¥æ–‡ä»¶å¤¹â€”â€”ä¸Šä¼ æ–‡ä»¶

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825212946000.png" alt="image-20230825212946000" style="zoom:25%;" />



- ç¯å¢ƒå‡†å¤‡

é€€å‡ºï¼Œç”¨adminç”¨æˆ·ç™»é™†

å¤åˆ¶è™šæ‹Ÿæœºç¯å¢ƒå˜é‡ï¼š

```
[lchen@hadoop102 bin]$ sudo vim /etc/profile.d/my_env.sh 
```

å®‰å…¨ä¸­å¿ƒâ€”â€”ç¯å¢ƒç®¡ç†â€”â€”åˆ›å»ºç¯å¢ƒ

ç²˜è´´ç¯å¢ƒå˜é‡å¹¶åšå¦‚ä¸‹è®¾ç½®ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825214607039.png" alt="image-20230825214607039" style="zoom:25%;" />





å›åˆ°lchenç”¨æˆ·

åˆ›å»ºé¡¹ç›®â€”â€”carï¼š

é¡¹ç›®ç®¡ç†â€”â€”åˆ›å»ºé¡¹ç›®â€”â€”è¿›å…¥æŒ‡å®šé¡¹ç›®

- åˆ›å»ºå·¥ä½œæµ

è¿™é‡Œä»¥mysql_to_hdfs.shè„šæœ¬ä¸ºä¾‹ï¼ˆå³æŠŠç»´åº¦æ•°æ®ä»mysqlé€šè¿‡dataxå‘ç»™HDFSï¼‰

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825222522450.png" alt="image-20230825222522450" style="zoom:25%;" />

æŠŠè„šæœ¬å…¨å†™å‡ºæ¥ï¼Œå¦‚å›¾ï¼š

![image-20230825224921872](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825224921872.png)

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825220433947.png" alt="image-20230825220433947" style="zoom:50%;" />

**ä¿å­˜çš„æ—¶å€™è®°å¾—è®¾ç½®å‚æ•°dt=2023-07-28**ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825222559195.png" alt="image-20230825222559195" style="zoom:25%;" />

**ä¸Šçº¿å·¥ä½œæµ**



- å¯åŠ¨yarnï¼Œè¿è¡Œå·¥ä½œæµ

```
[lchen@hadoop102 bin]$ start-yarn.sh
```

ç„¶åå›åˆ°æµ·è±šè°ƒåº¦å™¨ã€‚å…ˆä¸Šçº¿+è¿è¡Œ1då·¥ä½œæµåæ˜¯1må·¥ä½œæµï¼Œ

è¿è¡Œå¾—å¾ˆæ…¢ï¼Œè¦ç­‰ä¸€ä¸‹~

å®Œæˆï¼š

![image-20230825224836409](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230825224836409.png)

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826103000490.png" alt="image-20230826103000490" style="zoom:33%;" />



ç„¶åæ•°æ®å°±è¦†ç›–å†™å…¥åˆ°äº†mysqlä¸­ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826103820314.png" alt="image-20230826103820314" style="zoom:25%;" />







## å…«.BIå¯è§†åŒ–å±•ç¤º

ä¸Šä¼ ï¼Œè§£å‹ï¼Œç„¶åç”¨å†…ç½®è„šæœ¬ä¸Šä¼ 

```
[lchen@hadoop102 software]$ bash ./linux_unix_FineBI6_0-CN.sh 
```

å¯è§†åŒ–åœ°å€ï¼šhttp://hadoop102:37799/webroot/decision 

**è®¾ç½®å¯†ç +è´¦æˆ·ï¼šå…¨è®¾ç½®ä¸ºadmin**

é€‰æ‹©ï¼šå¤–æ¥æ•°æ®åº“

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826111851428.png" alt="image-20230826111851428" style="zoom:25%;" />

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826112510991.png" alt="image-20230826112510991" style="zoom:25%;" />

å¯†ç æ˜¯000000



- åœ¨mysqlä¸­åˆ›å»ºå…ƒæ•°æ®åº“

```
CREATE DATABASE `finedb` DEFAULT CHARACTER SET utf8 COLLATE utf8_bin;
```

ç„¶åç‚¹å‡»â€œå¯ç”¨æ–°çš„æ•°æ®åº“â€ï¼Œç„¶åç™»é™†å³å¯ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826140753380.png" alt="image-20230826140753380" style="zoom:33%;" />





- å¯¼å…¥æ•°æ®

é¦–å…ˆè¿æ¥MySQL

ç®¡ç†ç³»ç»Ÿâ€”â€”æ•°æ®è¿æ¥â€”â€”æ•°æ®è¿æ¥ç®¡ç†â€”â€”æ–°å»ºæ•°æ®è¿æ¥â€”â€”é€‰æ‹©MySQL

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826141130953.png" alt="image-20230826141130953" style="zoom:25%;" />

ä½œå¦‚ä¸‹è®¾ç½®ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826141239195.png" alt="image-20230826141239195" style="zoom:25%;" />

è´¦å·å¯†ç éƒ½æ˜¯MySQLçš„ï¼Œå¯†ç æ˜¯000000ï¼Œç‚¹å‡»æµ‹è¯•è¿æ¥ï¼ˆå³ä¸Šï¼‰â€”â€”æˆåŠŸåä¿å­˜



å…¬å…±æ•°æ®ï¼ˆå·¦æ ï¼‰â€”â€”æ–°å»ºæ–‡ä»¶å¤¹car_dataâ€”â€”æ–°å»ºæ•°æ®é›†(é€‰æ‹©æ•°æ®åº“è¡¨)

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826143100671.png" alt="image-20230826143100671" style="zoom:25%;" />

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826141704848.png" alt="image-20230826141704848" style="zoom:25%;" />

é€‰æ‹©4ä¸ªæ•°æ®åº“è¡¨å³å¯ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826143153629.png" alt="image-20230826143153629" style="zoom:25%;" />







- åˆ†æä¸»é¢˜

ç‚¹å‡»â€”â€”æˆ‘çš„åˆ†æï¼ˆå·¦æ ï¼‰â€”â€”æ–°å»ºåˆ†æä¸»é¢˜

é€‰æ‹©å››å¼ è¡¨æ ¼ï¼š

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826143850484.png" alt="image-20230826143850484" style="zoom:25%;" />

å·¦ä¸‹è§’ç‚¹å‡»ç»„ä»¶





### 1.å„æ±½è½¦æŠ¥ä»·æƒ…å†µå•æœˆç»Ÿè®¡

ä½¿ç”¨å †ç§¯å‹æŸ±çŠ¶å›¾ï¼Œæ€»é•¿åº¦==ä¸€/äºŒ/ä¸‰çº§å‘Šè­¦æ¬¡æ•°ä¹‹å’Œ==å‘Šè­¦æ¬¡æ¬¡æ•°

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826144740933.png" alt="image-20230826144740933" style="zoom:50%;" />

**æ³¨æ„ç‚¹ï¼šæ¢è¡¨çš„æ—¶å€™ä¸è¦ä¿ç•™å­—æ®µé…ç½®**

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826144953677.png" alt="image-20230826144953677" style="zoom:25%;" />







### 2.å„æ±½è½¦å¹³å‡ç™¾å…¬é‡Œæ€¥åŠ å‡é€Ÿçš„æ¬¡æ•°ç»Ÿè®¡ï¼ˆæ¯æœˆï¼‰

åŠ ä¸€ä¸ªç»„ä»¶

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826145040893.png" alt="image-20230826145040893" style="zoom:50%;" />







### 3.æ±½è½¦æ¯æœˆç”µæ± æ¸©åº¦å¼‚å¸¸ç»Ÿè®¡

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826145521335.png" alt="image-20230826145521335" style="zoom:50%;" />







### 4.æ±½è½¦èƒ½è€—æŒ‡æ ‡

ç”±äºæ•°æ®ç”Ÿæˆè„šæœ¬æœ‰é—®é¢˜ï¼Œæ‰€ä»¥é‡Œç¨‹ä¸º0.æ•…è€—èƒ½ä¸º0

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826150022350.png" alt="image-20230826150022350" style="zoom:33%;" />







### 5.æ·»åŠ ä»ªè¡¨ç›˜

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230826150551656.png" alt="image-20230826150551656" style="zoom:25%;" />















